<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Phone Numbers - Admin Tools</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .fix-result {
            font-family: monospace;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
        }
        .status-fixed { color: #28a745; }
        .status-skipped { color: #6c757d; }
        .status-error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Navigation Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../admin-dashboard.html">Admin Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="./index.html">Admin Tools</a>
                </li>
                <li class="breadcrumb-item active">Fix Phone Numbers</li>
            </ol>
        </nav>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-phone me-2"></i>Phone Number Migration Tool</h4>
                        <p class="mb-0">Fix phone numbers that lost their + prefix due to faulty normalization</p>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>What this tool does:</h6>
                            <ul class="mb-0">
                                <li>Scans the database for phone numbers missing the <code>+</code> prefix</li>
                                <li>Fixes South African numbers (27xxxxxxxxx ‚Üí +27xxxxxxxxx)</li>
                                <li>Updates guests, receipts, rewards, and related collections</li>
                                <li>Preserves existing correct phone numbers</li>
                            </ul>
                        </div>

                        <div class="mb-3">
                            <button id="scanBtn" class="btn btn-primary me-2">
                                <i class="fas fa-search me-1"></i>Scan for Issues
                            </button>
                            <button id="fixBtn" class="btn btn-success me-2" disabled>
                                <i class="fas fa-wrench me-1"></i>Fix Phone Numbers
                            </button>
                            <button id="demoBtn" class="btn btn-outline-info">
                                <i class="fas fa-flask me-1"></i>Demo Normalization
                            </button>
                        </div>

                        <div id="status" class="mt-3"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-bar me-2"></i>Scan Results</h6>
                    </div>
                    <div class="card-body">
                        <div id="scanResults">
                            <p class="text-muted">Run a scan to see results</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Firebase configuration - matching platform config
        const firebaseConfig = {
            apiKey: "AIzaSyBf96GNLhtz6FDdbLxIW9efh98WG__eQmk",
            authDomain: "merakicaptiveportal-firebasedb.firebaseapp.com",
            databaseURL: "https://merakicaptiveportal-firebasedb-default-rtdb.firebaseio.com",
            projectId: "merakicaptiveportal-firebasedb",
            storageBucket: "merakicaptiveportal-firebasedb.appspot.com",
            messagingSenderId: "899985637961",
            appId: "1:899985637961:web:9c00572c7fec3a671e3598",
            measurementId: "G-476KXB93TV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let scanData = {};

        // New normalization function (fixed)
        function normalizePhoneNumber(phoneNumber) {
            if (!phoneNumber) return '';
            // Only remove WhatsApp prefix, preserve + for international numbers
            let cleaned = phoneNumber.replace(/^whatsapp:/, '').trim();
            
            // Ensure + prefix for international numbers (South African numbers)
            if (/^27\d{9}$/.test(cleaned)) {
                // If it's a 27xxxxxxxxx number without +, add it
                cleaned = '+' + cleaned;
            } else if (!cleaned.startsWith('+') && /^\d+$/.test(cleaned)) {
                // If it's all digits without +, assume it's South African
                cleaned = '+27' + cleaned.replace(/^0+/, ''); // Remove leading zeros
            }
            
            return cleaned;
        }

        // Old normalization function (broken)
        function oldNormalizePhoneNumber(phoneNumber) {
            if (!phoneNumber) return '';
            return phoneNumber.replace(/^(whatsapp:|\+)/, '');
        }

        document.getElementById('scanBtn').addEventListener('click', scanForIssues);
        document.getElementById('fixBtn').addEventListener('click', fixPhoneNumbers);
        document.getElementById('demoBtn').addEventListener('click', demoNormalization);

        async function scanForIssues() {
            const statusDiv = document.getElementById('status');
            const scanBtn = document.getElementById('scanBtn');
            const fixBtn = document.getElementById('fixBtn');
            
            scanBtn.disabled = true;
            statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Scanning database...</div>';

            try {
                scanData = {
                    guests: { total: 0, needsFix: 0, items: [] },
                    receipts: { total: 0, needsFix: 0, items: [] },
                    rewards: { total: 0, needsFix: 0, items: [] }
                };

                // Scan guests
                const guestsSnapshot = await database.ref('guests').once('value');
                const guests = guestsSnapshot.val() || {};
                scanData.guests.total = Object.keys(guests).length;
                
                for (const [phoneNumber, guestData] of Object.entries(guests)) {
                    const corrected = normalizePhoneNumber(phoneNumber);
                    if (phoneNumber !== corrected) {
                        scanData.guests.needsFix++;
                        scanData.guests.items.push({ 
                            key: phoneNumber, 
                            current: phoneNumber, 
                            corrected,
                            name: guestData.name 
                        });
                    }
                }

                // Scan receipts
                const receiptsSnapshot = await database.ref('receipts').once('value');
                const receipts = receiptsSnapshot.val() || {};
                scanData.receipts.total = Object.keys(receipts).length;
                
                for (const [receiptId, receiptData] of Object.entries(receipts)) {
                    if (receiptData.guestPhoneNumber) {
                        const corrected = normalizePhoneNumber(receiptData.guestPhoneNumber);
                        if (receiptData.guestPhoneNumber !== corrected) {
                            scanData.receipts.needsFix++;
                            scanData.receipts.items.push({ 
                                key: receiptId, 
                                current: receiptData.guestPhoneNumber, 
                                corrected,
                                invoice: receiptData.invoiceNumber 
                            });
                        }
                    }
                }

                // Scan rewards
                const rewardsSnapshot = await database.ref('rewards').once('value');
                const rewards = rewardsSnapshot.val() || {};
                scanData.rewards.total = Object.keys(rewards).length;
                
                for (const [rewardId, rewardData] of Object.entries(rewards)) {
                    if (rewardData.guestPhone) {
                        const corrected = normalizePhoneNumber(rewardData.guestPhone);
                        if (rewardData.guestPhone !== corrected) {
                            scanData.rewards.needsFix++;
                            scanData.rewards.items.push({ 
                                key: rewardId, 
                                current: rewardData.guestPhone, 
                                corrected,
                                type: rewardData.typeId 
                            });
                        }
                    }
                }

                displayScanResults();
                
                const totalIssues = scanData.guests.needsFix + scanData.receipts.needsFix + scanData.rewards.needsFix;
                
                if (totalIssues > 0) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Issues Found</h6>
                            <p>Found ${totalIssues} records with phone number issues. Click "Fix Phone Numbers" to correct them.</p>
                        </div>
                    `;
                    fixBtn.disabled = false;
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-2"></i>No Issues Found</h6>
                            <p>All phone numbers are properly formatted!</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Scan error:', error);
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle me-2"></i>Scan Failed</h6>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            } finally {
                scanBtn.disabled = false;
            }
        }

        function displayScanResults() {
            const resultsDiv = document.getElementById('scanResults');
            
            const html = `
                <div class="mb-2">
                    <strong>Guests:</strong> ${scanData.guests.needsFix}/${scanData.guests.total} need fixing
                </div>
                <div class="mb-2">
                    <strong>Receipts:</strong> ${scanData.receipts.needsFix}/${scanData.receipts.total} need fixing
                </div>
                <div class="mb-2">
                    <strong>Rewards:</strong> ${scanData.rewards.needsFix}/${scanData.rewards.total} need fixing
                </div>
                <hr>
                <div class="small text-muted">
                    Total: ${scanData.guests.needsFix + scanData.receipts.needsFix + scanData.rewards.needsFix} issues found
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        async function fixPhoneNumbers() {
            const statusDiv = document.getElementById('status');
            const fixBtn = document.getElementById('fixBtn');
            
            fixBtn.disabled = true;
            statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Fixing phone numbers...</div>';

            let results = [];

            try {
                // Fix guests
                for (const item of scanData.guests.items) {
                    try {
                        // Move guest data from old key to new key
                        const guestData = (await database.ref(`guests/${item.key}`).once('value')).val();
                        await database.ref(`guests/${item.corrected}`).set(guestData);
                        await database.ref(`guests/${item.key}`).remove();
                        
                        results.push(`<div class="fix-result status-fixed">‚úÖ Guest: ${item.current} ‚Üí ${item.corrected}</div>`);
                    } catch (error) {
                        results.push(`<div class="fix-result status-error">‚ùå Guest ${item.key}: ${error.message}</div>`);
                    }
                }

                // Fix receipts
                for (const item of scanData.receipts.items) {
                    try {
                        await database.ref(`receipts/${item.key}/guestPhoneNumber`).set(item.corrected);
                        results.push(`<div class="fix-result status-fixed">‚úÖ Receipt ${item.invoice}: ${item.current} ‚Üí ${item.corrected}</div>`);
                    } catch (error) {
                        results.push(`<div class="fix-result status-error">‚ùå Receipt ${item.key}: ${error.message}</div>`);
                    }
                }

                // Fix rewards
                for (const item of scanData.rewards.items) {
                    try {
                        await database.ref(`rewards/${item.key}/guestPhone`).set(item.corrected);
                        results.push(`<div class="fix-result status-fixed">‚úÖ Reward ${item.type}: ${item.current} ‚Üí ${item.corrected}</div>`);
                    } catch (error) {
                        results.push(`<div class="fix-result status-error">‚ùå Reward ${item.key}: ${error.message}</div>`);
                    }
                }

                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>Fix Complete</h6>
                        <p>Phone number fixes have been applied. See details below:</p>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">${results.join('')}</div>
                `;

                // Refresh scan data
                setTimeout(() => {
                    document.getElementById('scanBtn').click();
                }, 1000);

            } catch (error) {
                console.error('Fix error:', error);
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle me-2"></i>Fix Failed</h6>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            } finally {
                fixBtn.disabled = false;
            }
        }

        function demoNormalization() {
            const statusDiv = document.getElementById('status');
            
            const testNumbers = [
                '+27827001116',
                '27827001116', 
                '0827001116',
                'whatsapp:+27827001116',
                'whatsapp:27827001116'
            ];

            let demoResults = [];
            testNumbers.forEach(test => {
                const oldResult = oldNormalizePhoneNumber(test);
                const newResult = normalizePhoneNumber(test);
                const status = oldResult === newResult ? 'same' : 'different';
                
                demoResults.push(`
                    <div class="fix-result">
                        <strong>Input:</strong> ${test}<br>
                        <strong>Old Function:</strong> ${oldResult}<br>
                        <strong>New Function:</strong> <span class="status-fixed">${newResult}</span><br>
                        <strong>Status:</strong> ${status === 'different' ? '‚úÖ Fixed' : '‚û°Ô∏è Same'}
                    </div>
                `);
            });

            statusDiv.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-flask me-2"></i>Normalization Demo</h6>
                    <p>Comparison between old (broken) and new (fixed) phone number normalization:</p>
                </div>
                ${demoResults.join('')}
            `;
        }

        // Authentication check using platform's auth system (same as admin dashboard)
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                document.body.innerHTML = `
                    <div class="container mt-5">
                        <div class="alert alert-warning">
                            <h4>Authentication Required</h4>
                            <p>Please log in to access this tool.</p>
                            <a href="../admin-login.html" class="btn btn-primary">Login</a>
                        </div>
                    </div>
                `;
                return;
            }

            // Check admin status using the same method as admin dashboard
            try {
                console.log('üîç [FixPhoneNumbers] Checking admin status for user:', user.uid);
                
                // Method 1: Check custom claims (same as admin dashboard)
                const idTokenResult = await user.getIdTokenResult();
                const hasAdminClaim = idTokenResult.claims.admin === true;
                
                console.log('üîç [FixPhoneNumbers] Custom claims check:', {
                    hasAdminClaim,
                    claims: idTokenResult.claims
                });
                
                // Method 2: Verify through cloud function (same as admin dashboard)
                let cloudFunctionResult = null;
                try {
                    const idToken = await user.getIdToken();
                    const response = await fetch('https://us-central1-merakicaptiveportal-firebasedb.cloudfunctions.net/verifyAdminStatus', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            uid: user.uid
                        })
                    });
                    
                    cloudFunctionResult = await response.json();
                    console.log('üîç [FixPhoneNumbers] Cloud function result:', cloudFunctionResult);
                } catch (cloudError) {
                    console.warn('‚ö†Ô∏è [FixPhoneNumbers] Cloud function check failed:', cloudError);
                }
                
                // Method 3: Database check (fallback)
                const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
                const userData = userSnapshot.val();
                const databaseAdmin = userData && (userData.isAdmin === true || userData.role === 'admin');
                
                console.log('üîç [FixPhoneNumbers] Database check:', {
                    userExists: !!userData,
                    isAdmin: userData?.isAdmin,
                    role: userData?.role,
                    databaseAdmin
                });
                
                // Determine admin status (same logic as admin dashboard)
                const isAdmin = hasAdminClaim || 
                               (cloudFunctionResult && cloudFunctionResult.isAdmin) || 
                               databaseAdmin;
                
                console.log('üîç [FixPhoneNumbers] Final admin determination:', {
                    hasAdminClaim,
                    cloudFunctionAdmin: cloudFunctionResult?.isAdmin,
                    databaseAdmin,
                    finalResult: isAdmin
                });
                
                if (!isAdmin) {
                    document.body.innerHTML = `
                        <div class="container mt-5">
                            <div class="alert alert-danger">
                                <h4>Admin Access Required</h4>
                                <p>This tool requires admin privileges.</p>
                                <div class="mt-3">
                                    <h6>Debug Information:</h6>
                                    <ul>
                                        <li><strong>User ID:</strong> ${user.uid}</li>
                                        <li><strong>Email:</strong> ${user.email}</li>
                                        <li><strong>Custom Claims Admin:</strong> ${hasAdminClaim ? 'Yes' : 'No'}</li>
                                        <li><strong>Cloud Function Admin:</strong> ${cloudFunctionResult?.isAdmin ? 'Yes' : 'No'}</li>
                                        <li><strong>Database Admin:</strong> ${databaseAdmin ? 'Yes' : 'No'}</li>
                                        <li><strong>Final Result:</strong> ${isAdmin ? 'Admin' : 'Not Admin'}</li>
                                    </ul>
                                </div>
                                <a href="../admin-dashboard.html" class="btn btn-secondary">Back to Dashboard</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // User is authenticated and admin, show success message
                console.log('‚úÖ [FixPhoneNumbers] Admin user authenticated:', {
                    uid: user.uid,
                    email: user.email,
                    method: hasAdminClaim ? 'custom-claims' : 
                           cloudFunctionResult?.isAdmin ? 'cloud-function' : 'database'
                });
                
            } catch (error) {
                console.error('‚ùå [FixPhoneNumbers] Auth check error:', error);
                document.body.innerHTML = `
                    <div class="container mt-5">
                        <div class="alert alert-danger">
                            <h4>Authentication Error</h4>
                            <p>Error checking admin status: ${error.message}</p>
                            <a href="../admin-dashboard.html" class="btn btn-secondary">Back to Dashboard</a>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html> 