<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Subscription Status - Feature #29</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .test-result {
      border-left: 4px solid #28a745;
      padding: 10px;
      margin: 10px 0;
      background: #f8f9fa;
    }
    .test-result.error {
      border-color: #dc3545;
    }
    .test-result.warning {
      border-color: #ffc107;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <div class="row">
      <div class="col-12">
        <h1>Feature #29: Subscription Status Tracking Test</h1>
        <p class="text-muted">Testing automatic status checking and access control for expired subscriptions</p>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Authentication Status</h5>
          </div>
          <div class="card-body">
            <div id="auth-status"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">Current Subscription Status</h5>
          </div>
          <div class="card-body">
            <div id="subscription-status"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Test Actions</h5>
          </div>
          <div class="card-body">
            <button id="btn-check-trial" class="btn btn-primary me-2">Check Trial Status</button>
            <button id="btn-simulate-expiry" class="btn btn-danger me-2">Simulate Trial Expiry</button>
            <button id="btn-restore-trial" class="btn btn-success me-2">Restore Trial</button>
            <button id="btn-check-access" class="btn btn-info me-2">Check Feature Access</button>
            <button id="btn-trigger-status-check" class="btn btn-secondary">Trigger Status Check</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">Test Results</h5>
          </div>
          <div class="card-body">
            <div id="test-results"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js';
    import { getDatabase, ref, get, update } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-functions.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDUi4cOVIJGZrJ9NMPXzH_7_9VHV3xmqnI",
      authDomain: "merakicaptiveportal-firebasedb.firebaseapp.com",
      databaseURL: "https://merakicaptiveportal-firebasedb-default-rtdb.firebaseio.com",
      projectId: "merakicaptiveportal-firebasedb",
      storageBucket: "merakicaptiveportal-firebasedb.firebasestorage.app",
      messagingSenderId: "406882157463",
      appId: "1:406882157463:web:d1ec2c15dbda6c7596f59a"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const functions = getFunctions(app);

    let currentUser = null;

    // Helper function to add test result
    function addTestResult(message, type = 'success') {
      const resultsDiv = document.getElementById('test-results');
      const resultElement = document.createElement('div');
      resultElement.className = `test-result ${type}`;
      resultElement.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
      resultsDiv.insertBefore(resultElement, resultsDiv.firstChild);
    }

    // Update auth status display
    onAuthStateChanged(auth, async (user) => {
      const authStatus = document.getElementById('auth-status');

      if (user) {
        currentUser = user;
        authStatus.innerHTML = `
          <p><strong>Authenticated:</strong> ✅</p>
          <p><strong>Email:</strong> ${user.email}</p>
          <p><strong>UID:</strong> ${user.uid}</p>
        `;

        // Load subscription status
        await loadSubscriptionStatus();
      } else {
        authStatus.innerHTML = '<p class="text-danger">Not authenticated. Please login first.</p>';
      }
    });

    // Load subscription status
    async function loadSubscriptionStatus() {
      if (!currentUser) {
        addTestResult('No user authenticated', 'error');
        return;
      }

      try {
        const snapshot = await get(ref(database, `subscriptions/${currentUser.uid}`));
        const subscription = snapshot.val();

        const statusDiv = document.getElementById('subscription-status');

        if (!subscription) {
          statusDiv.innerHTML = '<p class="text-warning">No subscription found. Default to free tier.</p>';
          return;
        }

        const now = Date.now();
        const isExpired = subscription.trialEndDate && subscription.trialEndDate < now;

        statusDiv.innerHTML = `
          <p><strong>Tier:</strong> ${subscription.tierId || 'unknown'}</p>
          <p><strong>Status:</strong> <span class="badge bg-${subscription.status === 'expired' ? 'danger' : subscription.status === 'trial' ? 'warning' : 'success'}">${subscription.status || 'unknown'}</span></p>
          <p><strong>Payment Status:</strong> ${subscription.paymentStatus || 'unknown'}</p>
          <p><strong>Is Trial:</strong> ${subscription.isTrial ? 'Yes' : 'No'}</p>
          ${subscription.trialEndDate ? `<p><strong>Trial End Date:</strong> ${new Date(subscription.trialEndDate).toLocaleString()}</p>` : ''}
          ${subscription.trialEndDate ? `<p><strong>Trial Expired:</strong> ${isExpired ? 'YES ⚠️' : 'No'}</p>` : ''}
          <p><strong>Last Updated:</strong> ${subscription.lastUpdated ? new Date(subscription.lastUpdated).toLocaleString() : 'Never'}</p>
        `;

        addTestResult(`Loaded subscription: Tier=${subscription.tierId}, Status=${subscription.status}`, 'success');
      } catch (error) {
        addTestResult(`Error loading subscription: ${error.message}`, 'error');
      }
    }

    // Check trial status
    document.getElementById('btn-check-trial').addEventListener('click', async () => {
      if (!currentUser) {
        addTestResult('Not authenticated', 'error');
        return;
      }

      try {
        const snapshot = await get(ref(database, `subscriptions/${currentUser.uid}`));
        const subscription = snapshot.val();

        if (!subscription || !subscription.isTrial) {
          addTestResult('User is not in trial period', 'warning');
          return;
        }

        const now = Date.now();
        const daysLeft = Math.max(0, Math.ceil((subscription.trialEndDate - now) / (24 * 60 * 60 * 1000)));

        addTestResult(`Trial Status: ${daysLeft} days remaining until ${new Date(subscription.trialEndDate).toLocaleString()}`, 'success');
      } catch (error) {
        addTestResult(`Error checking trial: ${error.message}`, 'error');
      }
    });

    // Simulate trial expiry
    document.getElementById('btn-simulate-expiry').addEventListener('click', async () => {
      if (!currentUser) {
        addTestResult('Not authenticated', 'error');
        return;
      }

      try {
        const yesterday = Date.now() - (24 * 60 * 60 * 1000);

        await update(ref(database, `subscriptions/${currentUser.uid}`), {
          trialEndDate: yesterday,
          renewalDate: yesterday
        });

        addTestResult(`Set trialEndDate to yesterday (${new Date(yesterday).toLocaleString()})`, 'warning');
        await loadSubscriptionStatus();
      } catch (error) {
        addTestResult(`Error simulating expiry: ${error.message}`, 'error');
      }
    });

    // Restore trial
    document.getElementById('btn-restore-trial').addEventListener('click', async () => {
      if (!currentUser) {
        addTestResult('Not authenticated', 'error');
        return;
      }

      try {
        const futureDate = Date.now() + (14 * 24 * 60 * 60 * 1000);

        await update(ref(database, `subscriptions/${currentUser.uid}`), {
          trialEndDate: futureDate,
          renewalDate: futureDate,
          status: 'trial',
          paymentStatus: 'trial'
        });

        addTestResult(`Restored trial to 14 days from now (${new Date(futureDate).toLocaleString()})`, 'success');
        await loadSubscriptionStatus();
      } catch (error) {
        addTestResult(`Error restoring trial: ${error.message}`, 'error');
      }
    });

    // Check feature access
    document.getElementById('btn-check-access').addEventListener('click', async () => {
      if (!currentUser) {
        addTestResult('Not authenticated', 'error');
        return;
      }

      try {
        const snapshot = await get(ref(database, `subscriptions/${currentUser.uid}`));
        const subscription = snapshot.val();

        const features = ['analyticsAdvanced', 'receiptProcessingAutomated', 'campaignsAdvanced'];
        let resultHtml = '<strong>Feature Access Check:</strong><br>';

        for (const feature of features) {
          const hasFeature = subscription?.features?.[feature] === true;
          const shouldHaveAccess = subscription?.status === 'trial' || subscription?.status === 'active';
          const actualAccess = hasFeature && shouldHaveAccess;

          resultHtml += `- ${feature}: ${actualAccess ? '✅ Granted' : '❌ Denied'}<br>`;
        }

        addTestResult(resultHtml, subscription?.status === 'expired' ? 'warning' : 'success');
      } catch (error) {
        addTestResult(`Error checking access: ${error.message}`, 'error');
      }
    });

    // Trigger automatic status check
    document.getElementById('btn-trigger-status-check').addEventListener('click', async () => {
      if (!currentUser) {
        addTestResult('Not authenticated', 'error');
        return;
      }

      try {
        addTestResult('Triggering subscription status check...', 'warning');

        const triggerCheck = httpsCallable(functions, 'triggerSubscriptionStatusCheck');
        const result = await triggerCheck({ userId: currentUser.uid });

        if (result.data.success) {
          if (result.data.updated > 0) {
            addTestResult(`Status check complete: ${result.data.updated} subscription(s) updated`, 'success');
          } else {
            addTestResult('Status check complete: No updates needed', 'success');
          }
        } else {
          addTestResult(`Status check failed: ${result.data.error}`, 'error');
        }

        await loadSubscriptionStatus();
      } catch (error) {
        addTestResult(`Error triggering status check: ${error.message}`, 'error');
      }
    });
  </script>
</body>
</html>
