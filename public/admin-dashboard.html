<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Laki Sparks</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/admin-dashboard.css" rel="stylesheet">
    <link href="css/food-cost-dashboard.css" rel="stylesheet">
    <link href="css/table-fixes.css" rel="stylesheet">
    <link href="css/receipt-settings.css" rel="stylesheet">
    <link href="css/project-management.css" rel="stylesheet">

    <!-- Vue.js - Use production version -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Lodash -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Load Firebase SDK directly -->
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js" type="module"></script>

    <!-- Custom Scripts - Load in proper order -->
    <script type="module" src="js/config/firebase-config.js"></script>

    <!-- CRITICAL: Admin Authentication Guard - MUST load early -->
    <script type="module" src="js/auth/admin-page-guard.js"></script>

    <!-- Phone Number Protection Utilities -->
    <script src="js/utils/phone-number-protection.js"></script>
    <script src="js/utils/phone-number-monitoring.js"></script>
    <script src="js/utils/phone-number-alerts.js"></script>

    <!-- Debug script for Admin Activity Monitor -->
    <script>
        // Enhanced debug and force visibility of Admin Activity Monitor after page load
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(function () {
                console.log('ðŸ”§ [Debug] Enhanced Admin Activity Monitor visibility check...');

                // Check overall settings content first
                const settingsContent = document.getElementById('settingsContent');
                if (settingsContent) {
                    console.log('ðŸ”§ [Debug] Settings content:', {
                        display: window.getComputedStyle(settingsContent).display,
                        visibility: window.getComputedStyle(settingsContent).visibility,
                        opacity: window.getComputedStyle(settingsContent).opacity,
                        zIndex: window.getComputedStyle(settingsContent).zIndex,
                        innerHTML: settingsContent.innerHTML.length + ' characters'
                    });
                }

                // Search through all cards to find Admin Activity Monitor
                const allCards = document.querySelectorAll('#settingsContent .card');
                console.log('ðŸ”§ [Debug] Found cards in settings:', allCards.length);

                allCards.forEach((card, index) => {
                    const header = card.querySelector('.card-header');
                    if (header && header.textContent.includes('Admin Activity Monitor')) {
                        console.log('ðŸ”§ [Debug] Found Admin Activity Monitor card at index:', index);

                        // Debug card state
                        console.log('ðŸ”§ [Debug] Card computed styles:', {
                            display: window.getComputedStyle(card).display,
                            visibility: window.getComputedStyle(card).visibility,
                            opacity: window.getComputedStyle(card).opacity,
                            position: window.getComputedStyle(card).position,
                            zIndex: window.getComputedStyle(card).zIndex
                        });

                        const cardBody = card.querySelector('.card-body');
                        if (cardBody) {
                            // Debug card body state
                            console.log('ðŸ”§ [Debug] Card body computed styles:', {
                                display: window.getComputedStyle(cardBody).display,
                                visibility: window.getComputedStyle(cardBody).visibility,
                                opacity: window.getComputedStyle(cardBody).opacity,
                                height: window.getComputedStyle(cardBody).height,
                                minHeight: window.getComputedStyle(cardBody).minHeight
                            });

                            // Ultra-aggressive force visibility
                            card.style.cssText = `
                                display: block !important;
                                visibility: visible !important;
                                opacity: 1 !important;
                                position: relative !important;
                                z-index: 9999 !important;
                                width: 100% !important;
                                height: auto !important;
                                min-height: 400px !important;
                                margin-bottom: 20px !important;
                                background-color: #f8f9fa !important;
                                border: 2px solid #28a745 !important;
                            `;

                            cardBody.style.cssText = `
                                display: block !important;
                                visibility: visible !important;
                                opacity: 1 !important;
                                position: relative !important;
                                z-index: 10000 !important;
                                width: 100% !important;
                                height: auto !important;
                                min-height: 300px !important;
                                padding: 15px !important;
                                background-color: #ffffff !important;
                                border: 1px solid #007bff !important;
                            `;

                            // Force visibility of all child elements recursively
                            const allChildren = cardBody.querySelectorAll('*');
                            allChildren.forEach(element => {
                                if (window.getComputedStyle(element).display === 'none') {
                                    element.style.display = 'block';
                                }
                                element.style.visibility = 'visible';
                                element.style.opacity = '1';
                                element.classList.remove('d-none');
                            });

                            console.log('ðŸ”§ [Debug] ULTRA AGGRESSIVE visibility applied to Admin Activity Monitor');
                            console.log('ðŸ”§ [Debug] Card body HTML length:', cardBody.innerHTML.length);
                            console.log('ðŸ”§ [Debug] Child elements processed:', allChildren.length);
                        } else {
                            console.error('ðŸ”§ [Debug] Card body not found!');
                        }
                    }
                });

                // Final verification after changes
                setTimeout(() => {
                    // Find Admin Activity Monitor card using proper JavaScript
                    const cards = document.querySelectorAll('#settingsContent .card');
                    let verifyCard = null;
                    cards.forEach(card => {
                        const header = card.querySelector('.card-header');
                        if (header && header.textContent.includes('Admin Activity Monitor')) {
                            verifyCard = card;
                        }
                    });

                    if (verifyCard) {
                        const verifyBody = verifyCard.querySelector('.card-body');
                        console.log('ðŸ”§ [Debug] FINAL VERIFICATION:', {
                            cardVisible: window.getComputedStyle(verifyCard).display !== 'none',
                            bodyVisible: verifyBody ? window.getComputedStyle(verifyBody).display !== 'none' : false,
                            bodyContent: verifyBody ? verifyBody.innerHTML.length + ' chars' : 'no body'
                        });
                    } else {
                        console.log('ðŸ”§ [Debug] FINAL VERIFICATION: Admin Activity Monitor card not found');
                    }
                }, 500);
            }, 2000);
        });
    </script>

    <!-- Load admin-dashboard.js as module after firebase is loaded -->
    <script type="module" src="js/admin-dashboard.js"></script>

    <!-- Load admin activity monitor after Firebase and dashboard are ready -->
    <script type="module" src="js/utils/admin-activity-monitor.js"></script>

    <!-- Access Control Admin Modules -->
    <script type="module" src="js/modules/access-control/admin/tier-management.js"></script>
    <script type="module" src="js/modules/access-control/admin/enhanced-user-subscription-manager.js"></script>

    <style>
        /* CRITICAL: Hide page until authentication verified */
        body.auth-checking {
            display: none !important;
        }

        /* Vue.js related styles */
        [v-cloak] {
            display: none;
        }

        .drag-over {
            background-color: #f8f9fa;
            border: 2px dashed #007bff !important;
        }

        .upload-area {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* Critical fix for dropdown menus */
        body .dropdown-menu {
            position: fixed !important;
            z-index: 9999 !important;
        }

        /* Ensure dropdowns can't be hidden by cards */
        .card {
            z-index: 1 !important;
        }

        /* Filter Modal Popup */
        .filter-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-popup {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 350px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Modal Overlay for Vue components */
        .modal-overlay {
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Admin Tools Specific Styles */
        .tool-card {
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tool-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .search-box {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
    </style>
</head>

<body style="display: none;">
    <!-- Admin Page Guard script loaded in <head> will show body after auth verification -->

    <!-- Main container -->
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h3>Admin Dashboard</h3>
            </div>

            <ul class="nav flex-column">
                <li class="nav-item">
                    <a href="#" id="dashboardMenu" class="nav-link active" data-section="dashboardContent">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#engageSubmenu" class="nav-link" data-bs-toggle="collapse" role="button"
                        aria-expanded="false">
                        <i class="fas fa-bullhorn"></i>
                        Engage
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <div class="collapse" id="engageSubmenu">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a href="#" id="campaignsMenu" class="nav-link" data-section="campaignsContent">
                                    <i class="fas fa-bullhorn"></i>
                                    Campaigns
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" id="guestManagementMenu" class="nav-link"
                                    data-section="guestManagementContent">
                                    <i class="fas fa-users"></i>
                                    Guest Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" id="wifiLoginsMenu" class="nav-link" data-section="wifiLoginsContent">
                                    <i class="fas fa-wifi"></i>
                                    WiFi Logins
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" id="queueManagementMenu" class="nav-link"
                                    data-section="queueManagementContent">
                                    <i class="fas fa-clock"></i>
                                    Queue Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" id="receiptManagementMenu" class="nav-link"
                                    data-section="receiptManagementContent">
                                    <i class="fas fa-receipt"></i>
                                    Receipt Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" id="receiptSettingsMenu" class="nav-link"
                                    data-section="receiptSettingsContent">
                                    <i class="fas fa-cogs"></i>
                                    Receipt Settings
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" id="rewardManagementMenu" class="nav-link"
                                    data-section="rewardManagementContent">
                                    <i class="fas fa-gift"></i>
                                    Rewards Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" id="voucherManagementMenu" class="nav-link"
                                    data-section="voucherManagementContent">
                                    <i class="fas fa-ticket-alt"></i>
                                    Voucher Management
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#driversSubmenu" class="nav-link" data-bs-toggle="collapse" role="button"
                        aria-expanded="false">
                        <i class="fas fa-tachometer-alt"></i>
                        Drivers
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <div class="collapse" id="driversSubmenu">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a href="#" id="projectManagementMenu" class="nav-link"
                                    data-section="projectManagementContent">
                                    <i class="fas fa-tasks"></i>
                                    Project Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" id="foodCostMenu" class="nav-link" data-section="foodCostContent">
                                    <i class="fas fa-utensils"></i>
                                    Food Cost
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#settingsSubmenu" class="nav-link" data-bs-toggle="collapse" role="button"
                        aria-expanded="false">
                        <i class="fas fa-cog"></i>
                        Settings
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <div class="collapse" id="settingsSubmenu">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a href="#" class="nav-link" id="databaseManagementMenu"
                                    data-section="databaseManagementContent">
                                    <i class="fas fa-database"></i>
                                    Database Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" id="adminUsersMenu" data-section="adminUsersContent">
                                    <i class="fas fa-users-cog"></i>
                                    Admin Users
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" id="usersLocationsMenu"
                                    data-section="usersLocationsContent">
                                    <i class="fas fa-users"></i>
                                    Users & Locations
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" id="adminActivityMonitorMenu"
                                    data-section="adminActivityMonitorContent">
                                    <i class="fas fa-chart-line"></i>
                                    Admin Activity Monitor
                                </a>
                            </li>
                            <!-- Access Control Submenu Items -->
                            <li class="nav-item">
                                <a href="#" class="nav-link" id="tierManagementMenu"
                                    data-section="tierManagementContent">
                                    <i class="fas fa-layer-group"></i>
                                    Tier Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" id="userSubscriptionManagementMenu"
                                    data-section="userSubscriptionManagementContent">
                                    <i class="fas fa-user-tag"></i>
                                    User Subscriptions
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" id="rewardTypesMenu" data-section="rewardTypesContent">
                                    <i class="fas fa-tags"></i>
                                    Reward Types
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" id="adminToolsMenu" data-section="adminToolsContent">
                                    <i class="fas fa-tools"></i>
                                    Admin Tools
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link" id="whatsappManagementMenu"
                                    data-section="whatsappManagementContent">
                                    <i class="fab fa-whatsapp"></i>
                                    WhatsApp Management
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
            </ul>

            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn btn-outline-light">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>

        <!-- Main content -->
        <div id="content">
            <!-- Topbar -->
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <button id="sidebarCollapse" class="btn btn-light">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="ml-auto">
                        <span id="currentUserEmail"></span>
                    </div>
                </div>
            </nav>

            <!-- Dashboard Section -->
            <div id="dashboardContent" class="content-section dashboard-content">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Active Campaigns</h5>
                                <p class="card-text">
                                    <span id="activeCampaignsCount" class="counter">0</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Total Receipts</h5>
                                <p class="card-text">
                                    <span id="totalReceiptsCount" class="counter">0</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Active Users</h5>
                                <p class="card-text">
                                    <span id="activeUsersCount" class="counter">0</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Conversion Rate</h5>
                                <p class="card-text">
                                    <span id="conversionRate" class="counter">0%</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaigns Section -->
            <div id="campaignsContent" class="content-section dashboard-content d-none">
                <div id="campaign-management-app">
                    <!-- Vue will mount here -->
                </div>
            </div>

            <!-- Guest Management Section -->
            <div id="guestManagementContent" class="content-section dashboard-content d-none">
                <div id="guest-management-app">
                    <!-- Vue will mount here -->
                </div>
            </div>

            <!-- WiFi Logins Section -->
            <div id="wifiLoginsContent" class="content-section dashboard-content d-none">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h2><i class="fas fa-wifi me-2"></i>WiFi Logins</h2>
                                    <p class="text-muted mb-0">View and manage guest WiFi authentication logs</p>
                                </div>
                                <div>
                                    <button id="refreshWifiLoginsBtn" class="btn btn-primary">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh
                                    </button>
                                    <button id="exportWifiLoginsBtn" class="btn btn-outline-secondary ms-2">
                                        <i class="fas fa-download me-2"></i>Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Search</label>
                                            <input type="text" id="wifiLoginsSearch" class="form-control"
                                                placeholder="Name, email, or MAC...">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Date From</label>
                                            <input type="date" id="wifiLoginsDateFrom" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Date To</label>
                                            <input type="date" id="wifiLoginsDateTo" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Location</label>
                                            <select id="wifiLoginsLocationFilter" class="form-select">
                                                <option value="">All Locations</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-1">Total Logins</p>
                                            <h3 class="mb-0" id="totalLoginsCount">0</h3>
                                        </div>
                                        <div class="text-primary">
                                            <i class="fas fa-sign-in-alt fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-success">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-1">Today's Logins</p>
                                            <h3 class="mb-0" id="todayLoginsCount">0</h3>
                                        </div>
                                        <div class="text-success">
                                            <i class="fas fa-calendar-day fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-info">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-1">Unique Guests</p>
                                            <h3 class="mb-0" id="uniqueGuestsCount">0</h3>
                                        </div>
                                        <div class="text-info">
                                            <i class="fas fa-users fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-1">Active Locations</p>
                                            <h3 class="mb-0" id="activeLocationsCount">0</h3>
                                        </div>
                                        <div class="text-warning">
                                            <i class="fas fa-map-marker-alt fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WiFi Logins Table -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Recent WiFi Logins</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="wifiLoginsTable">
                                            <thead>
                                                <tr>
                                                    <th>Timestamp</th>
                                                    <th>Guest Name</th>
                                                    <th>Email</th>
                                                    <th>Phone</th>
                                                    <th>Location</th>
                                                    <th>Device MAC</th>
                                                    <th>Access Point</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="8" class="text-center py-4">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <p class="mt-2 text-muted">Loading WiFi logins...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Pagination -->
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <small class="text-muted">Showing <span id="wifiLoginsShowing">0</span> of
                                                <span id="wifiLoginsTotal">0</span> logins</small>
                                        </div>
                                        <nav>
                                            <ul class="pagination mb-0" id="wifiLoginsPagination">
                                                <!-- Pagination will be added dynamically -->
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Queue Management Section -->
            <div id="queueManagementContent" class="content-section dashboard-content d-none">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2><i class="fas fa-clock me-2"></i>Queue Management</h2>
                            </div>
                        </div>
                    </div>

                    <div id="queue-management-app">
                        <!-- Vue Queue Management App will mount here -->
                    </div>
                </div>
            </div>

            <!-- Voucher Management Section -->
            <div id="voucherManagementContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2><i class="fas fa-ticket-alt me-2"></i>Voucher Management</h2>
                    <p class="text-muted">Upload, manage, and assign voucher codes to reward types</p>
                </div>

                <!-- Upload Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-upload me-2"></i>Upload Voucher Codes
                                </h5>
                                <div>
                                    <button id="generateSampleVouchersBtn" class="btn btn-sm btn-outline-info me-2"
                                        data-bs-toggle="tooltip"
                                        title="Creates 5 sample vouchers with different statuses (available, assigned, redeemed) for testing the voucher workflow">
                                        <i class="fas fa-flask"></i> Generate 5 Sample Vouchers
                                    </button>
                                    <button id="debugVoucherDataBtn" class="btn btn-sm btn-outline-warning me-2"
                                        title="Debug: Show what's in the database">
                                        <i class="fas fa-bug"></i> Debug DB
                                    </button>
                                    <button id="testModalBtn" class="btn btn-sm btn-outline-secondary me-2"
                                        title="Test if modal content area works">
                                        <i class="fas fa-test-tube"></i> Test Modal
                                    </button>
                                    <button id="clearVoucherUploadBtn" class="btn btn-sm btn-outline-secondary"
                                        style="display: none;">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- File Upload Area -->
                                <div id="voucherUploadArea"
                                    class="upload-area border border-2 border-dashed rounded p-4 text-center mb-3"
                                    style="border-color: #dee2e6 !important; background-color: #f8f9fa; cursor: pointer; transition: all 0.3s ease;">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Drop CSV file here or click to browse</h5>
                                    <p class="text-muted mb-0">Upload a CSV file containing voucher codes</p>
                                    <input type="file" id="voucherCsvFileInput" accept=".csv" style="display: none;">
                                </div>

                                <!-- Sample Data Info -->
                                <div class="alert alert-info border-0 mb-3" style="background-color: #e7f3ff;">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        <small>
                                            <strong>Testing the workflow?</strong> Use the "Generate 5 Sample Vouchers"
                                            button above to create test data with different voucher statuses (available,
                                            assigned, redeemed) without needing a CSV file.
                                        </small>
                                    </div>
                                </div>

                                <!-- CSV Preview -->
                                <div id="voucherCsvPreviewSection" style="display: none;">
                                    <h6><i class="fas fa-eye me-2"></i>File Preview</h6>
                                    <div id="voucherCsvPreview" class="border rounded p-3 mb-3"
                                        style="max-height: 300px; overflow-y: auto;"></div>

                                    <!-- Column Mapping -->
                                    <div class="p-3 rounded mb-3" style="background-color: #f8f9fa;">
                                        <h6><i class="fas fa-map-marked-alt me-2"></i>Column Mapping</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Select Voucher Code Column *</label>
                                                <select id="voucherColumnSelect" class="form-select">
                                                    <option value="">Choose column...</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Select Expiry Date Column (Optional)</label>
                                                <select id="voucherExpiryColumnSelect" class="form-select">
                                                    <option value="">Choose column...</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Link to Reward Type *</label>
                                                <select id="voucherRewardTypeSelect" class="form-select">
                                                    <option value="">Choose reward type...</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Default Expiry Days</label>
                                                <input type="number" id="voucherDefaultExpiryDays" class="form-control"
                                                    value="30" min="1">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Processing Button -->
                                    <div class="text-end mt-3">
                                        <button id="processVouchersBtn" class="btn btn-success">
                                            <i class="fas fa-cogs me-2"></i>Process & Upload Vouchers
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Voucher Pools Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-database me-2"></i>Voucher Pools by Reward Type
                                </h5>
                                <button id="refreshVoucherPoolsBtn" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="voucherPoolsContainer">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading voucher pools...</span>
                                        </div>
                                        <p class="text-muted mt-2 mb-0">Loading voucher pools...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analyticsContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2>Analytics</h2>
                </div>

                <!-- Analytics Navigation -->
                <div class="nav-tabs-container mb-4">
                    <ul class="nav nav-tabs" id="analyticsNavTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overviewTab" data-bs-toggle="tab"
                                data-bs-target="#overviewContent" type="button" role="tab">Overview</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="foodCostAnalyticsTab" data-bs-toggle="tab"
                                data-bs-target="#foodCostAnalyticsContent" type="button" role="tab">Food Cost
                                Analytics</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link disabled" id="guestAnalyticsTab" data-bs-toggle="tab"
                                data-bs-target="#guestAnalyticsContent" type="button" role="tab">Guest Analytics <span
                                    class="badge bg-secondary">Coming Soon</span></button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link disabled" id="campaignAnalyticsTab" data-bs-toggle="tab"
                                data-bs-target="#campaignAnalyticsContent" type="button" role="tab">Campaign Analytics
                                <span class="badge bg-secondary">Coming Soon</span></button>
                        </li>
                    </ul>
                </div>

                <!-- Analytics Content -->
                <div class="tab-content" id="analyticsTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overviewContent" role="tabpanel">
                        <div class="date-range-picker mb-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text">From</span>
                                        <input type="date" id="startDate" class="form-control">
                                        <span class="input-group-text">To</span>
                                        <input type="date" id="endDate" class="form-control">
                                        <button id="updateAnalytics" class="btn btn-primary">Update</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="analytics-charts">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h5 class="card-title">User Engagement</h5>
                                            <canvas id="usersChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h5 class="card-title">Campaign Performance</h5>
                                            <canvas id="campaignsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Food Cost Analytics Tab -->
                    <div class="tab-pane fade" id="foodCostAnalyticsContent" role="tabpanel">
                        <!-- This container will be populated by the Analytics module -->
                    </div>

                    <!-- Guest Analytics Tab (Coming Soon) -->
                    <div class="tab-pane fade" id="guestAnalyticsContent" role="tabpanel">
                        <div class="alert alert-info">
                            <h4><i class="fas fa-info-circle me-2"></i> Coming Soon</h4>
                            <p>Guest Analytics features are currently under development.</p>
                        </div>
                    </div>

                    <!-- Campaign Analytics Tab (Coming Soon) -->
                    <div class="tab-pane fade" id="campaignAnalyticsContent" role="tabpanel">
                        <div class="alert alert-info">
                            <h4><i class="fas fa-info-circle me-2"></i> Coming Soon</h4>
                            <p>Campaign Analytics features are currently under development.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Users Section -->
            <div id="adminUsersContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2>Admin User Management</h2>
                    <button id="add-admin-btn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Add Admin
                    </button>
                </div>
                <div class="admin-users-list">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Display Name</th>
                                <th>Last Sign In</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Activity Monitor Section -->
            <div id="adminActivityMonitorContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2><i class="fas fa-chart-line me-2"></i>Admin Activity Monitor</h2>
                    <p class="text-muted">Monitor and track admin user activities, phone number changes, and system
                        security events</p>
                </div>

                <!-- Activity Monitor Content -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Real-time Activity Monitoring</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-success" id="startActivityMonitoring">
                                            <i class="fas fa-play me-1"></i>Start Monitoring
                                        </button>
                                        <button type="button" class="btn btn-warning" id="pauseActivityMonitoring"
                                            disabled>
                                            <i class="fas fa-pause me-1"></i>Pause
                                        </button>
                                        <button type="button" class="btn btn-danger" id="clearActivityLogs">
                                            <i class="fas fa-trash me-1"></i>Clear Logs
                                        </button>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-info" id="viewPhoneStats">
                                            <i class="fas fa-phone me-1"></i>Phone Stats
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="exportActivityLog">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                        <button type="button" class="btn btn-primary" id="generateReport">
                                            <i class="fas fa-file-alt me-1"></i>Report
                                        </button>
                                    </div>
                                </div>

                                <!-- Statistics Row -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h5 class="card-title">Total Operations</h5>
                                                <h3 id="totalOperations" class="text-primary">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h5 class="card-title">Phone Changes</h5>
                                                <h3 id="phoneChanges" class="text-warning">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h5 class="card-title">Critical Alerts</h5>
                                                <h3 id="criticalAlerts" class="text-danger">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h5 class="card-title">Active Admins</h5>
                                                <h3 id="activeAdmins" class="text-success">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Filters and Controls -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="activityFilter" class="form-label">Filter by Activity Type:</label>
                                        <select id="activityFilter" class="form-select">
                                            <option value="all">All Activities</option>
                                            <option value="phone_changes">Phone Number Changes</option>
                                            <option value="user_operations">User Operations</option>
                                            <option value="admin_actions">Admin Actions</option>
                                            <option value="critical_alerts">Critical Alerts</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="timeFilter" class="form-label">Time Range:</label>
                                        <select id="timeFilter" class="form-select">
                                            <option value="last_hour">Last Hour</option>
                                            <option value="last_24h" selected>Last 24 Hours</option>
                                            <option value="last_week">Last Week</option>
                                            <option value="all_time">All Time</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Main Activity Content -->
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Activity Feed</h6>
                                            </div>
                                            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                                <div id="activityFeed">
                                                    <div class="text-muted text-center py-5">
                                                        <i class="fas fa-play-circle fa-3x mb-3"></i>
                                                        <p>Click "Start Monitoring" to begin tracking admin activities
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <!-- Active Admins Panel -->
                                        <div class="card mb-3">
                                            <div class="card-header">
                                                <h6 class="mb-0">Active Admin Users</h6>
                                            </div>
                                            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                                <div id="activeAdmins">
                                                    <div class="text-muted text-center py-3">
                                                        <small>Loading admin users...</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Phone Number Status Panel -->
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Phone Number Status</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="phoneNumberStatus">
                                                    <div class="text-muted text-center py-3">
                                                        <small>Loading phone status...</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Phone Number Protection Settings -->
                                <div class="card mt-4">
                                    <div class="card-header">
                                        <h6 class="mb-0">Phone Number Protection Settings</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="enablePhoneMonitoring" checked>
                                                    <label class="form-check-label" for="enablePhoneMonitoring">
                                                        Enable Monitoring
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="enablePhoneAlerts" checked>
                                                    <label class="form-check-label" for="enablePhoneAlerts">
                                                        Enable Alerts
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="enablePhoneSounds" checked>
                                                    <label class="form-check-label" for="enablePhoneSounds">
                                                        Enable Sounds
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <button type="button" class="btn btn-outline-primary btn-sm"
                                                    id="testPhoneAlerts">
                                                    <i class="fas fa-test-tube me-1"></i>Test Alerts
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Management Section -->
            <div id="projectManagementContent" class="content-section dashboard-content d-none">
                <div id="project-management-app">
                    <!-- Vue will mount here -->
                </div>
            </div>

            <!-- Food Cost Section -->
            <div id="foodCostContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2>Food Cost Management</h2>
                    <p class="text-muted">Track and analyze stock usage across multiple locations</p>
                    <small class="text-muted" id="food-cost-version">Loading version...</small>
                </div>
                <script>
                    // More robust method to get the Food Cost module version
                    (function () {
                        // Initialize with direct reference to the global module version
                        function updateVersionDisplay() {
                            // Try multiple possible global references
                            if (window.MODULE_VERSION) {
                                document.getElementById('food-cost-version').textContent = 'Version ' + window.MODULE_VERSION;
                                return true;
                            } else if (window.FoodCost && window.FoodCost.version) {
                                document.getElementById('food-cost-version').textContent = 'Version ' + window.FoodCost.version;
                                return true;
                            } else if (window.FoodCostApp && window.FoodCostApp.version) {
                                document.getElementById('food-cost-version').textContent = 'Version ' + window.FoodCostApp.version;
                                return true;
                            }
                            return false;
                        }

                        // First try immediate update (in case module is already loaded)
                        if (!updateVersionDisplay()) {
                            // Set up periodic checks instead of relying on a mutation observer
                            // This is more reliable since the food-cost-app element might not exist yet
                            const observer = (function () {
                                let observerInstance = null;
                                let isObserving = false;

                                function setupObserver() {
                                    // If we already have an observer set up, no need to create another one
                                    if (isObserving) return;

                                    // Only set up the observer if the target element exists
                                    const targetNode = document.getElementById('food-cost-app');
                                    if (!targetNode) return;

                                    // Create and setup the observer
                                    observerInstance = new MutationObserver(function (mutations) {
                                        if (updateVersionDisplay()) {
                                            if (observerInstance) {
                                                observerInstance.disconnect();
                                                isObserving = false;
                                            }
                                        }
                                    });

                                    // Start observing
                                    observerInstance.observe(targetNode, { childList: true, subtree: true });
                                    isObserving = true;
                                }

                                // Try to set up initially
                                setupObserver();

                                return {
                                    retry: setupObserver,
                                    disconnect: function () {
                                        if (observerInstance) {
                                            observerInstance.disconnect();
                                            isObserving = false;
                                        }
                                    }
                                };
                            })();

                            // Also set up a periodic check as a fallback
                            const versionCheckInterval = setInterval(function () {
                                if (updateVersionDisplay()) {
                                    clearInterval(versionCheckInterval);
                                } else {
                                    // Try to set up the observer again in case the element exists now
                                    observer.retry();
                                }
                            }, 500);

                            // Fallback after 8 seconds
                            setTimeout(function () {
                                clearInterval(versionCheckInterval);
                                observer.disconnect();

                                // Check if we already have the version
                                if (document.getElementById('food-cost-version').textContent === 'Loading version...') {
                                    // Last attempt - try to extract version from the module's file directly
                                    console.log('Attempting to fetch version from module file directly');
                                    fetch('./js/modules/food-cost/index.js')
                                        .then(response => response.text())
                                        .then(text => {
                                            const versionMatch = text.match(/MODULE_VERSION\s*=\s*['"](.*?)['"]/);
                                            if (versionMatch && versionMatch[1]) {
                                                document.getElementById('food-cost-version').textContent = 'Version ' + versionMatch[1];
                                                console.log('Version extracted from file: ' + versionMatch[1]);
                                            } else {
                                                document.getElementById('food-cost-version').textContent = 'Version information unavailable';
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error fetching module file:', error);
                                            document.getElementById('food-cost-version').textContent = 'Version information unavailable';
                                        });
                                }
                            }, 8000);
                        }
                    })();
                </script>

                <div id="food-cost-module-container" style="margin-top: 20px;">
                    <!-- Food Cost Module will be loaded here with feature access control -->
                </div>
                <script type="module">
                    // Import the feature-guarded food cost module
                    import { FoodCostWithGuard } from './js/modules/food-cost/food-cost-with-guard.js';
                    // Import the setup module to ensure it's available
                    import { setupFoodCostModule } from './js/modules/food-cost/setup.js';

                    // Make setupFoodCostModule available globally
                    window.setupFoodCostModule = setupFoodCostModule;

                    // Function to initialize food cost module when the section is shown
                    window.initializeFoodCostWithGuard = async function () {
                        console.log('[Dashboard] Initializing food cost module with feature guard...');
                        const success = await FoodCostWithGuard.initializeWithAccessControl('food-cost-module-container');

                        if (!success) {
                            console.log('[Dashboard] Food cost module access denied or initialization failed');
                        } else {
                            console.log('[Dashboard] Food cost module initialized successfully with feature restrictions');
                        }
                    };

                    // Auto-initialize if the food cost content is already visible
                    if (!document.getElementById('foodCostContent').classList.contains('d-none')) {
                        window.initializeFoodCostWithGuard();
                    }
                </script>
            </div>

            <!-- Receipt Management Section -->
            <div id="receiptManagementContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2>Receipt Management</h2>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Filters</h5>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select v-model="filters.status" class="form-select">
                                    <option value="">All</option>
                                    <option value="pending">Pending</option>
                                    <option value="validated">Validated</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Guest Name</label>
                                <input type="text" v-model="filters.guestName" class="form-control"
                                    placeholder="Search guest...">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Campaign</label>
                                <select v-model="filters.campaignId" class="form-select">
                                    <option value="">All Campaigns</option>
                                    <option v-for="campaign in campaigns" :key="campaign.id" :value="campaign.id">
                                        {{ campaign.name }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Date Range</label>
                                <div class="input-group">
                                    <input type="date" v-model="filters.dateRange.start" class="form-control">
                                    <input type="date" v-model="filters.dateRange.end" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Receipts Table -->
                <div class="card">
                    <div class="card-body">
                        <div v-if="loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>

                        <div v-else-if="error" class="alert alert-danger" role="alert">
                            {{ error }}
                        </div>

                        <div v-else>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Guest</th>
                                            <th>Amount</th>
                                            <th>Campaign</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="receipt in filteredReceipts" :key="receipt.id">
                                            <td>{{ formatDate(receipt.timestamp) }}</td>
                                            <td>{{ receipt.guestName }}</td>
                                            <td>{{ receipt.amount }}</td>
                                            <td>
                                                {{ campaigns.find(c => c.id === receipt.campaignId)?.name || 'Unmatched
                                                Campaign' }}
                                            </td>
                                            <td>
                                                <span :class="['badge', getStatusBadgeClass(receipt.status)]">
                                                    {{ receipt.status }}
                                                </span>
                                            </td>
                                            <td>
                                                <button @click="showReceiptDetails(receipt)"
                                                    class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                                <button v-if="receipt.status === 'pending'"
                                                    @click="validateReceipt(receipt)" :disabled="processingReceipt"
                                                    class="btn btn-sm btn-outline-success ms-1">
                                                    <i class="fas fa-check"></i> Validate
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div v-if="filteredReceipts.length === 0" class="text-center py-4">
                                <p class="text-muted">No receipts found matching the current filters.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Settings Section -->
            <div id="receiptSettingsContent" class="content-section dashboard-content d-none">
                <!-- Receipt Settings Vue App will be mounted here -->
                <div id="receiptSettingsApp"></div>
            </div>

            <!-- Rewards Management Section -->
            <div id="rewardManagementContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2>Rewards Management</h2>
                    <button id="manualReward-btn" class="btn btn-success">
                        <i class="fas fa-plus"></i> Issue Manual Reward
                    </button>
                </div>

                <!-- Reward Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Total Rewards</h5>
                                <p class="card-text">
                                    <span id="totalRewardsCount" class="counter">0</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Pending Rewards</h5>
                                <p class="card-text">
                                    <span id="pendingRewardsCount" class="counter">0</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Redeemed Rewards</h5>
                                <p class="card-text">
                                    <span id="redeemedRewardsCount" class="counter">0</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Expired Rewards</h5>
                                <p class="card-text">
                                    <span id="expiredRewardsCount" class="counter">0</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rewards Vue App Container -->
                <div id="reward-management-app">
                    <!-- Filters -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Filters</h5>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Status</label>
                                    <select v-model="filters.status" class="form-select">
                                        <option value="">All</option>
                                        <option value="pending">Pending</option>
                                        <option value="available">Available</option>
                                        <option value="redeemed">Redeemed</option>
                                        <option value="expired">Expired</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Guest Name</label>
                                    <input type="text" v-model="filters.guestName" class="form-control"
                                        placeholder="Search guest...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Reward Type</label>
                                    <select v-model="filters.rewardType" class="form-select">
                                        <option value="">All Types</option>
                                        <option v-for="type in rewardTypes" :key="type.id" :value="type.id">
                                            {{ type.name }}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Date Range</label>
                                    <div class="input-group">
                                        <input type="date" v-model="filters.dateRange.start" class="form-control">
                                        <input type="date" v-model="filters.dateRange.end" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rewards Table -->
                    <div class="card">
                        <div class="card-body">
                            <div v-if="loading" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>

                            <div v-else-if="error" class="alert alert-danger" role="alert">
                                {{ error }}
                            </div>

                            <div v-else>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Guest</th>
                                                <th>Campaign</th>
                                                <th>Type</th>
                                                <th>Reward ID</th>
                                                <th>Value</th>
                                                <th>Status</th>
                                                <th>Expires</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="reward in filteredRewards" :key="reward.id">
                                                <td>{{ formatDate(reward.createdAt) }}</td>
                                                <td>{{ reward.guestName }}</td>
                                                <td>{{ reward.campaignName }}</td>
                                                <td>{{ reward.metadata?.description || 'Standard Reward' }}</td>
                                                <td><code>{{ reward.id }}</code></td>
                                                <td>{{ formatRewardValue(reward) }}</td>
                                                <td>
                                                    <span :class="['badge', getStatusBadgeClass(reward.status)]">
                                                        {{ reward.status }}
                                                    </span>
                                                </td>
                                                <td>{{ formatDate(reward.expiresAt) }}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button @click="showRewardDetails(reward)"
                                                            class="btn btn-outline-primary" title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button
                                                            v-if="reward.status === 'pending' || reward.status === 'available'"
                                                            @click="markRewardAsRedeemed(reward)"
                                                            class="btn btn-outline-success" title="Mark as Redeemed">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button v-if="reward.status !== 'expired'"
                                                            @click="expireReward(reward)"
                                                            class="btn btn-outline-warning" title="Expire Reward">
                                                            <i class="fas fa-clock"></i>
                                                        </button>
                                                        <button @click="deleteReward(reward)"
                                                            class="btn btn-outline-danger" title="Delete Reward">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div v-if="filteredRewards.length === 0" class="text-center py-4">
                                    <p class="text-muted">No rewards found matching the current filters.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2>Settings</h2>
                </div>
                <div class="row">
                    <!-- General Settings -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">General Settings</h5>
                                <div class="form-group">
                                    <label for="notificationEmail">Notification Email</label>
                                    <input type="email" class="form-control" id="notificationEmail">
                                </div>
                                <button class="btn btn-primary mt-3" id="saveGeneralSettings">Save Settings</button>
                            </div>
                        </div>
                    </div>

                    <!-- Phone Number Protection Settings -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-shield-alt me-2"></i>Phone Number Protection
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="enablePhoneMonitoring" checked>
                                    <label class="form-check-label" for="enablePhoneMonitoring">
                                        Enable Phone Number Monitoring
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="enablePhoneAlerts" checked>
                                    <label class="form-check-label" for="enablePhoneAlerts">
                                        Enable Visual Alerts
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enablePhoneSounds" checked>
                                    <label class="form-check-label" for="enablePhoneSounds">
                                        Enable Sound Alerts
                                    </label>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm" id="testPhoneAlerts">
                                        <i class="fas fa-play me-1"></i>Test Alert System
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" id="viewPhoneStats">
                                        <i class="fas fa-chart-bar me-1"></i>View Statistics
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Activity Monitor Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-user-shield me-2"></i>Admin Activity Monitor
                                </h5>
                            </div>
                            <div class="card-body"
                                style="display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 100px !important;">
                                <!-- Control Panel -->
                                <div class="row mb-4"
                                    style="display: block !important; visibility: visible !important;">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-cogs me-2"></i>Monitoring Controls</h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-success btn-sm" id="startActivityMonitoring">
                                                <i class="fas fa-play me-1"></i>Start Monitoring
                                            </button>
                                            <button class="btn btn-warning btn-sm" id="pauseActivityMonitoring"
                                                disabled>
                                                <i class="fas fa-pause me-1"></i>Pause Monitoring
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" id="clearActivityLogs">
                                                <i class="fas fa-trash me-1"></i>Clear Logs
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-chart-line me-2"></i>Quick Stats</h6>
                                        <div id="activityStats" class="border rounded p-3 bg-light">
                                            <div class="row text-center">
                                                <div class="col-4">
                                                    <h6 class="mb-1 text-primary" id="totalOperations">0</h6>
                                                    <small>Operations</small>
                                                </div>
                                                <div class="col-4">
                                                    <h6 class="mb-1 text-warning" id="phoneChanges">0</h6>
                                                    <small>Phone Changes</small>
                                                </div>
                                                <div class="col-4">
                                                    <h6 class="mb-1 text-danger" id="criticalAlerts">0</h6>
                                                    <small>Alerts</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Activity Feed -->
                                <div class="row" style="display: block !important; visibility: visible !important;">
                                    <div class="col-md-8"
                                        style="display: block !important; visibility: visible !important;">
                                        <h6><i class="fas fa-stream me-2"></i>Real-time Activity Feed</h6>
                                        <div id="activityFeed" class="border rounded p-3"
                                            style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div class="text-muted text-center py-5">
                                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                                <p>Click "Start Monitoring" to begin tracking admin activity</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h6><i class="fas fa-users me-2"></i>Active Admin Users</h6>
                                        <div id="activeAdmins" class="border rounded p-3"
                                            style="height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div class="text-muted text-center py-4">
                                                <small>Loading admin users...</small>
                                            </div>
                                        </div>

                                        <h6 class="mt-3"><i class="fas fa-phone me-2"></i>Phone Number Status</h6>
                                        <div id="phoneNumberStatus" class="border rounded p-3"
                                            style="height: 180px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div class="text-muted text-center py-4">
                                                <small>Checking phone numbers...</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Filter and Export Options -->
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-filter me-2"></i>Activity Filters</h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select form-select-sm" id="activityFilter">
                                                    <option value="all">All Activities</option>
                                                    <option value="phone_changes">Phone Changes</option>
                                                    <option value="user_operations">User Operations</option>
                                                    <option value="admin_actions">Admin Actions</option>
                                                    <option value="critical_alerts">Critical Alerts</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select form-select-sm" id="timeFilter">
                                                    <option value="last_hour">Last Hour</option>
                                                    <option value="last_24h">Last 24 Hours</option>
                                                    <option value="last_week">Last Week</option>
                                                    <option value="all_time">All Time</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-download me-2"></i>Export & Reports</h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary btn-sm" id="exportActivityLog">
                                                <i class="fas fa-download me-1"></i>Export Activity Log
                                            </button>
                                            <button class="btn btn-outline-info btn-sm" id="generateReport">
                                                <i class="fas fa-file-alt me-1"></i>Generate Report
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Management Section -->
            <div id="databaseManagementContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2>Database Management</h2>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Data Cleanup</h5>
                                <p class="card-text">Use these tools carefully. Actions cannot be undone.</p>
                                <button id="clearScanningDataBtn" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> Clear Scanning Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tier Management Section (Added) -->
            <div id="tierManagementContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2>Subscription Tier Management</h2>
                </div>
                <div id="tier-management-container">
                    <!-- Vue component will mount here -->
                </div>
            </div>

            <!-- User Subscription Management Section -->
            <div id="userSubscriptionManagementContent" class="content-section dashboard-content d-none">
                <!-- Vue component will mount here -->
            </div>

            <!-- Users & Locations Section -->
            <div id="usersLocationsContent" class="content-section dashboard-content d-none">
                <!-- Content will be added here -->
            </div>

            <!-- Admin Tools Section -->
            <div id="adminToolsContent" class="content-section dashboard-content d-none">
                <div class="section-header">
                    <h2><i class="fas fa-tools me-2"></i>Admin Tools</h2>
                    <p class="text-muted">Manage system settings, data, and configurations</p>
                </div>
                <div id="admin-tools-container">
                    <!-- Admin tools content will be loaded here dynamically -->

                    <!-- Search and Filter -->
                    <div class="search-box">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="toolsSearch" class="form-control"
                                        placeholder="Search admin tools...">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <select id="toolsCategory" class="form-select">
                                    <option value="">All Categories</option>
                                    <option value="subscription">Subscription Management</option>
                                    <option value="database">Database Tools</option>
                                    <option value="testing">Testing & Diagnostics</option>
                                    <option value="analytics">Analytics Tools</option>
                                    <option value="maintenance">Maintenance</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Subscription Management Tools -->
                    <div class="category-header" data-category="subscription">
                        <h4><i class="fas fa-credit-card me-2"></i>Subscription Management</h4>
                        <p class="mb-0">Tools for managing subscription tiers and user access</p>
                    </div>

                    <div class="row mb-4" data-category="subscription">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-primary text-white me-3">
                                            <i class="fas fa-database"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Initialize Subscription Tiers</h5>
                                            <span class="badge bg-primary tool-badge">New</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Set up or reset subscription tier definitions in
                                        the database. Essential for proper access control and feature management.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/initialize-subscription-tiers.html"
                                            class="btn btn-primary btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Create or reset subscription tiers with proper feature mappings">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-success text-white me-3">
                                            <i class="fas fa-user-tag"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Enhanced User Subscription Manager</h5>
                                            <span class="badge bg-success tool-badge">Active</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Advanced subscription management with real-time
                                        monitoring, bulk operations, and analytics dashboard.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/enhanced-user-subscription-manager.html"
                                            class="btn btn-success btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Manage user subscriptions with advanced filtering and bulk operations">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-warning text-white me-3">
                                            <i class="fas fa-layer-group"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Tier Management</h5>
                                            <span class="badge bg-warning tool-badge">Core</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Create, edit, and manage subscription tiers with
                                        features and limits configuration.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/tier-management.html" class="btn btn-warning btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Configure tier definitions, features, and pricing">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-info text-white me-3"
                                            style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-eye"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Tier Visibility Manager</h5>
                                            <span class="badge bg-info tool-badge">New</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Control which subscription tiers are visible to the
                                        public and which are hidden for admin use only.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/tier-visibility-manager.html" class="btn btn-info btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Show/hide tiers from public subscription page">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Database Tools -->
                    <div class="category-header" data-category="database">
                        <h4><i class="fas fa-server me-2"></i>Database Tools</h4>
                        <p class="mb-0">Database management and data integrity tools</p>
                    </div>

                    <div class="row mb-4" data-category="database">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-info text-white me-3">
                                            <i class="fas fa-tools"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Database Structure Migration</h5>
                                            <span class="badge bg-info tool-badge">Utility</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Migrate database structure and fix data integrity
                                        issues across different schema versions.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/database-structure-migration.html"
                                            class="btn btn-info btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Handle database schema migrations and data fixes">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-danger text-white me-3">
                                            <i class="fas fa-wrench"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Repair Data Integrity</h5>
                                            <span class="badge bg-danger tool-badge">Critical</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Fix data integrity issues, orphaned records, and
                                        inconsistent relationships in the database.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/repair-data-integrity.html" class="btn btn-danger btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Repair broken data relationships and integrity issues">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-secondary text-white me-3">
                                            <i class="fas fa-database"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Check Stock Data</h5>
                                            <span class="badge bg-secondary tool-badge">Maintenance</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Verify stock data integrity and check for
                                        inconsistencies in inventory records.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/check-stock-data.html" class="btn btn-secondary btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Validate stock data and identify issues">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-warning text-white me-3">
                                            <i class="fas fa-sync-alt"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Fix Guest Name Consistency</h5>
                                            <span class="badge bg-warning tool-badge">Data Consistency</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Detects and fixes guest name inconsistencies across
                                        related records (rewards, receipts). Ensures data integrity when guest names are
                                        corrected.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/fix-guest-name-consistency.html"
                                            class="btn btn-warning btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Fix guest name inconsistencies across all related records">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Testing & Diagnostics -->
                    <div class="category-header" data-category="testing">
                        <h4><i class="fas fa-vial me-2"></i>Testing & Diagnostics</h4>
                        <p class="mb-0">Test system functionality and diagnose issues</p>
                    </div>

                    <div class="row mb-4" data-category="testing">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-primary text-white me-3">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Test Tier Access</h5>
                                            <span class="badge bg-primary tool-badge">Testing</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Test subscription tier access controls and feature
                                        restrictions for different user levels.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/test-tier-access-v2.html" class="btn btn-primary btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Verify access control is working correctly">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-success text-white me-3">
                                            <i class="fas fa-utensils"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Food Cost Analytics Test</h5>
                                            <span class="badge bg-success tool-badge">Testing</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Test food cost analytics functionality with access
                                        control integration.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/test-food-cost-analytics.html"
                                            class="btn btn-success btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Test food cost module with tier restrictions">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-warning text-white me-3">
                                            <i class="fas fa-stethoscope"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Quick Location Diagnostic</h5>
                                            <span class="badge bg-warning tool-badge">Diagnostic</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Quick diagnostic tool for location-based issues and
                                        data access problems.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/quick-location-diagnostic.html"
                                            class="btn btn-warning btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Diagnose location access and data issues">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Tools -->
                    <div class="category-header" data-category="analytics">
                        <h4><i class="fas fa-chart-line me-2"></i>Analytics Tools</h4>
                        <p class="mb-0">Analytics testing and verification tools</p>
                    </div>

                    <div class="row mb-4" data-category="analytics">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-info text-white me-3">
                                            <i class="fas fa-chart-bar"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Verify Analytics</h5>
                                            <span class="badge bg-info tool-badge">Verification</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Verify analytics data accuracy and test analytics
                                        dashboard functionality.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/verify-analytics.html" class="btn btn-info btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Check analytics data integrity and accuracy">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card tool-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-circle bg-primary text-white me-3">
                                            <i class="fas fa-chart-pie"></i>
                                        </div>
                                        <div>
                                            <h5 class="card-title mb-1">Test Analytics Admin</h5>
                                            <span class="badge bg-primary tool-badge">Admin</span>
                                        </div>
                                    </div>
                                    <p class="card-text flex-grow-1">Test admin-level analytics features and advanced
                                        reporting capabilities.</p>
                                    <div class="mt-auto">
                                        <a href="admin_tools/test-analytics-admin.html" class="btn btn-primary btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Tool
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="tooltip"
                                            title="Test advanced analytics features for admins">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="category-header">
                        <h4><i class="fas fa-bolt me-2"></i>Quick Actions</h4>
                        <p class="mb-0">Frequently used admin actions</p>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <button class="btn btn-outline-primary w-100"
                                                onclick="window.open('admin_tools/', '_blank')">
                                                <i class="fas fa-folder-open me-2"></i>Browse All Tools
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-outline-success w-100"
                                                onclick="window.open('tools/admin/index.html', '_blank')">
                                                <i class="fas fa-list-ul me-2"></i>Admin Tools Index
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-outline-warning w-100" onclick="refreshAdminTools()">
                                                <i class="fas fa-sync-alt me-2"></i>Refresh Tools
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-outline-info w-100" data-bs-toggle="modal"
                                                data-bs-target="#adminToolsHelpModal">
                                                <i class="fas fa-question-circle me-2"></i>Help & Guide
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End admin-tools-container -->
                </div> <!-- End adminToolsContent -->

                <!-- WhatsApp Management Section -->
                <div id="whatsappManagementContent" class="content-section dashboard-content d-none">
                    <div class="section-header">
                        <h2><i class="fab fa-whatsapp me-2 text-success"></i>WhatsApp Management</h2>
                        <p class="text-muted">Manage WhatsApp numbers, locations, and communications</p>
                    </div>

                    <!-- Overview Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card whatsapp-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-phone-alt fa-2x text-success mb-2"></i>
                                    <h4 class="card-title mb-0" id="totalNumbers">0</h4>
                                    <p class="card-text text-muted">Total Numbers</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card whatsapp-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-map-marker-alt fa-2x text-primary mb-2"></i>
                                    <h4 class="card-title mb-0" id="activeLocations">0</h4>
                                    <p class="card-text text-muted">Active Locations</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card whatsapp-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-comments fa-2x text-info mb-2"></i>
                                    <h4 class="card-title mb-0" id="messagesVolume">0</h4>
                                    <p class="card-text text-muted">Messages Today</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card whatsapp-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-heartbeat fa-2x text-warning mb-2"></i>
                                    <h4 class="card-title mb-0" id="systemHealth">
                                        <span class="status-indicator status-active"></span>Active
                                    </h4>
                                    <p class="card-text text-muted">System Status</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-bolt me-2"></i>Quick Actions
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <button class="btn btn-success w-100" onclick="showAddNumberModal()">
                                                <i class="fas fa-plus me-2"></i>Add Number
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-primary w-100" onclick="showAssignLocationModal()">
                                                <i class="fas fa-map-marker-alt me-2"></i>Assign Location
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-info w-100"
                                                onclick="document.getElementById('analyticsSection')?.scrollIntoView({behavior: 'smooth'})">
                                                <i class="fas fa-chart-bar me-2"></i>View Analytics
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <a href="tools/admin/whatsapp-management.html"
                                                class="btn btn-outline-success w-100">
                                                <i class="fas fa-external-link-alt me-2"></i>Full Management
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Location Mapping View -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-map me-2"></i>Location Mapping
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped" id="locationMappingTable">
                                            <thead>
                                                <tr>
                                                    <th>Location</th>
                                                    <th>WhatsApp Number</th>
                                                    <th>Status</th>
                                                    <th>Messages Today</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="locationMappingTableBody">
                                                <!-- Dynamic content will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity Feed -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-history me-2"></i>Recent Activity
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentActivityFeed" class="activity-feed">
                                        <!-- Activity items will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-tasks me-2"></i>Migration Status
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>Overall Progress</span>
                                            <span class="badge bg-success" id="migrationProgress">100%</span>
                                        </div>
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-success" id="migrationProgressBar"
                                                style="width: 100%"></div>
                                        </div>
                                        <small class="text-muted">Migration completed successfully</small>
                                    </div>
                                    <div class="migration-stats">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Numbers Migrated:</span>
                                            <span id="numbersMigrated">0</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Locations Mapped:</span>
                                            <span id="locationsMapped">0</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Templates Setup:</span>
                                            <span id="templatesSetup">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WhatsApp Message History Section -->
                    <div class="row">
                        <div class="col-12">
                            <div id="whatsappMessageHistory">
                                <!-- Message history will be rendered here by the module -->
                            </div>
                        </div>
                    </div>
                </div> <!-- End whatsappManagementContent -->

                <!-- Reward Types Management Section -->
                <div id="rewardTypesContent" class="content-section dashboard-content d-none">
                    <div id="reward-types-app">
                        <!-- Vue will mount here -->
                    </div>
                </div>

                <!-- Modals -->
                <!-- WhatsApp Add Number Modal -->
                <div id="whatsapp-add-number-modal" class="modal fade" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add WhatsApp Number</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="whatsapp-add-number-form">
                                    <div class="mb-3">
                                        <label for="whatsapp-phone-number" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="whatsapp-phone-number"
                                            placeholder="+27123456789" required>
                                        <div class="form-text">Include country code (e.g., +27 for South Africa)</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="whatsapp-display-name" class="form-label">Display Name</label>
                                        <input type="text" class="form-control" id="whatsapp-display-name"
                                            placeholder="Main Branch WhatsApp" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="whatsapp-status" class="form-label">Status</label>
                                        <select class="form-select" id="whatsapp-status" required>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-success" id="confirm-add-whatsapp-number">Add
                                    Number</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Assign Location Modal -->
                <div id="whatsapp-assign-location-modal" class="modal fade" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Assign WhatsApp Number to Location</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="whatsapp-assign-location-form">
                                    <div class="mb-3">
                                        <label for="assign-location-select" class="form-label">Location</label>
                                        <select class="form-select" id="assign-location-select" required>
                                            <option value="">Select a location...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="assign-number-select" class="form-label">WhatsApp Number</label>
                                        <select class="form-select" id="assign-number-select" required>
                                            <option value="">Select a number...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="reassign-existing"
                                                value="">
                                            <label class="form-check-label" for="reassign-existing">
                                                Allow reassigning number from another location
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary"
                                    id="confirm-assign-location">Assign</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Admin Modal -->
                <div id="add-admin-modal" class="modal fade" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Admin User</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="add-admin-form">
                                    <div class="mb-3">
                                        <label for="admin-email" class="form-label">User Email</label>
                                        <input type="email" class="form-control" id="admin-email" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="confirm-add-admin">Add Admin</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create Campaign Modal -->
                <div id="create-campaign-modal" class="modal fade" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Create Campaign</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="campaign-form">
                                    <div class="mb-3">
                                        <label for="campaignName" class="form-label">Campaign Name</label>
                                        <input type="text" class="form-control" id="campaignName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="campaignDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="campaignDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="startDate" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="campaignStartDate" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="endDate" class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="campaignEndDate" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-campaign">Create</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loading-overlay" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <!-- Scripts -->
                <!-- Bootstrap Bundle with Popper -->
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

                <!-- Dropdown Fix Script -->
                <script>
                    // Fix for dropdowns being hidden behind cards
                    document.addEventListener('DOMContentLoaded', function () {
                        // Override Bootstrap's dropdown positioning to use the 'fixed' strategy
                        document.addEventListener('show.bs.dropdown', function (e) {
                            setTimeout(function () {
                                const dropdown = e.target.querySelector('.dropdown-menu');
                                if (dropdown) {
                                    // Backup the original dropdown styles
                                    const originalStyles = {
                                        position: dropdown.style.position,
                                        top: dropdown.style.top,
                                        left: dropdown.style.left,
                                        transform: dropdown.style.transform,
                                        zIndex: dropdown.style.zIndex
                                    };

                                    // Store the original styles on the element
                                    dropdown.dataset.originalStyles = JSON.stringify(originalStyles);

                                    // Get the button position
                                    const button = e.target.querySelector('.dropdown-toggle');
                                    const rect = button.getBoundingClientRect();

                                    // Apply fixed positioning with high z-index
                                    dropdown.style.position = 'fixed';
                                    dropdown.style.top = rect.bottom + 'px';
                                    dropdown.style.left = rect.left + 'px';
                                    dropdown.style.transform = 'none';
                                    dropdown.style.zIndex = '9999';
                                    dropdown.style.width = rect.width + 'px';
                                }
                            }, 0);
                        });

                        // Restore original positioning when dropdown is hidden
                        document.addEventListener('hidden.bs.dropdown', function (e) {
                            const dropdown = e.target.querySelector('.dropdown-menu');
                            if (dropdown && dropdown.dataset.originalStyles) {
                                try {
                                    const originalStyles = JSON.parse(dropdown.dataset.originalStyles);
                                    Object.keys(originalStyles).forEach(key => {
                                        dropdown.style[key] = originalStyles[key];
                                    });
                                } catch (err) {
                                    console.error('Error restoring dropdown styles:', err);
                                }
                            }
                        });
                    });
                </script>
                <script src="js/service-worker-registration.js"></script>

                <!-- CSV Parser for Voucher Management -->
                <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

                <!-- Voucher Management Styles -->
                <style>
                    .upload-area.dragover {
                        border-color: #007bff !important;
                        background-color: #e7f3ff !important;
                    }

                    .voucher-pool-card {
                        border: 1px solid #dee2e6;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    }

                    .voucher-pool-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    }

                    .progress-ring {
                        position: relative;
                        display: inline-block;
                    }

                    .progress-ring-circle {
                        fill: none;
                        stroke: #dee2e6;
                        stroke-width: 4;
                    }

                    .progress-ring-progress {
                        fill: none;
                        stroke: #28a745;
                        stroke-width: 4;
                        stroke-linecap: round;
                        transform: rotate(-90deg);
                        transform-origin: 50% 50%;
                        transition: stroke-dashoffset 0.5s ease;
                    }

                    .status-available {
                        color: #28a745;
                    }

                    .status-assigned {
                        color: #ffc107;
                    }

                    .status-redeemed {
                        color: #17a2b8;
                    }

                    .status-expired {
                        color: #dc3545;
                    }
                </style>

                <!-- Voucher Management Script -->
                <script type="module">
                    // Import Firebase functions from the already configured admin dashboard
                    import { rtdb, ref, get, update } from './js/config/firebase-config.js';

                    // Wait for the admin dashboard to be ready
                    document.addEventListener('DOMContentLoaded', function () {
                        console.log('ðŸŽ« Setting up voucher management...');
                        initializeVoucherManagement();
                    });

                    function initializeVoucherManagement() {
                        // Global variables for voucher management
                        let voucherCsvData = null;
                        let voucherCsvHeaders = [];
                        let voucherRewardTypes = [];

                        async function loadVoucherRewardTypes() {
                            try {
                                const snapshot = await get(ref(rtdb, 'rewardTypes'));
                                const data = snapshot.val() || {};

                                voucherRewardTypes = Object.entries(data).map(([id, type]) => ({
                                    id,
                                    ...type
                                }));

                                // Populate reward type select
                                const voucherRewardTypeSelect = document.getElementById('voucherRewardTypeSelect');
                                if (voucherRewardTypeSelect) {
                                    voucherRewardTypeSelect.innerHTML = '<option value="">Choose reward type...</option>';
                                    voucherRewardTypes.forEach(type => {
                                        const option = document.createElement('option');
                                        option.value = type.id;
                                        option.textContent = type.name;
                                        voucherRewardTypeSelect.appendChild(option);
                                    });
                                }

                                console.log('ðŸ“‹ Loaded voucher reward types:', voucherRewardTypes.length);
                            } catch (error) {
                                console.error('Error loading voucher reward types:', error);
                            }
                        }

                        async function loadVoucherPools() {
                            try {
                                const voucherPoolsContainer = document.getElementById('voucherPoolsContainer');
                                if (!voucherPoolsContainer) {
                                    console.warn('âš ï¸ Voucher pools container not found');
                                    return;
                                }

                                console.log('ðŸ”„ Setting loading state for voucher pools...');
                                voucherPoolsContainer.innerHTML = `
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading voucher pools...</span>
                                    </div>
                                    <p class="text-muted mt-2 mb-0">Loading voucher pools...</p>
                                </div>
                            `;

                                // Ensure we have reward types loaded
                                if (!voucherRewardTypes || voucherRewardTypes.length === 0) {
                                    console.log('âš ï¸ No reward types available, loading them first...');
                                    await loadVoucherRewardTypes();
                                    if (!voucherRewardTypes || voucherRewardTypes.length === 0) {
                                        console.warn('âš ï¸ Still no reward types after loading');
                                    }
                                }

                                const snapshot = await get(ref(rtdb, 'voucherPools'));
                                const pools = snapshot.val() || {};

                                if (Object.keys(pools).length === 0) {
                                    voucherPoolsContainer.innerHTML = `
                                    <div class="text-center py-5">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No Voucher Pools Found</h5>
                                        <p class="text-muted mb-3">Upload your first CSV file to create voucher pools</p>
                                        <button class="btn btn-outline-primary btn-sm" onclick="window.initializeVoucherManagementSection()">
                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                        </button>
                                    </div>
                                `;
                                    return;
                                }

                                // Build pools display
                                let poolsHtml = '<div class="row">';

                                for (const [rewardTypeId, pool] of Object.entries(pools)) {
                                    const rewardType = voucherRewardTypes.find(rt => rt.id === rewardTypeId);
                                    const rewardTypeName = rewardType ? rewardType.name : 'Unknown Reward Type';

                                    // Count voucher statuses
                                    const vouchers = pool.vouchers || {};
                                    const stats = {
                                        total: Object.keys(vouchers).length,
                                        available: 0,
                                        assigned: 0,
                                        redeemed: 0,
                                        expired: 0
                                    };

                                    Object.values(vouchers).forEach(voucher => {
                                        if (voucher.status === 'available') stats.available++;
                                        else if (voucher.status === 'assigned') stats.assigned++;
                                        else if (voucher.status === 'redeemed') stats.redeemed++;
                                        else if (voucher.status === 'expired') stats.expired++;
                                    });

                                    const availabilityPercent = stats.total > 0 ? (stats.available / stats.total) * 100 : 0;

                                    poolsHtml += `
                                    <div class="col-md-6 col-lg-4 mb-4">
                                        <div class="card voucher-pool-card h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-3">
                                                    <div>
                                                        <h6 class="card-title mb-1">${rewardTypeName}</h6>
                                                        <small class="text-muted">Pool ID: ${rewardTypeId}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="progress-ring">
                                                            <svg class="progress-ring" width="60" height="60">
                                                                <circle class="progress-ring-circle" cx="30" cy="30" r="26"></circle>
                                                                <circle class="progress-ring-progress" cx="30" cy="30" r="26" 
                                                                        style="stroke-dasharray: ${2 * Math.PI * 26}; stroke-dashoffset: ${2 * Math.PI * 26 * (1 - availabilityPercent / 100)};"></circle>
                                                            </svg>
                                                            <div class="position-absolute top-50 start-50 translate-middle">
                                                                <small class="fw-bold">${Math.round(availabilityPercent)}%</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row text-center">
                                                    <div class="col-6">
                                                        <div class="border-end">
                                                            <div class="fw-bold status-available">${stats.available}</div>
                                                            <small class="text-muted">Available</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="fw-bold">${stats.total}</div>
                                                        <small class="text-muted">Total</small>
                                                    </div>
                                                </div>
                                                
                                                <hr class="my-3">
                                                
                                                <div class="row small">
                                                    <div class="col-6">
                                                        <span class="status-assigned">â—</span> Assigned: ${stats.assigned}
                                                    </div>
                                                    <div class="col-6">
                                                        <span class="status-redeemed">â—</span> Redeemed: ${stats.redeemed}
                                                    </div>
                                                </div>
                                                
                                                <div class="mt-3">
                                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="viewVoucherPoolDetails('${rewardTypeId}')">
                                                        <i class="fas fa-eye"></i> View Details
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning" onclick="manageVoucherPool('${rewardTypeId}')">
                                                        <i class="fas fa-cog"></i> Manage
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                }

                                poolsHtml += '</div>';
                                voucherPoolsContainer.innerHTML = poolsHtml;

                                console.log('ðŸŽ« Loaded voucher pools:', Object.keys(pools).length);
                                console.log('âœ… Voucher pools display updated successfully');
                            } catch (error) {
                                console.error('Error loading voucher pools:', error);
                                voucherPoolsContainer.innerHTML = `
                                <div class="alert alert-danger" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Error loading voucher pools: ${error.message}
                                </div>
                            `;
                            }
                        }

                        function setupVoucherEventListeners() {
                            console.log('ðŸŽ« Setting up voucher event listeners...');

                            // Get elements fresh each time
                            const voucherUploadArea = document.getElementById('voucherUploadArea');
                            const voucherCsvFileInput = document.getElementById('voucherCsvFileInput');
                            const processVouchersBtn = document.getElementById('processVouchersBtn');
                            const clearVoucherUploadBtn = document.getElementById('clearVoucherUploadBtn');
                            const refreshVoucherPoolsBtn = document.getElementById('refreshVoucherPoolsBtn');

                            if (!voucherUploadArea || !voucherCsvFileInput) {
                                console.warn('âš ï¸ Voucher upload elements not found, will retry when section is shown');
                                return;
                            }

                            console.log('âœ… Found voucher upload elements, setting up listeners...');

                            // Upload area events
                            voucherUploadArea.addEventListener('click', () => {
                                console.log('ðŸŽ« Upload area clicked');
                                voucherCsvFileInput.click();
                            });
                            voucherUploadArea.addEventListener('dragover', handleVoucherDragOver);
                            voucherUploadArea.addEventListener('dragleave', handleVoucherDragLeave);
                            voucherUploadArea.addEventListener('drop', handleVoucherDrop);

                            // File input change
                            voucherCsvFileInput.addEventListener('change', handleVoucherFileSelect);

                            // Button events
                            if (processVouchersBtn) processVouchersBtn.addEventListener('click', processVouchers);
                            if (clearVoucherUploadBtn) clearVoucherUploadBtn.addEventListener('click', clearVoucherUpload);
                            if (refreshVoucherPoolsBtn) refreshVoucherPoolsBtn.addEventListener('click', loadVoucherPools);

                            // Sample vouchers button
                            const generateSampleVouchersBtn = document.getElementById('generateSampleVouchersBtn');
                            if (generateSampleVouchersBtn) {
                                generateSampleVouchersBtn.addEventListener('click', generateSampleVouchers);

                                // Initialize tooltip for sample button
                                if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                                    new bootstrap.Tooltip(generateSampleVouchersBtn);
                                }
                            }

                            // Debug button
                            const debugVoucherDataBtn = document.getElementById('debugVoucherDataBtn');
                            if (debugVoucherDataBtn) {
                                debugVoucherDataBtn.addEventListener('click', debugVoucherData);
                            }

                            // Test modal button
                            const testModalBtn = document.getElementById('testModalBtn');
                            if (testModalBtn) {
                                testModalBtn.addEventListener('click', testModal);
                            }

                            console.log('âœ… Voucher event listeners set up successfully');
                        }

                        function handleVoucherDragOver(e) {
                            e.preventDefault();
                            voucherUploadArea.classList.add('dragover');
                        }

                        function handleVoucherDragLeave(e) {
                            e.preventDefault();
                            voucherUploadArea.classList.remove('dragover');
                        }

                        function handleVoucherDrop(e) {
                            e.preventDefault();
                            voucherUploadArea.classList.remove('dragover');

                            const files = e.dataTransfer.files;
                            if (files.length > 0) {
                                handleVoucherFile(files[0]);
                            }
                        }

                        function handleVoucherFileSelect(e) {
                            const file = e.target.files[0];
                            if (file) {
                                handleVoucherFile(file);
                            }
                        }

                        function handleVoucherFile(file) {
                            if (!file.name.toLowerCase().endsWith('.csv')) {
                                alert('Please select a CSV file.');
                                return;
                            }

                            Papa.parse(file, {
                                header: true,
                                skipEmptyLines: true,
                                complete: function (results) {
                                    voucherCsvData = results.data;
                                    voucherCsvHeaders = Object.keys(voucherCsvData[0] || {});
                                    displayVoucherCsvPreview();
                                },
                                error: function (error) {
                                    console.error('CSV parsing error:', error);
                                    alert('Error parsing CSV file: ' + error.message);
                                }
                            });
                        }

                        function displayVoucherCsvPreview() {
                            const voucherCsvPreviewSection = document.getElementById('voucherCsvPreviewSection');
                            const clearVoucherUploadBtn = document.getElementById('clearVoucherUploadBtn');
                            const voucherCsvPreview = document.getElementById('voucherCsvPreview');

                            if (!voucherCsvPreviewSection || !voucherCsvPreview) {
                                console.warn('âš ï¸ Preview elements not found');
                                return;
                            }

                            // Show preview section
                            voucherCsvPreviewSection.style.display = 'block';
                            if (clearVoucherUploadBtn) clearVoucherUploadBtn.style.display = 'inline-block';

                            // Build preview table
                            let previewHtml = `
                            <table class="table table-sm table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        ${voucherCsvHeaders.map(header => `<th>${header}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                            // Show first 5 rows
                            const previewRows = voucherCsvData.slice(0, 5);
                            previewRows.forEach(row => {
                                previewHtml += '<tr>';
                                voucherCsvHeaders.forEach(header => {
                                    previewHtml += `<td>${row[header] || ''}</td>`;
                                });
                                previewHtml += '</tr>';
                            });

                            previewHtml += `
                                </tbody>
                            </table>
                            <small class="text-muted">Showing first 5 rows of ${voucherCsvData.length} total rows</small>
                        `;

                            voucherCsvPreview.innerHTML = previewHtml;

                            // Populate column selects
                            populateVoucherColumnSelects();
                        }

                        function populateVoucherColumnSelects() {
                            const voucherColumnSelect = document.getElementById('voucherColumnSelect');
                            const voucherExpiryColumnSelect = document.getElementById('voucherExpiryColumnSelect');

                            if (!voucherColumnSelect || !voucherExpiryColumnSelect) {
                                console.warn('âš ï¸ Column select elements not found');
                                return;
                            }

                            // Voucher column select
                            voucherColumnSelect.innerHTML = '<option value="">Choose column...</option>';
                            voucherExpiryColumnSelect.innerHTML = '<option value="">Choose column...</option>';

                            voucherCsvHeaders.forEach(header => {
                                const voucherOption = document.createElement('option');
                                voucherOption.value = header;
                                voucherOption.textContent = header;
                                voucherColumnSelect.appendChild(voucherOption);

                                const expiryOption = document.createElement('option');
                                expiryOption.value = header;
                                expiryOption.textContent = header;
                                voucherExpiryColumnSelect.appendChild(expiryOption);
                            });
                        }

                        async function processVouchers() {
                            // Get elements fresh
                            const voucherColumnSelect = document.getElementById('voucherColumnSelect');
                            const voucherRewardTypeSelect = document.getElementById('voucherRewardTypeSelect');
                            const voucherExpiryColumnSelect = document.getElementById('voucherExpiryColumnSelect');
                            const voucherDefaultExpiryDays = document.getElementById('voucherDefaultExpiryDays');

                            // Validation
                            const voucherColumn = voucherColumnSelect ? voucherColumnSelect.value : '';
                            const rewardTypeId = voucherRewardTypeSelect ? voucherRewardTypeSelect.value : '';

                            if (!voucherColumn) {
                                alert('Please select the voucher code column.');
                                return;
                            }

                            if (!rewardTypeId) {
                                alert('Please select a reward type to link the vouchers.');
                                return;
                            }

                            // Show processing modal
                            const voucherProcessingModal = new bootstrap.Modal(document.getElementById('voucherProcessingModal'));
                            const voucherProcessingStatus = document.getElementById('voucherProcessingStatus');
                            const voucherProcessingProgress = document.getElementById('voucherProcessingProgress');

                            voucherProcessingModal.show();

                            try {
                                const expiryColumn = voucherExpiryColumnSelect ? voucherExpiryColumnSelect.value : '';
                                const defaultExpiryDays = parseInt(voucherDefaultExpiryDays ? voucherDefaultExpiryDays.value : '30') || 30;

                                if (voucherProcessingStatus) voucherProcessingStatus.textContent = 'Extracting voucher codes...';
                                if (voucherProcessingProgress) voucherProcessingProgress.style.width = '20%';

                                // Extract vouchers
                                const vouchers = {};
                                let processedCount = 0;
                                const totalCount = voucherCsvData.length;

                                for (const row of voucherCsvData) {
                                    const voucherCode = row[voucherColumn]?.toString().trim();

                                    if (voucherCode) {
                                        // Calculate expiry
                                        let expiryDate;
                                        if (expiryColumn && row[expiryColumn]) {
                                            expiryDate = new Date(row[expiryColumn]).getTime();
                                        } else {
                                            expiryDate = Date.now() + (defaultExpiryDays * 24 * 60 * 60 * 1000);
                                        }

                                        vouchers[voucherCode] = {
                                            code: voucherCode,
                                            status: 'available',
                                            expiryDate: expiryDate,
                                            createdAt: Date.now(),
                                            rewardTypeId: rewardTypeId,
                                            originalRowData: row
                                        };
                                    }

                                    processedCount++;
                                    const progress = (processedCount / totalCount) * 70; // 70% for processing
                                    if (voucherProcessingProgress) voucherProcessingProgress.style.width = progress + '%';
                                }

                                if (voucherProcessingStatus) voucherProcessingStatus.textContent = 'Saving to database...';
                                if (voucherProcessingProgress) voucherProcessingProgress.style.width = '80%';

                                // Save to database
                                const poolPath = `voucherPools/${rewardTypeId}`;
                                await update(ref(rtdb, poolPath), {
                                    rewardTypeId: rewardTypeId,
                                    createdAt: Date.now(),
                                    updatedAt: Date.now(),
                                    vouchers: vouchers,
                                    stats: {
                                        total: Object.keys(vouchers).length,
                                        available: Object.keys(vouchers).length,
                                        assigned: 0,
                                        redeemed: 0,
                                        expired: 0
                                    }
                                });

                                if (voucherProcessingStatus) voucherProcessingStatus.textContent = 'Complete!';
                                if (voucherProcessingProgress) voucherProcessingProgress.style.width = '100%';

                                setTimeout(async () => {
                                    if (voucherProcessingModal) voucherProcessingModal.hide();
                                    clearVoucherUpload();
                                    await loadVoucherPools();

                                    alert(`Successfully uploaded ${Object.keys(vouchers).length} voucher codes!`);
                                }, 1000);

                            } catch (error) {
                                console.error('Error processing vouchers:', error);
                                if (voucherProcessingModal) voucherProcessingModal.hide();
                                alert('Error processing vouchers: ' + error.message);
                            }
                        }

                        function clearVoucherUpload() {
                            voucherCsvData = null;
                            voucherCsvHeaders = [];
                            const voucherCsvFileInput = document.getElementById('voucherCsvFileInput');
                            const voucherCsvPreviewSection = document.getElementById('voucherCsvPreviewSection');
                            const clearVoucherUploadBtn = document.getElementById('clearVoucherUploadBtn');

                            if (voucherCsvFileInput) voucherCsvFileInput.value = '';
                            if (voucherCsvPreviewSection) voucherCsvPreviewSection.style.display = 'none';
                            if (clearVoucherUploadBtn) clearVoucherUploadBtn.style.display = 'none';
                        }

                        // Generate sample vouchers for testing
                        async function generateSampleVouchers() {
                            // Confirmation dialog
                            const confirmed = confirm(
                                'This will create 5 sample vouchers and a sample reward type in your database for testing.\n\n' +
                                'Sample vouchers will include:\n' +
                                'â€¢ 3 Available vouchers\n' +
                                'â€¢ 1 Assigned voucher\n' +
                                'â€¢ 1 Redeemed voucher\n\n' +
                                'Do you want to continue?'
                            );

                            if (!confirmed) {
                                return;
                            }

                            try {
                                console.log('ðŸŽ« Generating sample vouchers...');

                                let sampleRewardTypeId = 'sample-reward-type';

                                // First, ensure we have a sample reward type
                                const rewardTypesSnapshot = await get(ref(rtdb, 'rewardTypes'));
                                const existingRewardTypes = rewardTypesSnapshot.val() || {};

                                if (!existingRewardTypes[sampleRewardTypeId]) {
                                    console.log('Creating sample reward type...');
                                    await update(ref(rtdb, `rewardTypes/${sampleRewardTypeId}`), {
                                        name: 'Sample Reward Type',
                                        description: 'Sample reward type for testing voucher system',
                                        value: '10% Discount',
                                        type: 'discount',
                                        createdAt: Date.now(),
                                        isActive: true
                                    });

                                    // Refresh reward types in the UI
                                    await loadVoucherRewardTypes();
                                }

                                // Generate 5 sample vouchers with different statuses
                                const sampleVouchers = {
                                    'SAMPLE001': {
                                        code: 'SAMPLE001',
                                        status: 'available',
                                        expiryDate: Date.now() + (30 * 24 * 60 * 60 * 1000), // 30 days from now
                                        createdAt: Date.now(),
                                        rewardTypeId: sampleRewardTypeId,
                                        description: 'Available sample voucher'
                                    },
                                    'SAMPLE002': {
                                        code: 'SAMPLE002',
                                        status: 'available',
                                        expiryDate: Date.now() + (30 * 24 * 60 * 60 * 1000),
                                        createdAt: Date.now(),
                                        rewardTypeId: sampleRewardTypeId,
                                        description: 'Available sample voucher'
                                    },
                                    'SAMPLE003': {
                                        code: 'SAMPLE003',
                                        status: 'assigned',
                                        expiryDate: Date.now() + (30 * 24 * 60 * 60 * 1000),
                                        createdAt: Date.now(),
                                        assignedAt: Date.now() - (2 * 24 * 60 * 60 * 1000), // 2 days ago
                                        assignedTo: 'sample-guest-123',
                                        rewardTypeId: sampleRewardTypeId,
                                        description: 'Assigned sample voucher'
                                    },
                                    'SAMPLE004': {
                                        code: 'SAMPLE004',
                                        status: 'redeemed',
                                        expiryDate: Date.now() + (30 * 24 * 60 * 60 * 1000),
                                        createdAt: Date.now(),
                                        assignedAt: Date.now() - (5 * 24 * 60 * 60 * 1000), // 5 days ago
                                        redeemedAt: Date.now() - (1 * 24 * 60 * 60 * 1000), // 1 day ago
                                        assignedTo: 'sample-guest-456',
                                        rewardTypeId: sampleRewardTypeId,
                                        description: 'Redeemed sample voucher'
                                    },
                                    'SAMPLE005': {
                                        code: 'SAMPLE005',
                                        status: 'available',
                                        expiryDate: Date.now() + (7 * 24 * 60 * 60 * 1000), // 7 days from now
                                        createdAt: Date.now(),
                                        rewardTypeId: sampleRewardTypeId,
                                        description: 'Available sample voucher (expires soon)'
                                    }
                                };

                                // Save sample vouchers to database
                                const poolPath = `voucherPools/${sampleRewardTypeId}`;
                                await update(ref(rtdb, poolPath), {
                                    rewardTypeId: sampleRewardTypeId,
                                    createdAt: Date.now(),
                                    updatedAt: Date.now(),
                                    vouchers: sampleVouchers,
                                    stats: {
                                        total: 5,
                                        available: 3,
                                        assigned: 1,
                                        redeemed: 1,
                                        expired: 0
                                    }
                                });

                                console.log('âœ… Sample vouchers generated successfully');

                                // Refresh the display
                                await loadVoucherPools();

                                // Show success message
                                const generateSampleVouchersBtn = document.getElementById('generateSampleVouchersBtn');
                                if (generateSampleVouchersBtn) {
                                    const originalText = generateSampleVouchersBtn.innerHTML;
                                    generateSampleVouchersBtn.innerHTML = '<i class="fas fa-check text-success"></i> Sample Vouchers Created!';
                                    generateSampleVouchersBtn.disabled = true;

                                    setTimeout(() => {
                                        generateSampleVouchersBtn.innerHTML = originalText;
                                        generateSampleVouchersBtn.disabled = false;
                                    }, 3000);
                                }

                            } catch (error) {
                                console.error('âŒ Error generating sample vouchers:', error);
                                alert('Error generating sample vouchers: ' + error.message);
                            }
                        }

                        // Debug function to show what's in the database
                        async function debugVoucherData() {
                            try {
                                console.log('ðŸ› Starting debug of voucher data...');

                                // Check reward types
                                const rewardTypesSnapshot = await get(ref(rtdb, 'rewardTypes'));
                                const rewardTypesData = rewardTypesSnapshot.val();
                                console.log('ðŸŽ¯ Reward Types in DB:', rewardTypesData);

                                // Check voucher pools
                                const voucherPoolsSnapshot = await get(ref(rtdb, 'voucherPools'));
                                const voucherPoolsData = voucherPoolsSnapshot.val();
                                console.log('ðŸŽ« Voucher Pools in DB:', voucherPoolsData);

                                // Check loaded variables
                                console.log('ðŸ“‹ Loaded voucherRewardTypes variable:', voucherRewardTypes);

                                // Show in alert for user
                                let debugInfo = 'ðŸ› DEBUG INFO:\n\n';
                                debugInfo += `Reward Types in DB: ${rewardTypesData ? Object.keys(rewardTypesData).length : 0}\n`;
                                debugInfo += `Voucher Pools in DB: ${voucherPoolsData ? Object.keys(voucherPoolsData).length : 0}\n`;
                                debugInfo += `Loaded voucherRewardTypes: ${voucherRewardTypes ? voucherRewardTypes.length : 0}\n\n`;

                                if (rewardTypesData) {
                                    debugInfo += 'Reward Type IDs:\n';
                                    Object.keys(rewardTypesData).forEach(id => {
                                        debugInfo += `- ${id}: ${rewardTypesData[id].name}\n`;
                                    });
                                }

                                if (voucherPoolsData) {
                                    debugInfo += '\nVoucher Pool IDs:\n';
                                    Object.keys(voucherPoolsData).forEach(id => {
                                        const pool = voucherPoolsData[id];
                                        const voucherCount = pool.vouchers ? Object.keys(pool.vouchers).length : 0;
                                        debugInfo += `- ${id}: ${voucherCount} vouchers\n`;
                                    });
                                }

                                alert(debugInfo);

                            } catch (error) {
                                console.error('âŒ Error in debug function:', error);
                                alert('Debug error: ' + error.message);
                            }
                        }

                        // Test modal function to see if modal content area works
                        function testModal() {
                            try {
                                console.log('ðŸ§ª Testing modal functionality...');

                                const modalElement = document.getElementById('voucherPoolDetailsModal');
                                const contentElement = document.getElementById('voucherPoolDetailsContent');

                                console.log('ðŸ§ª Modal element exists:', !!modalElement);
                                console.log('ðŸ§ª Content element exists:', !!contentElement);

                                if (modalElement && contentElement) {
                                    const modal = new bootstrap.Modal(modalElement);
                                    modal.show();

                                    // Set simple test content
                                    contentElement.innerHTML = `
                                    <div style="background: yellow; border: 3px solid red; padding: 20px; font-size: 20px;">
                                        <h2>ðŸ§ª TEST CONTENT</h2>
                                        <p>If you can see this, the modal content area works!</p>
                                        <p>Current time: ${new Date().toLocaleTimeString()}</p>
                                        <button class="btn btn-primary" onclick="alert('Button works!')">Test Button</button>
                                    </div>
                                `;

                                    console.log('ðŸ§ª Test content inserted');
                                } else {
                                    alert('Modal or content element not found!');
                                }

                            } catch (error) {
                                console.error('âŒ Error in test modal:', error);
                                alert('Test modal error: ' + error.message);
                            }
                        }

                        // Helper functions (defined early to avoid reference errors)
                        function getStatusBadgeColor(status) {
                            switch (status) {
                                case 'available': return 'success';
                                case 'assigned': return 'warning';
                                case 'redeemed': return 'info';
                                case 'expired': return 'danger';
                                default: return 'secondary';
                            }
                        }

                        // Global functions for pool management
                        window.viewVoucherPoolDetails = async function (rewardTypeId) {
                            console.log('ðŸ“‹ View voucher pool details:', rewardTypeId);
                            console.log('ðŸ“‹ Current voucherRewardTypes:', voucherRewardTypes);

                            try {
                                // Show the modal
                                const modalElement = document.getElementById('voucherPoolDetailsModal');
                                const detailsModal = new bootstrap.Modal(modalElement);

                                console.log('ðŸ” Modal element found:', !!modalElement);
                                console.log('ðŸ” Bootstrap Modal created:', !!detailsModal);

                                detailsModal.show();
                                console.log('ðŸ“¢ Modal show() called');

                                // Wait for modal to be fully shown before setting content
                                modalElement.addEventListener('shown.bs.modal', function () {
                                    console.log('ðŸŽ¬ Modal fully shown event fired');
                                }, { once: true });

                                // Set loading state immediately
                                const initialContent = document.getElementById('voucherPoolDetailsContent');
                                if (initialContent) {
                                    initialContent.innerHTML = `
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="text-muted mt-2 mb-0">Loading voucher details...</p>
                                    </div>
                                `;
                                    console.log('â³ Loading state set');
                                } else {
                                    console.error('âŒ Could not set loading state - element not found');
                                }

                                // Ensure reward types are loaded
                                if (!voucherRewardTypes || voucherRewardTypes.length === 0) {
                                    console.log('ðŸ”„ Reward types not loaded, loading now...');
                                    await loadVoucherRewardTypes();
                                }

                                // Load pool data
                                console.log('ðŸ” Loading pool data for:', rewardTypeId);
                                const snapshot = await get(ref(rtdb, `voucherPools/${rewardTypeId}`));
                                const poolData = snapshot.val();
                                console.log('ðŸ“¦ Pool data loaded:', poolData);

                                if (!poolData) {
                                    document.getElementById('voucherPoolDetailsContent').innerHTML = `
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        No voucher pool found for reward type: ${rewardTypeId}
                                        <br><small class="text-muted">Available pools: Please check the database path.</small>
                                    </div>
                                `;
                                    return;
                                }

                                // Get reward type name
                                const rewardType = voucherRewardTypes.find(rt => rt.id === rewardTypeId);
                                const rewardTypeName = rewardType ? rewardType.name : `Unknown Reward Type (${rewardTypeId})`;
                                console.log('ðŸ·ï¸ Reward type name:', rewardTypeName);

                                // Build voucher details table
                                const vouchers = poolData.vouchers || {};
                                const voucherList = Object.values(vouchers);
                                console.log('ðŸŽ« Vouchers to display:', voucherList);

                                let detailsHtml = `
                                <div class="mb-4">
                                    <h6>Pool Information</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Reward Type:</strong> ${rewardTypeName}<br>
                                            <strong>Pool ID:</strong> ${rewardTypeId}<br>
                                            <strong>Total Vouchers:</strong> ${voucherList.length}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Created:</strong> ${new Date(poolData.createdAt || Date.now()).toLocaleDateString()}<br>
                                            <strong>Last Updated:</strong> ${new Date(poolData.updatedAt || Date.now()).toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>Voucher Status Summary</h6>
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <div class="card border-success">
                                                <div class="card-body py-2">
                                                    <div class="status-available fw-bold">${voucherList.filter(v => v.status === 'available').length}</div>
                                                    <small>Available</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="card border-warning">
                                                <div class="card-body py-2">
                                                    <div class="status-assigned fw-bold">${voucherList.filter(v => v.status === 'assigned').length}</div>
                                                    <small>Assigned</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="card border-info">
                                                <div class="card-body py-2">
                                                    <div class="status-redeemed fw-bold">${voucherList.filter(v => v.status === 'redeemed').length}</div>
                                                    <small>Redeemed</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="card border-danger">
                                                <div class="card-body py-2">
                                                    <div class="status-expired fw-bold">${voucherList.filter(v => v.status === 'expired' || (v.expiryDate && v.expiryDate < Date.now())).length}</div>
                                                    <small>Expired</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                                                        <th>Code</th>
                                        <th>Status</th>
                                        <th>Expiry Date</th>
                                        <th>Created</th>
                                        <th>Assigned To</th>
                                        <th>Reward ID</th>
                                        <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;

                                voucherList.forEach((voucher, index) => {
                                    console.log(`ðŸŽ« Processing voucher ${index + 1}:`, voucher);

                                    const isExpired = voucher.expiryDate && voucher.expiryDate < Date.now();
                                    const statusClass = isExpired ? 'expired' : voucher.status;
                                    const statusText = isExpired ? 'expired' : voucher.status;

                                    console.log(`ðŸŽ« Voucher ${voucher.code}: status=${statusText}, expired=${isExpired}`);

                                    try {
                                        const badgeColor = getStatusBadgeColor(statusText);
                                        console.log(`ðŸŽ« Badge color for ${statusText}: ${badgeColor}`);

                                        detailsHtml += `
                                        <tr>
                                            <td><code>${voucher.code}</code></td>
                                            <td><span class="badge bg-${badgeColor} status-${statusClass}">${statusText.toUpperCase()}</span></td>
                                            <td>${voucher.expiryDate ? new Date(voucher.expiryDate).toLocaleDateString() : 'No expiry'}</td>
                                            <td>${new Date(voucher.createdAt || Date.now()).toLocaleDateString()}</td>
                                            <td>${voucher.assignedToGuest ? (voucher.assignedToGuestName || voucher.assignedToGuest) : '-'}</td>
                                            <td>${voucher.assignedToReward ? `<code>${voucher.assignedToReward}</code>` : '-'}</td>
                                                                                    <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="copyVoucherCode('${voucher.code}', this)" title="Copy code">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </td>
                                        </tr>
                                    `;
                                    } catch (error) {
                                        console.error(`âŒ Error processing voucher ${voucher.code}:`, error);
                                    }
                                });

                                detailsHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;

                                console.log('ðŸ“ Generated HTML length:', detailsHtml.length);
                                console.log('ðŸ“ First 500 chars of HTML:', detailsHtml.substring(0, 500));

                                const contentElement = document.getElementById('voucherPoolDetailsContent');
                                console.log('ðŸŽ¯ Content element found:', !!contentElement);

                                if (contentElement) {
                                    contentElement.innerHTML = detailsHtml;
                                    console.log('âœ… HTML inserted into modal');

                                    // Force visibility with inline styles (debugging)
                                    contentElement.style.display = 'block';
                                    contentElement.style.visibility = 'visible';
                                    contentElement.style.opacity = '1';
                                    contentElement.style.height = 'auto';
                                    contentElement.style.overflow = 'visible';

                                    // Add a bright background to make it obvious (debugging)
                                    contentElement.style.backgroundColor = '#f0f8ff';
                                    contentElement.style.border = '2px solid red';
                                    contentElement.style.padding = '10px';

                                    console.log('ðŸŽ¨ Applied debug styles to content element');

                                    // Check if content is still there after a short delay
                                    setTimeout(() => {
                                        const stillThere = document.getElementById('voucherPoolDetailsContent');
                                        console.log('ðŸ” Content still exists after 1s:', !!stillThere);
                                        if (stillThere) {
                                            console.log('ðŸ“ Content length after 1s:', stillThere.innerHTML.length);

                                            const styles = getComputedStyle(stillThere);
                                            console.log('ðŸ‘ï¸ Content display:', styles.display);
                                            console.log('ðŸ‘ï¸ Content visibility:', styles.visibility);
                                            console.log('ðŸ‘ï¸ Content opacity:', styles.opacity);
                                            console.log('ðŸ‘ï¸ Content height:', styles.height);
                                            console.log('ðŸ‘ï¸ Content overflow:', styles.overflow);

                                            // Check parent elements
                                            let parent = stillThere.parentElement;
                                            let level = 1;
                                            while (parent && level <= 5) {
                                                const parentStyles = getComputedStyle(parent);
                                                console.log(`ðŸ” Parent ${level} (${parent.tagName}${parent.id ? '#' + parent.id : ''}${parent.className ? '.' + parent.className.split(' ').join('.') : ''}):`,
                                                    `display=${parentStyles.display}, visibility=${parentStyles.visibility}, opacity=${parentStyles.opacity}`);
                                                parent = parent.parentElement;
                                                level++;
                                            }

                                            // FORCE VISIBILITY - nuclear option
                                            console.log('ðŸ’¥ FORCING VISIBILITY...');
                                            stillThere.style.setProperty('display', 'block', 'important');
                                            stillThere.style.setProperty('visibility', 'visible', 'important');
                                            stillThere.style.setProperty('opacity', '1', 'important');
                                            stillThere.style.setProperty('height', 'auto', 'important');
                                            stillThere.style.setProperty('max-height', 'none', 'important');
                                            stillThere.style.setProperty('overflow', 'visible', 'important');
                                            stillThere.style.setProperty('position', 'relative', 'important');
                                            stillThere.style.setProperty('z-index', '9999', 'important');

                                            console.log('ðŸ’¥ Forced visibility applied');

                                            console.log('ðŸ“¦ Content first 200 chars:', stillThere.innerHTML.substring(0, 200));

                                            // Check modal visibility
                                            const modal = document.getElementById('voucherPoolDetailsModal');
                                            if (modal) {
                                                console.log('ðŸ” Modal display:', getComputedStyle(modal).display);
                                                console.log('ðŸ” Modal visibility:', getComputedStyle(modal).visibility);
                                                console.log('ðŸ” Modal opacity:', getComputedStyle(modal).opacity);
                                            }
                                        }
                                    }, 1000);
                                } else {
                                    console.error('âŒ Content element not found!');
                                }

                                // Set up export functionality
                                const exportBtn = document.getElementById('exportVouchersBtn');
                                exportBtn.onclick = () => exportVouchersToCSV(rewardTypeId, voucherList, rewardTypeName);

                            } catch (error) {
                                console.error('âŒ Error loading voucher pool details:', error);
                                console.error('âŒ Error stack:', error.stack);

                                const contentElement = document.getElementById('voucherPoolDetailsContent');
                                if (contentElement) {
                                    contentElement.innerHTML = `
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Error loading voucher details: ${error.message}
                                        <br><small class="text-muted">Check console for full error details</small>
                                    </div>
                                `;
                                } else {
                                    console.error('âŒ Could not even show error - content element not found!');
                                }
                            }
                        };

                        window.manageVoucherPool = async function (rewardTypeId) {
                            console.log('âš™ï¸ Manage voucher pool:', rewardTypeId);
                            console.log('âš™ï¸ Current voucherRewardTypes:', voucherRewardTypes);

                            try {
                                // Show the modal
                                const managementModalElement = document.getElementById('voucherPoolManagementModal');
                                const managementModal = new bootstrap.Modal(managementModalElement);

                                console.log('ðŸ” Management modal element found:', !!managementModalElement);
                                console.log('ðŸ” Bootstrap Management Modal created:', !!managementModal);

                                managementModal.show();
                                console.log('ðŸ“¢ Management modal show() called');

                                // Wait for modal to be fully shown
                                managementModalElement.addEventListener('shown.bs.modal', function () {
                                    console.log('ðŸŽ¬ Management modal fully shown event fired');
                                }, { once: true });

                                // Set loading state immediately
                                const initialManagementContent = document.getElementById('voucherPoolManagementContent');
                                if (initialManagementContent) {
                                    initialManagementContent.innerHTML = `
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="text-muted mt-2 mb-0">Loading management options...</p>
                                    </div>
                                `;
                                    console.log('â³ Management loading state set');
                                } else {
                                    console.error('âŒ Could not set management loading state - element not found');
                                }

                                // Ensure reward types are loaded
                                if (!voucherRewardTypes || voucherRewardTypes.length === 0) {
                                    console.log('ðŸ”„ Reward types not loaded, loading now...');
                                    await loadVoucherRewardTypes();
                                }

                                // Load pool data
                                console.log('ðŸ” Loading pool data for management:', rewardTypeId);
                                const snapshot = await get(ref(rtdb, `voucherPools/${rewardTypeId}`));
                                const poolData = snapshot.val();
                                console.log('ðŸ“¦ Management pool data loaded:', poolData);

                                if (!poolData) {
                                    document.getElementById('voucherPoolManagementContent').innerHTML = `
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        No voucher pool found for reward type: ${rewardTypeId}
                                        <br><small class="text-muted">Please check the database path.</small>
                                    </div>
                                `;
                                    return;
                                }

                                // Get reward type name
                                const rewardType = voucherRewardTypes.find(rt => rt.id === rewardTypeId);
                                const rewardTypeName = rewardType ? rewardType.name : `Unknown Reward Type (${rewardTypeId})`;
                                console.log('ðŸ·ï¸ Management reward type name:', rewardTypeName);

                                const vouchers = poolData.vouchers || {};
                                const voucherList = Object.values(vouchers);
                                const stats = poolData.stats || {};

                                let managementHtml = `
                                <div class="mb-4">
                                    <h6>Pool: ${rewardTypeName}</h6>
                                    <p class="text-muted">Manage vouchers and pool settings for this reward type.</p>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6><i class="fas fa-chart-pie me-2"></i>Pool Statistics</h6>
                                                <ul class="list-unstyled mb-0">
                                                    <li><strong>Total Vouchers:</strong> ${voucherList.length}</li>
                                                    <li><strong>Available:</strong> <span class="status-available">${stats.available || 0}</span></li>
                                                    <li><strong>Assigned:</strong> <span class="status-assigned">${stats.assigned || 0}</span></li>
                                                    <li><strong>Redeemed:</strong> <span class="status-redeemed">${stats.redeemed || 0}</span></li>
                                                    <li><strong>Expired:</strong> <span class="status-expired">${stats.expired || 0}</span></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6><i class="fas fa-tools me-2"></i>Quick Actions</h6>
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-outline-info btn-sm" onclick="refreshVoucherStats('${rewardTypeId}')">
                                                        <i class="fas fa-sync-alt me-1"></i>Refresh Statistics
                                                    </button>
                                                    <button class="btn btn-outline-warning btn-sm" onclick="resetExpiredVouchers('${rewardTypeId}')">
                                                        <i class="fas fa-clock me-1"></i>Reset Expired Vouchers
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Danger Zone</h6>
                                    <p class="mb-2">These actions cannot be undone. Please use with caution.</p>
                                    <button class="btn btn-outline-danger btn-sm" onclick="confirmClearPool('${rewardTypeId}', '${rewardTypeName}')">
                                        <i class="fas fa-trash me-1"></i>Clear All Vouchers in Pool
                                    </button>
                                </div>
                            `;

                                console.log('ðŸ“ Management HTML generated, length:', managementHtml.length);
                                console.log('ðŸ“ First 300 chars of management HTML:', managementHtml.substring(0, 300));

                                const managementContentElement = document.getElementById('voucherPoolManagementContent');
                                console.log('ðŸŽ¯ Management content element found:', !!managementContentElement);

                                if (managementContentElement) {
                                    managementContentElement.innerHTML = managementHtml;
                                    console.log('âœ… Management HTML inserted');

                                    // Apply same debug styles as view details
                                    managementContentElement.style.setProperty('display', 'block', 'important');
                                    managementContentElement.style.setProperty('visibility', 'visible', 'important');
                                    managementContentElement.style.setProperty('opacity', '1', 'important');
                                    managementContentElement.style.setProperty('background-color', '#f0f8ff', 'important');
                                    managementContentElement.style.setProperty('border', '2px solid blue', 'important');
                                    managementContentElement.style.setProperty('padding', '10px', 'important');

                                    console.log('ðŸŽ¨ Applied debug styles to management element');

                                    // Check after 1 second
                                    setTimeout(() => {
                                        const stillThere = document.getElementById('voucherPoolManagementContent');
                                        if (stillThere) {
                                            const styles = getComputedStyle(stillThere);
                                            console.log('ðŸ” Management content after 1s - display:', styles.display, 'visibility:', styles.visibility, 'opacity:', styles.opacity);

                                            // Force visibility if needed
                                            console.log('ðŸ’¥ FORCING MANAGEMENT VISIBILITY...');
                                            stillThere.style.setProperty('display', 'block', 'important');
                                            stillThere.style.setProperty('visibility', 'visible', 'important');
                                            stillThere.style.setProperty('opacity', '1', 'important');
                                            stillThere.style.setProperty('height', 'auto', 'important');
                                            stillThere.style.setProperty('max-height', 'none', 'important');
                                            stillThere.style.setProperty('overflow', 'visible', 'important');
                                            stillThere.style.setProperty('position', 'relative', 'important');
                                            stillThere.style.setProperty('z-index', '9999', 'important');

                                            console.log('ðŸ’¥ Management forced visibility applied');
                                        }
                                    }, 1000);
                                } else {
                                    console.error('âŒ Management content element not found!');
                                }

                            } catch (error) {
                                console.error('âŒ Error loading voucher pool management:', error);
                                console.error('âŒ Management error stack:', error.stack);

                                const managementContentElement = document.getElementById('voucherPoolManagementContent');
                                if (managementContentElement) {
                                    managementContentElement.innerHTML = `
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Error loading management options: ${error.message}
                                        <br><small class="text-muted">Check console for full error details</small>
                                    </div>
                                `;
                                }
                            }
                        };

                        // Helper functions (moved to top)

                        window.copyVoucherCode = function (code, buttonElement) {
                            navigator.clipboard.writeText(code).then(() => {
                                // Show temporary success feedback
                                if (buttonElement) {
                                    // Change button content temporarily
                                    const originalContent = buttonElement.innerHTML;
                                    buttonElement.innerHTML = '<i class="fas fa-check text-success"></i>';
                                    buttonElement.disabled = true;

                                    setTimeout(() => {
                                        buttonElement.innerHTML = originalContent;
                                        buttonElement.disabled = false;
                                    }, 1500);
                                } else {
                                    // Fallback to console log
                                    console.log('âœ… Voucher code copied to clipboard:', code);
                                }
                            }).catch(err => {
                                console.error('Failed to copy:', err);
                                alert('Failed to copy voucher code. Please copy manually: ' + code);
                            });
                        };

                        function exportVouchersToCSV(rewardTypeId, vouchers, rewardTypeName) {
                            const csv = [
                                ['Voucher Code', 'Status', 'Expiry Date', 'Created Date', 'Assigned To', 'Reward ID', 'Assigned Date', 'Redeemed Date'],
                                ...vouchers.map(v => [
                                    v.code,
                                    v.status,
                                    v.expiryDate ? new Date(v.expiryDate).toISOString() : '',
                                    new Date(v.createdAt || Date.now()).toISOString(),
                                    v.assignedToGuest ? (v.assignedToGuestName || v.assignedToGuest) : '',
                                    v.assignedToReward || '',
                                    v.assignedAt ? new Date(v.assignedAt).toISOString() : '',
                                    v.redeemedAt ? new Date(v.redeemedAt).toISOString() : ''
                                ])
                            ].map(row => row.join(',')).join('\n');

                            const blob = new Blob([csv], { type: 'text/csv' });
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `vouchers_${rewardTypeName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                            link.click();
                            URL.revokeObjectURL(url);
                        }

                        window.confirmClearPool = function (rewardTypeId, rewardTypeName) {
                            const confirmed = confirm(
                                `âš ï¸ WARNING: This will permanently delete ALL vouchers in the "${rewardTypeName}" pool.\n\n` +
                                `This action cannot be undone!\n\n` +
                                `Are you absolutely sure you want to continue?`
                            );

                            if (confirmed) {
                                clearVoucherPool(rewardTypeId);
                            }
                        };

                        async function clearVoucherPool(rewardTypeId) {
                            try {
                                // Delete the entire pool using proper Firebase format
                                await update(ref(rtdb), { [`voucherPools/${rewardTypeId}`]: null });

                                // Close the management modal
                                const managementModal = bootstrap.Modal.getInstance(document.getElementById('voucherPoolManagementModal'));
                                if (managementModal) managementModal.hide();

                                // Refresh the pools display
                                await loadVoucherPools();

                                alert('âœ… Voucher pool cleared successfully!');

                            } catch (error) {
                                console.error('âŒ Error clearing voucher pool:', error);
                                alert('Error clearing voucher pool: ' + error.message);
                            }
                        }

                        window.refreshVoucherStats = async function (rewardTypeId) {
                            try {
                                // Recalculate stats from vouchers
                                const snapshot = await get(ref(rtdb, `voucherPools/${rewardTypeId}/vouchers`));
                                const vouchers = snapshot.val() || {};

                                const now = Date.now();

                                const stats = {
                                    total: Object.keys(vouchers).length,
                                    available: 0,
                                    assigned: 0,
                                    redeemed: 0,
                                    expired: 0
                                };

                                console.log('ðŸ”„ Recalculating voucher stats for:', rewardTypeId);

                                Object.values(vouchers).forEach(voucher => {
                                    // Count based on actual status, not expiry date
                                    // Expired date only matters for 'available' vouchers

                                    if (voucher.status === 'available') {
                                        // Check if available voucher is expired
                                        if (voucher.expiryDate && voucher.expiryDate <= now) {
                                            stats.expired++;
                                        } else {
                                            stats.available++;
                                        }
                                    } else if (voucher.status === 'assigned') {
                                        // Assigned vouchers stay assigned regardless of expiry
                                        stats.assigned++;
                                    } else if (voucher.status === 'redeemed') {
                                        // Redeemed vouchers stay redeemed regardless of expiry
                                        stats.redeemed++;
                                    } else if (voucher.status === 'expired') {
                                        stats.expired++;
                                    }
                                });

                                console.log('ðŸ“Š Calculated stats:', stats);

                                // Update stats in database
                                await update(ref(rtdb, `voucherPools/${rewardTypeId}/stats`), stats);

                                // Refresh displays
                                await loadVoucherPools();
                                manageVoucherPool(rewardTypeId); // Refresh management modal

                                alert('âœ… Statistics refreshed successfully!');

                            } catch (error) {
                                console.error('âŒ Error refreshing stats:', error);
                                alert('Error refreshing statistics: ' + error.message);
                            }
                        };

                        window.resetExpiredVouchers = async function (rewardTypeId) {
                            try {
                                const confirmed = confirm(
                                    'This will extend the expiry date of all expired vouchers by 30 days.\n\n' +
                                    'Note: Vouchers that were already assigned or redeemed will remain in that status.\n' +
                                    'Only available vouchers will become available again.\n\n' +
                                    'Are you sure you want to continue?'
                                );

                                if (!confirmed) return;

                                // Get all vouchers
                                const snapshot = await get(ref(rtdb, `voucherPools/${rewardTypeId}/vouchers`));
                                const vouchers = snapshot.val() || {};

                                const now = Date.now();
                                const thirtyDaysMs = 30 * 24 * 60 * 60 * 1000;

                                let extendedCount = 0;
                                let availableAgain = 0;
                                let assignedExtended = 0;
                                let redeemedExtended = 0;

                                const updates = {};

                                // Find expired vouchers and extend their expiry dates
                                Object.entries(vouchers).forEach(([voucherCode, voucher]) => {
                                    if (voucher.expiryDate && voucher.expiryDate < now) {
                                        // Extend expiry date by 30 days
                                        updates[`voucherPools/${rewardTypeId}/vouchers/${voucherCode}/expiryDate`] = now + thirtyDaysMs;

                                        // Count by status (DO NOT change the status)
                                        extendedCount++;

                                        if (voucher.status === 'available') {
                                            availableAgain++;
                                        } else if (voucher.status === 'assigned') {
                                            assignedExtended++;
                                        } else if (voucher.status === 'redeemed') {
                                            redeemedExtended++;
                                        }
                                    }
                                });

                                if (extendedCount === 0) {
                                    alert('No expired vouchers found to extend.');
                                    return;
                                }

                                console.log('ðŸ”„ Extending expiry dates:', {
                                    total: extendedCount,
                                    available: availableAgain,
                                    assigned: assignedExtended,
                                    redeemed: redeemedExtended
                                });

                                // Apply updates
                                await update(ref(rtdb, '/'), updates);

                                // Refresh stats - this will correctly calculate available count based on actual statuses
                                await refreshVoucherStats(rewardTypeId);

                                // Show detailed summary
                                alert(
                                    `âœ… Extended expiry dates for ${extendedCount} voucher(s):\n\n` +
                                    `â€¢ ${availableAgain} available voucher(s) are now usable again\n` +
                                    `â€¢ ${assignedExtended} assigned voucher(s) extended (still assigned)\n` +
                                    `â€¢ ${redeemedExtended} redeemed voucher(s) extended (still redeemed)\n\n` +
                                    `All vouchers now expire 30 days from today.`
                                );

                            } catch (error) {
                                console.error('âŒ Error extending voucher expiry dates:', error);
                                alert('Error extending voucher expiry dates: ' + error.message);
                            }
                        };

                        // Initialize voucher management when voucher content is shown
                        window.initializeVoucherManagementSection = async function () {
                            console.log('ðŸŽ« Initializing voucher management section...');

                            // First, ensure event listeners are set up
                            setupVoucherEventListeners();

                            // Set loading state immediately
                            const voucherPoolsContainer = document.getElementById('voucherPoolsContainer');
                            if (voucherPoolsContainer) {
                                voucherPoolsContainer.innerHTML = `
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading voucher pools...</span>
                                    </div>
                                    <p class="text-muted mt-2 mb-0">Initializing voucher management...</p>
                                </div>
                            `;
                            }

                            try {
                                console.log('ðŸ”„ Step 1: Loading reward types...');
                                await loadVoucherRewardTypes();
                                console.log('âœ… Step 1 complete: Reward types loaded:', voucherRewardTypes.length);

                                console.log('ðŸ”„ Step 2: Loading voucher pools...');
                                await loadVoucherPools();
                                console.log('âœ… Step 2 complete: Voucher pools loaded');

                                console.log('âœ… Voucher management section fully initialized');
                            } catch (error) {
                                console.error('âŒ Error initializing voucher management:', error);
                                console.error('âŒ Full error stack:', error.stack);

                                // Show error in pools container
                                if (voucherPoolsContainer) {
                                    voucherPoolsContainer.innerHTML = `
                                    <div class="alert alert-danger" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Error initializing voucher management: ${error.message}
                                        <br><small class="text-muted">Please check the console for more details and try the refresh button.</small>
                                        <br><button class="btn btn-sm btn-outline-primary mt-2" onclick="window.initializeVoucherManagementSection()">
                                            <i class="fas fa-sync-alt me-1"></i>Retry Initialization
                                        </button>
                                    </div>
                                `;
                                }
                            }
                        };

                        // Auto-initialize to set up the global function
                        setupVoucherEventListeners();

                        // The admin dashboard will now handle initialization when the section is shown
                        // No need for auto-initialization polling

                        console.log('ðŸŽ« Voucher management script loaded and ready');
                    }
                </script>
            </div>
        </div>

        <!-- MODAL FOR EDITING/ADDING TIERS (Managed by tier-management.js) -->
        <div class="modal fade" id="editTierModal" tabindex="-1" aria-labelledby="editTierModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editTierModalLabel">{{ isAddingNewTier ? 'Add New Tier' : 'Edit
                            Tier' }}</h5>
                        <button type="button" class="btn-close" @click="cancelEdit" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Form managed by AdminTierManagement component -->
                        <form @submit.prevent="saveChanges">
                            <!-- Tier Name, Description, Prices -->
                            <div class="mb-3">
                                <label for="tierName" class="form-label">Tier Name</label>
                                <input type="text" class="form-control" id="tierName" v-model="editFormData.name"
                                    required>
                            </div>
                            <div class="mb-3">
                                <label for="tierDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="tierDescription" rows="3"
                                    v-model="editFormData.description" required></textarea>
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <label for="tierMonthlyPrice" class="form-label">Monthly Price ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="tierMonthlyPrice"
                                        v-model.number="editFormData.monthlyPrice">
                                </div>
                                <div class="col">
                                    <label for="tierAnnualPrice" class="form-label">Annual Price ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="tierAnnualPrice"
                                        v-model.number="editFormData.annualPrice">
                                </div>
                            </div>

                            <hr>

                            <!-- Features -->
                            <h6>Features</h6>
                            <div v-if="editFormData.features" v-for="feature in availableFeatures" :key="feature"
                                class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" :id="'feature_' + feature"
                                    v-model="editFormData.features[feature]">
                                <label class="form-check-label" :for="'feature_' + feature">{{
                                    getFeatureDisplay(feature) }}</label>
                            </div>
                            <div v-else class="text-muted small mb-2">Initializing features...</div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mb-3"
                                @click="addNewFeature">Add New Feature</button>

                            <hr>

                            <!-- Limits -->
                            <h6>Limits</h6>
                            <div v-for="limit in availableLimits" :key="limit" class="row mb-2 align-items-center">
                                <label :for="'limit_' + limit" class="col-sm-4 col-form-label">{{ getLimitDisplay(limit)
                                    }}</label>
                                <div v-if="editFormData.limits" class="col-sm-8">
                                    <input type="number" step="1" class="form-control" :id="'limit_' + limit"
                                        v-model.number="editFormData.limits[limit]"
                                        placeholder="0 or leave empty (Infinity)">
                                    <small class="text-muted">Use 0 or empty for Infinity/Unlimited</small>
                                </div>
                                <div v-else class="col-sm-8 text-muted small">Initializing limits...</div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @click="addNewLimit">Add New
                                Limit</button>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @click="cancelEdit">Cancel</button>
                        <button type="button" class="btn btn-primary" @click="saveChanges">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voucher Management Processing Modal -->
        <div class="modal fade" id="voucherProcessingModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <h5 id="voucherProcessingTitle">Processing Vouchers...</h5>
                        <p id="voucherProcessingStatus" class="text-muted mb-0">Uploading and organizing voucher
                            codes...</p>
                        <div class="progress mt-3" style="height: 6px;">
                            <div id="voucherProcessingProgress" class="progress-bar" role="progressbar"
                                style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voucher Pool Details Modal -->
        <div class="modal fade" id="voucherPoolDetailsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-eye me-2"></i>Voucher Pool Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="voucherPoolDetailsContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-muted mt-2 mb-0">Loading voucher details...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="exportVouchersBtn">
                            <i class="fas fa-download me-1"></i>Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voucher Pool Management Modal -->
        <div class="modal fade" id="voucherPoolManagementModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-cog me-2"></i>Manage Voucher Pool
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="voucherPoolManagementContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-muted mt-2 mb-0">Loading management options...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-danger" id="clearPoolBtn" style="display: none;">
                            <i class="fas fa-trash me-1"></i>Clear All Vouchers
                        </button>
                    </div>
                </div>
            </div>
        </div>

</body>

</html>