<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Professional Tier Limits - Feature #27</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .result.success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        .result.error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .result.info {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        .quota-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin: 10px 0;
        }
        .test-button {
            margin: 5px;
        }
        .expected-limits {
            background: #e7f3ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1><i class="fas fa-crown"></i> Professional Tier Limits Test</h1>
                <p class="text-muted">Feature #27: Professional tier limits enforced (10000 guests, 5 locations)</p>
                <hr>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="expected-limits">
                    <h5><i class="fas fa-clipboard-check"></i> Expected Professional Tier Limits</h5>
                    <ul>
                        <li><strong>Guest Records:</strong> 10,000</li>
                        <li><strong>Locations:</strong> 5</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Authentication Status -->
        <div class="row">
            <div class="col-12">
                <div class="test-section">
                    <h3><i class="fas fa-user"></i> Authentication Status</h3>
                    <div id="authStatus" class="result info">Checking authentication...</div>
                    <div id="subscriptionInfo"></div>
                </div>
            </div>
        </div>

        <!-- Quota Display -->
        <div class="row">
            <div class="col-md-6">
                <div class="test-section">
                    <h4><i class="fas fa-users"></i> Guest Quota</h4>
                    <div id="guestQuotaDisplay" class="quota-display">Loading...</div>
                    <button class="btn btn-primary w-100" onclick="checkGuestQuota()">
                        <i class="fas fa-sync"></i> Refresh Guest Quota
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="test-section">
                    <h4><i class="fas fa-map-marker-alt"></i> Location Quota</h4>
                    <div id="locationQuotaDisplay" class="quota-display">Loading...</div>
                    <button class="btn btn-primary w-100" onclick="checkLocationQuota()">
                        <i class="fas fa-sync"></i> Refresh Location Quota
                    </button>
                </div>
            </div>
        </div>

        <!-- Limit Enforcement Tests -->
        <div class="row">
            <div class="col-md-6">
                <div class="test-section">
                    <h4><i class="fas fa-user-plus"></i> Test Guest Limit (10,000)</h4>
                    <p class="text-muted">Verify 10,000 guest limit enforcement</p>
                    <button class="btn btn-success w-100 test-button" onclick="testGuestLimit()">
                        <i class="fas fa-check"></i> Verify Guest Limit
                    </button>
                    <button class="btn btn-info w-100 test-button" onclick="simulateGuestAtLimit()">
                        <i class="fas fa-vial"></i> Simulate At Limit
                    </button>
                    <div id="guestTestResult"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="test-section">
                    <h4><i class="fas fa-map-pin"></i> Test Location Limit (5)</h4>
                    <p class="text-muted">Verify 5 location limit enforcement</p>
                    <button class="btn btn-success w-100 test-button" onclick="testLocationLimit()">
                        <i class="fas fa-check"></i> Verify Location Limit
                    </button>
                    <button class="btn btn-info w-100 test-button" onclick="simulateLocationAtLimit()">
                        <i class="fas fa-vial"></i> Simulate At Limit
                    </button>
                    <button class="btn btn-warning w-100 test-button" onclick="testAddSixthLocation()">
                        <i class="fas fa-times"></i> Try Adding 6th Location
                    </button>
                    <div id="locationTestResult"></div>
                </div>
            </div>
        </div>

        <!-- Test Results Log -->
        <div class="row">
            <div class="col-12">
                <div class="test-section">
                    <h4><i class="fas fa-list"></i> Test Results Log</h4>
                    <div id="testLog" style="max-height: 400px; overflow-y: auto;"></div>
                    <button class="btn btn-secondary mt-2" onclick="clearLog()">
                        <i class="fas fa-trash"></i> Clear Log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqGdlFSb0Vq-_lhBs3Gy74HaFr1k5MlGQ",
            authDomain: "merakicaptiveportal-firebasedb.firebaseapp.com",
            databaseURL: "https://merakicaptiveportal-firebasedb-default-rtdb.firebaseio.com",
            projectId: "merakicaptiveportal-firebasedb",
            storageBucket: "merakicaptiveportal-firebasedb.appspot.com",
            messagingSenderId: "970968041389",
            appId: "1:970968041389:web:46234ff0e5c3cb7cdc5bdb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentSubscription = null;

        // Make functions global
        window.checkGuestQuota = checkGuestQuota;
        window.checkLocationQuota = checkLocationQuota;
        window.testGuestLimit = testGuestLimit;
        window.testLocationLimit = testLocationLimit;
        window.simulateGuestAtLimit = simulateGuestAtLimit;
        window.simulateLocationAtLimit = simulateLocationAtLimit;
        window.testAddSixthLocation = testAddSixthLocation;
        window.clearLog = clearLog;

        function logResult(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logDiv.insertBefore(resultDiv, logDiv.firstChild);
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        async function checkGuestQuota() {
            if (!currentUser) {
                logResult('Please log in first', 'error');
                return;
            }

            try {
                logResult('Fetching guest quota...', 'info');

                // Get subscription
                const subSnapshot = await get(ref(db, `subscriptions/${currentUser.uid}`));
                const subscription = subSnapshot.val();

                if (!subscription) {
                    logResult('No subscription found', 'error');
                    return;
                }

                // Count guests
                const guestsSnapshot = await get(ref(db, 'guests'));
                const allGuests = guestsSnapshot.val() || {};
                const guestCount = Object.keys(allGuests).length;

                const maxGuests = subscription.limits?.guestRecords || 500;
                const remaining = maxGuests === Infinity ? 'unlimited' : Math.max(0, maxGuests - guestCount);

                const quotaDiv = document.getElementById('guestQuotaDisplay');
                quotaDiv.innerHTML = `${guestCount} / ${maxGuests === Infinity ? '∞' : maxGuests}`;

                logResult(`Guest quota: ${guestCount} used, ${remaining} remaining`, 'success');

                // Verify Professional tier limit
                if (subscription.tierId === 'professional' && maxGuests === 10000) {
                    logResult('✅ Professional tier guest limit is correctly set to 10,000', 'success');
                } else if (subscription.tierId === 'professional') {
                    logResult(`❌ Professional tier guest limit is ${maxGuests}, expected 10,000`, 'error');
                }

                return { guestCount, maxGuests, remaining };
            } catch (error) {
                logResult(`Error checking guest quota: ${error.message}`, 'error');
                console.error(error);
                return null;
            }
        }

        async function checkLocationQuota() {
            if (!currentUser) {
                logResult('Please log in first', 'error');
                return;
            }

            try {
                logResult('Fetching location quota...', 'info');

                // Get subscription
                const subSnapshot = await get(ref(db, `subscriptions/${currentUser.uid}`));
                const subscription = subSnapshot.val();

                if (!subscription) {
                    logResult('No subscription found', 'error');
                    return;
                }

                const locationIds = subscription.locationIds || [];
                const maxLocations = subscription.limits?.locations || 1;
                const remaining = maxLocations === Infinity ? 'unlimited' : Math.max(0, maxLocations - locationIds.length);

                const quotaDiv = document.getElementById('locationQuotaDisplay');
                quotaDiv.innerHTML = `${locationIds.length} / ${maxLocations === Infinity ? '∞' : maxLocations}`;

                logResult(`Location quota: ${locationIds.length} used, ${remaining} remaining`, 'success');

                // Verify Professional tier limit
                if (subscription.tierId === 'professional' && maxLocations === 5) {
                    logResult('✅ Professional tier location limit is correctly set to 5', 'success');
                } else if (subscription.tierId === 'professional') {
                    logResult(`❌ Professional tier location limit is ${maxLocations}, expected 5`, 'error');
                }

                return { locationCount: locationIds.length, maxLocations, remaining, locationIds };
            } catch (error) {
                logResult(`Error checking location quota: ${error.message}`, 'error');
                console.error(error);
                return null;
            }
        }

        async function testGuestLimit() {
            logResult('Testing guest limit configuration...', 'info');
            const quota = await checkGuestQuota();

            if (!quota) {
                logResult('Failed to check guest quota', 'error');
                return;
            }

            const { guestCount, maxGuests, remaining } = quota;

            if (maxGuests === 10000) {
                logResult('✅ PASS: Guest limit is correctly set to 10,000', 'success');
                Swal.fire({
                    title: 'Guest Limit Verified',
                    text: `Professional tier limit is correctly set to 10,000 guests. Currently using ${guestCount}.`,
                    icon: 'success'
                });
            } else {
                logResult(`❌ FAIL: Guest limit is ${maxGuests}, expected 10,000`, 'error');
                Swal.fire({
                    title: 'Guest Limit Incorrect',
                    text: `Expected 10,000 but found ${maxGuests}`,
                    icon: 'error'
                });
            }
        }

        async function testLocationLimit() {
            logResult('Testing location limit configuration...', 'info');
            const quota = await checkLocationQuota();

            if (!quota) {
                logResult('Failed to check location quota', 'error');
                return;
            }

            const { locationCount, maxLocations, remaining } = quota;

            if (maxLocations === 5) {
                logResult('✅ PASS: Location limit is correctly set to 5', 'success');
                Swal.fire({
                    title: 'Location Limit Verified',
                    text: `Professional tier limit is correctly set to 5 locations. Currently using ${locationCount}.`,
                    icon: 'success'
                });
            } else {
                logResult(`❌ FAIL: Location limit is ${maxLocations}, expected 5`, 'error');
                Swal.fire({
                    title: 'Location Limit Incorrect',
                    text: `Expected 5 but found ${maxLocations}`,
                    icon: 'error'
                });
            }
        }

        async function simulateGuestAtLimit() {
            if (!currentUser) {
                logResult('Please log in first', 'error');
                return;
            }

            logResult('Simulating guest count at limit...', 'info');

            const result = await Swal.fire({
                title: 'Simulate At Limit?',
                text: 'This will temporarily show what happens when you reach 10,000 guests',
                icon: 'question',
                showCancelButton: true
            });

            if (!result.isConfirmed) return;

            const quota = await checkGuestQuota();
            if (!quota) return;

            const { maxGuests } = quota;

            if (maxGuests >= 10000) {
                const remaining = 10000 - 9999; // Simulate at 9999 guests
                logResult(`Simulation: At 9999/10000 guests, ${remaining} remaining`, 'info');
                Swal.fire({
                    title: 'Simulation Result',
                    text: `At 9999 guests, you have ${remaining} slot(s) remaining. Adding one more would reach the limit.`,
                    icon: 'info'
                });
            }
        }

        async function simulateLocationAtLimit() {
            if (!currentUser) {
                logResult('Please log in first', 'error');
                return;
            }

            logResult('Simulating location count at limit...', 'info');

            const result = await Swal.fire({
                title: 'Simulate At Limit?',
                text: 'This will temporarily show what happens when you have 5 locations',
                icon: 'question',
                showCancelButton: true
            });

            if (!result.isConfirmed) return;

            const quota = await checkLocationQuota();
            if (!quota) return;

            const { maxLocations, locationCount } = quota;

            if (maxLocations === 5) {
                const remaining = 5 - locationCount;
                logResult(`Current: ${locationCount}/5 locations, ${remaining} remaining`, 'info');

                if (remaining > 0) {
                    Swal.fire({
                        title: 'Simulation Result',
                        html: `You currently have ${locationCount} location(s).<br>
                               Maximum: 5 locations<br>
                               Remaining: ${remaining} slot(s)<br><br>
                               When you add ${remaining} more location(s), you'll reach the limit.`,
                        icon: 'info'
                    });
                } else {
                    Swal.fire({
                        title: 'At Limit',
                        text: 'You already have 5 locations. Cannot add more.',
                        icon: 'warning'
                    });
                }
            }
        }

        async function testAddSixthLocation() {
            if (!currentUser) {
                logResult('Please log in first', 'error');
                return;
            }

            logResult('Testing 6th location limit enforcement...', 'info');

            try {
                const subSnapshot = await get(ref(db, `subscriptions/${currentUser.uid}`));
                const subscription = subSnapshot.val();

                if (!subscription) {
                    logResult('No subscription found', 'error');
                    return;
                }

                const locationIds = subscription.locationIds || [];
                const maxLocations = subscription.limits?.locations || 1;

                logResult(`Current locations: ${locationIds.length}/${maxLocations}`, 'info');

                if (locationIds.length >= maxLocations) {
                    logResult('✅ PASS: Cannot add 6th location - limit enforced correctly', 'success');
                    Swal.fire({
                        title: 'Limit Enforced',
                        text: `You have ${locationIds.length} locations. Your Professional tier allows ${maxLocations}. Cannot add more.`,
                        icon: 'success'
                    });
                } else {
                    const remaining = maxLocations - locationIds.length;
                    logResult(`Currently have ${locationIds.length} locations, ${remaining} remaining before limit`, 'info');

                    // Actually try to add a location (if less than 5)
                    const testLocationId = `test_location_${Date.now()}`;
                    const newLocations = [...locationIds, testLocationId];

                    if (newLocations.length <= maxLocations) {
                        await update(ref(db, `subscriptions/${currentUser.uid}`), {
                            locationIds: newLocations
                        });
                        logResult(`✅ Added test location (${newLocations.length}/${maxLocations})`, 'success');

                        Swal.fire({
                            title: 'Location Added',
                            text: `Test location added. Now at ${newLocations.length}/${maxLocations}. ${maxLocations - newLocations.length} remaining.`,
                            icon: 'success'
                        });

                        await checkLocationQuota();
                    } else {
                        logResult('✅ PASS: Limit would be exceeded, blocked', 'success');
                    }
                }
            } catch (error) {
                logResult(`Error testing 6th location: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Initialize auth listener
        onAuthStateChanged(auth, async (user) => {
            const authStatus = document.getElementById('authStatus');
            const subscriptionInfo = document.getElementById('subscriptionInfo');

            if (user) {
                currentUser = user;
                authStatus.className = 'result success';
                authStatus.innerHTML = `<i class="fas fa-check-circle"></i> Logged in as: ${user.email}`;

                try {
                    const subSnapshot = await get(ref(db, `subscriptions/${user.uid}`));
                    currentSubscription = subSnapshot.val();

                    if (currentSubscription) {
                        const tierName = currentSubscription.tierId || 'unknown';
                        const isProfessional = tierName === 'professional';

                        subscriptionInfo.innerHTML = `
                            <div class="result ${isProfessional ? 'success' : 'error'} mt-2">
                                <strong>Subscription Tier:</strong> ${tierName.toUpperCase()}<br>
                                <strong>Guest Limit:</strong> ${currentSubscription.limits?.guestRecords || 'N/A'}<br>
                                <strong>Location Limit:</strong> ${currentSubscription.limits?.locations || 'N/A'}
                                ${!isProfessional ? '<br><br>⚠️ This test page is for Professional tier users. Please log in with testuser.professional@sparks.test' : ''}
                            </div>
                        `;

                        logResult(`Logged in as ${user.email} (${tierName} tier)`, isProfessional ? 'success' : 'error');

                        if (isProfessional) {
                            // Auto-load quotas
                            await checkGuestQuota();
                            await checkLocationQuota();
                        }
                    } else {
                        subscriptionInfo.innerHTML = `<div class="result error mt-2">No subscription found</div>`;
                        logResult('No subscription found for user', 'error');
                    }
                } catch (error) {
                    console.error('Error loading subscription:', error);
                    subscriptionInfo.innerHTML = `<div class="result error mt-2">Error loading subscription</div>`;
                    logResult(`Error loading subscription: ${error.message}`, 'error');
                }
            } else {
                currentUser = null;
                authStatus.className = 'result error';
                authStatus.innerHTML = `<i class="fas fa-times-circle"></i> Not logged in. <a href="/login.html">Log in</a> with testuser.professional@sparks.test`;
                subscriptionInfo.innerHTML = '';
                logResult('User not authenticated', 'error');
            }
        });
    </script>
</body>
</html>
