<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Subscription Limits - Features #25 & #26</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .result.success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        .result.error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .result.info {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        .quota-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin: 10px 0;
        }
        .test-button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1><i class="fas fa-vial"></i> Subscription Limits Test Page</h1>
                <p class="text-muted">Features #25 (Free tier limits) & #26 (Starter tier limits)</p>
                <hr>
            </div>
        </div>

        <!-- Authentication Status -->
        <div class="row">
            <div class="col-12">
                <div class="test-section">
                    <h3><i class="fas fa-user"></i> Authentication Status</h3>
                    <div id="authStatus" class="result info">Checking authentication...</div>
                    <div id="subscriptionInfo"></div>
                </div>
            </div>
        </div>

        <!-- Guest Quota Display -->
        <div class="row">
            <div class="col-md-6">
                <div class="test-section">
                    <h4><i class="fas fa-users"></i> Guest Quota</h4>
                    <div id="guestQuotaDisplay" class="quota-display">Loading...</div>
                    <button class="btn btn-primary w-100" onclick="checkGuestQuota()">
                        <i class="fas fa-sync"></i> Refresh Guest Quota
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="test-section">
                    <h4><i class="fas fa-map-marker-alt"></i> Location Quota</h4>
                    <div id="locationQuotaDisplay" class="quota-display">Loading...</div>
                    <button class="btn btn-primary w-100" onclick="checkLocationQuota()">
                        <i class="fas fa-sync"></i> Refresh Location Quota
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Actions -->
        <div class="row">
            <div class="col-md-6">
                <div class="test-section">
                    <h4><i class="fas fa-user-plus"></i> Test Guest Limits</h4>
                    <p class="text-muted">Attempt to add a guest (will check limits)</p>
                    <button class="btn btn-success w-100 test-button" onclick="testAddGuest()">
                        <i class="fas fa-plus"></i> Try to Add Guest
                    </button>
                    <button class="btn btn-warning w-100 test-button" onclick="openGuestManagement()">
                        <i class="fas fa-external-link-alt"></i> Open Guest Management
                    </button>
                    <div id="guestTestResult"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="test-section">
                    <h4><i class="fas fa-map-pin"></i> Test Location Limits</h4>
                    <p class="text-muted">Attempt to add a location (will check limits)</p>
                    <button class="btn btn-success w-100 test-button" onclick="testAddLocation()">
                        <i class="fas fa-plus"></i> Try to Add Location
                    </button>
                    <button class="btn btn-warning w-100 test-button" onclick="openLocationManagement()">
                        <i class="fas fa-external-link-alt"></i> Open Location Management
                    </button>
                    <div id="locationTestResult"></div>
                </div>
            </div>
        </div>

        <!-- Test Results Log -->
        <div class="row">
            <div class="col-12">
                <div class="test-section">
                    <h4><i class="fas fa-list"></i> Test Results Log</h4>
                    <div id="testLog" style="max-height: 400px; overflow-y: auto;"></div>
                    <button class="btn btn-secondary mt-2" onclick="clearLog()">
                        <i class="fas fa-trash"></i> Clear Log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getDatabase, ref, get, set, push } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBf96GNLhtz6FDdbLxIW9efh98WG__eQmk",
            authDomain: "merakicaptiveportal-firebasedb.firebaseapp.com",
            databaseURL: "https://merakicaptiveportal-firebasedb-default-rtdb.firebaseio.com",
            projectId: "merakicaptiveportal-firebasedb",
            storageBucket: "merakicaptiveportal-firebasedb.appspot.com",
            messagingSenderId: "899985637961",
            appId: "1:899985637961:web:9c00572c7fec3a671e3598",
            measurementId: "G-476KXB93TV"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentSubscription = null;

        // Make functions global
        window.checkGuestQuota = checkGuestQuota;
        window.checkLocationQuota = checkLocationQuota;
        window.testAddGuest = testAddGuest;
        window.testAddLocation = testAddLocation;
        window.openGuestManagement = openGuestManagement;
        window.openLocationManagement = openLocationManagement;
        window.clearLog = clearLog;

        function logResult(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logDiv.insertBefore(resultDiv, logDiv.firstChild);
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        async function checkGuestQuota() {
            if (!currentUser) {
                logResult('Please log in first', 'error');
                return;
            }

            try {
                logResult('Fetching guest quota...', 'info');

                // Get subscription
                const subSnapshot = await get(ref(db, `subscriptions/${currentUser.uid}`));
                const subscription = subSnapshot.val();

                if (!subscription) {
                    logResult('No subscription found - using default limits', 'error');
                    return;
                }

                // Count guests
                const guestsSnapshot = await get(ref(db, 'guests'));
                const allGuests = guestsSnapshot.val() || {};
                const guestCount = Object.keys(allGuests).length;

                const maxGuests = subscription.limits?.guestRecords || 500;
                const remaining = maxGuests === Infinity ? 'unlimited' : Math.max(0, maxGuests - guestCount);

                const quotaDiv = document.getElementById('guestQuotaDisplay');
                quotaDiv.innerHTML = `${guestCount} / ${maxGuests === Infinity ? '∞' : maxGuests}`;

                logResult(`Guest quota: ${guestCount} used, ${remaining} remaining`, 'success');

                if (remaining === 0 || remaining === '0') {
                    logResult('⚠️ Guest limit reached!', 'error');
                }
            } catch (error) {
                logResult(`Error checking guest quota: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function checkLocationQuota() {
            if (!currentUser) {
                logResult('Please log in first', 'error');
                return;
            }

            try {
                logResult('Fetching location quota...', 'info');

                // Get subscription
                const subSnapshot = await get(ref(db, `subscriptions/${currentUser.uid}`));
                const subscription = subSnapshot.val();

                if (!subscription) {
                    logResult('No subscription found - using default limits', 'error');
                    return;
                }

                const locationIds = subscription.locationIds || [];
                const maxLocations = subscription.limits?.locations || 1;
                const remaining = maxLocations === Infinity ? 'unlimited' : Math.max(0, maxLocations - locationIds.length);

                const quotaDiv = document.getElementById('locationQuotaDisplay');
                quotaDiv.innerHTML = `${locationIds.length} / ${maxLocations === Infinity ? '∞' : maxLocations}`;

                logResult(`Location quota: ${locationIds.length} used, ${remaining} remaining`, 'success');

                if (remaining === 0 || remaining === '0') {
                    logResult('⚠️ Location limit reached!', 'error');
                }
            } catch (error) {
                logResult(`Error checking location quota: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function testAddGuest() {
            if (!currentUser) {
                logResult('Please log in first', 'error');
                return;
            }

            try {
                logResult('Testing guest limit enforcement...', 'info');

                // Get subscription
                const subSnapshot = await get(ref(db, `subscriptions/${currentUser.uid}`));
                const subscription = subSnapshot.val();

                if (!subscription) {
                    logResult('No subscription found', 'error');
                    return;
                }

                // Count guests
                const guestsSnapshot = await get(ref(db, 'guests'));
                const allGuests = guestsSnapshot.val() || {};
                const guestCount = Object.keys(allGuests).length;

                const maxGuests = subscription.limits?.guestRecords || 500;
                const remaining = maxGuests === Infinity ? Infinity : Math.max(0, maxGuests - guestCount);

                logResult(`Current guest count: ${guestCount}/${maxGuests}`, 'info');

                if (remaining <= 0 && remaining !== Infinity) {
                    logResult('✅ LIMIT ENFORCED: Cannot add guest - limit reached', 'success');
                    Swal.fire({
                        title: 'Guest Limit Reached',
                        text: `Your tier allows ${maxGuests} guests. Please upgrade to add more.`,
                        icon: 'warning'
                    });
                } else {
                    logResult(`✅ Can add guest - ${remaining} slots remaining`, 'success');
                    Swal.fire({
                        title: 'Guest Limit Check',
                        text: `You can add guests. ${remaining === Infinity ? 'Unlimited' : remaining} slots remaining.`,
                        icon: 'success'
                    });
                }
            } catch (error) {
                logResult(`Error testing guest limit: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function testAddLocation() {
            if (!currentUser) {
                logResult('Please log in first', 'error');
                return;
            }

            try {
                logResult('Testing location limit enforcement...', 'info');

                // Get subscription
                const subSnapshot = await get(ref(db, `subscriptions/${currentUser.uid}`));
                const subscription = subSnapshot.val();

                if (!subscription) {
                    logResult('No subscription found', 'error');
                    return;
                }

                const locationIds = subscription.locationIds || [];
                const maxLocations = subscription.limits?.locations || 1;
                const remaining = maxLocations === Infinity ? Infinity : Math.max(0, maxLocations - locationIds.length);

                logResult(`Current location count: ${locationIds.length}/${maxLocations}`, 'info');

                if (remaining <= 0 && remaining !== Infinity) {
                    logResult('✅ LIMIT ENFORCED: Cannot add location - limit reached', 'success');
                    Swal.fire({
                        title: 'Location Limit Reached',
                        text: `Your tier allows ${maxLocations} locations. Please upgrade to add more.`,
                        icon: 'warning'
                    });
                } else {
                    logResult(`✅ Can add location - ${remaining} slots remaining`, 'success');
                    Swal.fire({
                        title: 'Location Limit Check',
                        text: `You can add locations. ${remaining === Infinity ? 'Unlimited' : remaining} slots remaining.`,
                        icon: 'success'
                    });
                }
            } catch (error) {
                logResult(`Error testing location limit: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function openGuestManagement() {
            window.open('/guest-management.html', '_blank');
        }

        function openLocationManagement() {
            window.open('/user-dashboard.html', '_blank');
        }

        // Initialize auth listener
        onAuthStateChanged(auth, async (user) => {
            const authStatus = document.getElementById('authStatus');
            const subscriptionInfo = document.getElementById('subscriptionInfo');

            if (user) {
                currentUser = user;
                authStatus.className = 'result success';
                authStatus.innerHTML = `<i class="fas fa-check-circle"></i> Logged in as: ${user.email}`;

                // Get subscription info
                try {
                    const subSnapshot = await get(ref(db, `subscriptions/${user.uid}`));
                    currentSubscription = subSnapshot.val();

                    if (currentSubscription) {
                        const tierName = currentSubscription.tierId || 'unknown';
                        subscriptionInfo.innerHTML = `
                            <div class="result info mt-2">
                                <strong>Subscription Tier:</strong> ${tierName.toUpperCase()}<br>
                                <strong>Guest Limit:</strong> ${currentSubscription.limits?.guestRecords || 'N/A'}<br>
                                <strong>Location Limit:</strong> ${currentSubscription.limits?.locations || 'N/A'}
                            </div>
                        `;

                        logResult(`Logged in as ${user.email} (${tierName} tier)`, 'success');
                    } else {
                        subscriptionInfo.innerHTML = `<div class="result error mt-2">No subscription found</div>`;
                        logResult('No subscription found for user', 'error');
                    }

                    // Auto-load quotas
                    await checkGuestQuota();
                    await checkLocationQuota();
                } catch (error) {
                    console.error('Error loading subscription:', error);
                    subscriptionInfo.innerHTML = `<div class="result error mt-2">Error loading subscription</div>`;
                    logResult(`Error loading subscription: ${error.message}`, 'error');
                }
            } else {
                currentUser = null;
                authStatus.className = 'result error';
                authStatus.innerHTML = `<i class="fas fa-times-circle"></i> Not logged in. <a href="/user-login.html">Log in</a>`;
                subscriptionInfo.innerHTML = '';
                logResult('User not authenticated', 'error');
            }
        });
    </script>
</body>
</html>
