<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature #21: Test Subscription Tier Gating</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- SweetAlert2 -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.4/dist/sweetalert2.min.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 30px 0;
    }

    .test-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .test-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 30px;
      margin-bottom: 20px;
    }

    .tier-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
    }

    .tier-free { background: #6c757d; color: white; }
    .tier-starter { background: #0dcaf0; color: white; }
    .tier-professional { background: #0d6efd; color: white; }
    .tier-enterprise { background: #6f42c1; color: white; }

    .feature-test-btn {
      margin: 10px 5px;
      min-width: 200px;
    }

    .test-result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }

    .test-result.success {
      background: #d1e7dd;
      border: 1px solid #a3cfbb;
      color: #0f5132;
      display: block;
    }

    .test-result.error {
      background: #f8d7da;
      border: 1px solid #f1aeb5;
      color: #842029;
      display: block;
    }

    .test-result.info {
      background: #cfe2ff;
      border: 1px solid #9ec5fe;
      color: #084298;
      display: block;
    }

    .feature-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }

    .feature-available {
      border-left: 4px solid #198754;
    }

    .feature-locked {
      border-left: 4px solid #dc3545;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <!-- Header -->
    <div class="test-card">
      <h1><i class="fas fa-shield-alt"></i> Feature #21: Subscription Tier Gating Test</h1>
      <p class="lead">Verify that features are correctly gated based on subscription tier</p>
      <p><strong>Test Objective:</strong> Ensure that Free tier users cannot access Professional+ features like OCR receipt processing</p>
    </div>

    <!-- Current User Info -->
    <div class="test-card">
      <h3>Current User Information</h3>
      <div id="userInfo">
        <p><i class="fas fa-spinner fa-spin"></i> Loading user information...</p>
      </div>
    </div>

    <!-- Tier Management -->
    <div class="test-card">
      <h3>Tier Management</h3>
      <p>Change your subscription tier to test feature access control:</p>
      <div class="btn-group" role="group">
        <button class="btn btn-secondary" onclick="changeTier('free')">
          <i class="fas fa-user"></i> Free Tier
        </button>
        <button class="btn btn-info" onclick="changeTier('starter')">
          <i class="fas fa-rocket"></i> Starter Tier
        </button>
        <button class="btn btn-primary" onclick="changeTier('professional')">
          <i class="fas fa-briefcase"></i> Professional Tier
        </button>
        <button class="btn btn-dark" onclick="changeTier('enterprise')">
          <i class="fas fa-crown"></i> Enterprise Tier
        </button>
      </div>
      <div id="tierChangeResult" class="test-result"></div>
    </div>

    <!-- Feature Access Tests -->
    <div class="test-card">
      <h3>Feature Access Tests</h3>
      <p>Test access to tier-gated features:</p>

      <div class="row">
        <div class="col-md-6">
          <button class="btn btn-outline-primary feature-test-btn" onclick="testFeatureAccess('receiptProcessingManual')">
            <i class="fas fa-receipt"></i> Manual Receipt Entry (Free+)
          </button>
        </div>
        <div class="col-md-6">
          <button class="btn btn-outline-primary feature-test-btn" onclick="testFeatureAccess('receiptProcessingOCR')">
            <i class="fas fa-scanner"></i> OCR Receipt Processing (Professional+)
          </button>
        </div>
        <div class="col-md-6">
          <button class="btn btn-outline-primary feature-test-btn" onclick="testFeatureAccess('foodCostBasic')">
            <i class="fas fa-utensils"></i> Food Cost Management (Professional+)
          </button>
        </div>
        <div class="col-md-6">
          <button class="btn btn-outline-primary feature-test-btn" onclick="testFeatureAccess('campaignsAdvanced')">
            <i class="fas fa-bullhorn"></i> Advanced Campaigns (Professional+)
          </button>
        </div>
        <div class="col-md-6">
          <button class="btn btn-outline-primary feature-test-btn" onclick="testFeatureAccess('multiLocation')">
            <i class="fas fa-map-marker-alt"></i> Multi-Location (Starter+)
          </button>
        </div>
        <div class="col-md-6">
          <button class="btn btn-outline-primary feature-test-btn" onclick="testFeatureAccess('bookingManagement')">
            <i class="fas fa-calendar"></i> Booking Management (Free+)
          </button>
        </div>
      </div>

      <div id="featureTestResult" class="test-result"></div>
    </div>

    <!-- All Available Features -->
    <div class="test-card">
      <h3>All Available Features for Current Tier</h3>
      <button class="btn btn-success" onclick="showAllAvailableFeatures()">
        <i class="fas fa-list"></i> Show All Available Features
      </button>
      <div id="allFeaturesResult"></div>
    </div>

    <!-- Test Results Summary -->
    <div class="test-card">
      <h3>Test Results Summary</h3>
      <div id="testSummary">
        <p class="text-muted">Run tests to see results summary</p>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.4/dist/sweetalert2.all.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { auth, rtdb, ref, get, set, update } from './js/config/firebase-config.js';
    import { featureAccessControl } from './js/modules/access-control/services/feature-access-control.js';
    import { subscriptionService } from './js/modules/access-control/services/subscription-service.js';

    // Store test results
    let testResults = [];

    // Wait for auth
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        document.getElementById('userInfo').innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            You must be logged in to test tier gating.
            <a href="login.html">Login here</a>
          </div>
        `;
        return;
      }

      await loadUserInfo();
    });

    async function loadUserInfo() {
      const user = auth.currentUser;
      if (!user) return;

      try {
        const subscription = await featureAccessControl.getCurrentUserSubscription();

        let tierClass = 'tier-free';
        let tierName = 'Free';

        if (subscription && subscription.tierId) {
          tierName = subscription.tierId.charAt(0).toUpperCase() + subscription.tierId.slice(1);
          tierClass = `tier-${subscription.tierId}`;
        }

        document.getElementById('userInfo').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>User ID:</strong> ${user.uid}</p>
              <p><strong>Email:</strong> ${user.email}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Current Tier:</strong> <span class="tier-badge ${tierClass}">${tierName}</span></p>
              <p><strong>Trial Status:</strong> ${subscription?.isTrial ? 'Yes' : 'No'}</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading user info:', error);
        document.getElementById('userInfo').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> Error loading user info: ${error.message}
          </div>
        `;
      }
    }

    // Change tier function
    window.changeTier = async function(tierId) {
      const user = auth.currentUser;
      if (!user) {
        showResult('tierChangeResult', 'error', 'Must be logged in to change tier');
        return;
      }

      try {
        showResult('tierChangeResult', 'info', `Changing tier to ${tierId}...`);

        // Get tier details
        const tierDetails = subscriptionService.getTierDetails(tierId);
        if (!tierDetails) {
          showResult('tierChangeResult', 'error', `Tier ${tierId} not found`);
          return;
        }

        // Update subscription in database
        const now = Date.now();
        const subscriptionData = {
          tierId: tierId,
          startDate: now,
          renewalDate: now + (30 * 24 * 60 * 60 * 1000),
          status: 'active',
          paymentStatus: 'active',
          features: { ...tierDetails.features },
          limits: { ...tierDetails.limits },
          history: {
            [now]: {
              action: 'tier_change_test',
              tierId: tierId,
              timestamp: now
            }
          }
        };

        await set(ref(rtdb, `subscriptions/${user.uid}`), subscriptionData);

        // Clear cache
        featureAccessControl.clearCache();
        featureAccessControl.clearSessionCache();

        // Reload user info
        await loadUserInfo();

        showResult('tierChangeResult', 'success', `Successfully changed to ${tierId} tier! Refresh the page or test features.`);

        // Add to test results
        testResults.push({
          action: 'Tier Change',
          tier: tierId,
          success: true,
          timestamp: new Date().toLocaleTimeString()
        });
        updateTestSummary();

      } catch (error) {
        console.error('Error changing tier:', error);
        showResult('tierChangeResult', 'error', `Error changing tier: ${error.message}`);
      }
    };

    // Test feature access
    window.testFeatureAccess = async function(featureId) {
      const user = auth.currentUser;
      if (!user) {
        showResult('featureTestResult', 'error', 'Must be logged in to test features');
        return;
      }

      try {
        showResult('featureTestResult', 'info', `Testing access to ${featureId}...`);

        // Clear caches to ensure fresh check
        featureAccessControl.clearCache();
        featureAccessControl.clearSessionCache();

        const result = await featureAccessControl.checkFeatureAccess(featureId);

        if (result.hasAccess) {
          showResult('featureTestResult', 'success', `
            <strong>Access Granted!</strong><br>
            Feature: ${result.feature.name}<br>
            Description: ${result.feature.description}<br>
            Your Tier: ${result.tier.name}
          `);

          testResults.push({
            action: 'Feature Test',
            feature: featureId,
            result: 'GRANTED',
            tier: result.tier.name,
            timestamp: new Date().toLocaleTimeString()
          });
        } else {
          const currentSub = await featureAccessControl.getCurrentUserSubscription();
          showResult('featureTestResult', 'error', `
            <strong>Access Denied!</strong><br>
            Feature: ${result.feature.name}<br>
            Description: ${result.feature.description}<br>
            Your Tier: ${currentSub?.tier?.name || 'Unknown'}<br>
            <em>This feature is not available in your current subscription tier.</em>
          `);

          testResults.push({
            action: 'Feature Test',
            feature: featureId,
            result: 'DENIED',
            tier: currentSub?.tier?.name || 'Unknown',
            timestamp: new Date().toLocaleTimeString()
          });
        }

        updateTestSummary();

      } catch (error) {
        console.error('Error testing feature access:', error);
        showResult('featureTestResult', 'error', `Error testing feature: ${error.message}`);
      }
    };

    // Show all available features
    window.showAllAvailableFeatures = async function() {
      const user = auth.currentUser;
      if (!user) {
        document.getElementById('allFeaturesResult').innerHTML = `
          <div class="alert alert-warning mt-3">Must be logged in</div>
        `;
        return;
      }

      try {
        const subscription = await featureAccessControl.getCurrentUserSubscription();
        const availableFeatures = await featureAccessControl.getAvailableFeatures();

        let html = `<div class="mt-3">`;
        html += `<h5>Current Tier: ${subscription?.tier?.name || 'Unknown'}</h5>`;
        html += `<p>You have access to ${availableFeatures.length} features:</p>`;

        if (availableFeatures.length === 0) {
          html += `<div class="alert alert-info">No features available</div>`;
        } else {
          availableFeatures.forEach(feature => {
            html += `
              <div class="feature-card feature-available">
                <strong><i class="${feature.icon}"></i> ${feature.name}</strong><br>
                <small class="text-muted">${feature.description}</small>
              </div>
            `;
          });
        }

        html += `</div>`;
        document.getElementById('allFeaturesResult').innerHTML = html;

      } catch (error) {
        console.error('Error loading features:', error);
        document.getElementById('allFeaturesResult').innerHTML = `
          <div class="alert alert-danger mt-3">Error loading features: ${error.message}</div>
        `;
      }
    };

    // Helper to show result messages
    function showResult(elementId, type, message) {
      const element = document.getElementById(elementId);
      element.className = `test-result ${type}`;
      element.innerHTML = message;
    }

    // Update test summary
    function updateTestSummary() {
      const summaryElement = document.getElementById('testSummary');

      if (testResults.length === 0) {
        summaryElement.innerHTML = '<p class="text-muted">No tests run yet</p>';
        return;
      }

      let html = `<table class="table table-sm">
        <thead>
          <tr>
            <th>Time</th>
            <th>Action</th>
            <th>Details</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody>`;

      testResults.slice(-10).reverse().forEach(test => {
        const resultClass = test.success ? 'text-success' : test.result === 'GRANTED' ? 'text-success' : 'text-danger';
        const resultText = test.success ? '✓ Success' : test.result === 'GRANTED' ? '✓ Granted' : '✗ Denied';

        html += `
          <tr>
            <td>${test.timestamp}</td>
            <td>${test.action}</td>
            <td>${test.tier || test.feature || '-'}</td>
            <td class="${resultClass}"><strong>${resultText}</strong></td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      summaryElement.innerHTML = html;
    }

    // Make functions globally available
    window.featureAccessControl = featureAccessControl;
    window.subscriptionService = subscriptionService;
  </script>
</body>
</html>
