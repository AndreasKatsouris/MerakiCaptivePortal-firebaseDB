<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Guest Name Consistency - Admin Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-consistent { background-color: #d4edda; color: #155724; }
        .status-inconsistent { background-color: #f8d7da; color: #721c24; }
        .status-error { background-color: #fff3cd; color: #856404; }
        .inconsistency-card {
            border-left: 4px solid #dc3545;
            margin-bottom: 1rem;
        }
        .progress-container {
            margin: 1rem 0;
        }
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        .log-info { background-color: #cff4fc; color: #055160; }
        .log-success { background-color: #d1e7dd; color: #0f5132; }
        .log-warning { background-color: #fff3cd; color: #664d03; }
        .log-error { background-color: #f8d7da; color: #842029; }
        .results-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.5rem;
            padding: 2rem;
            margin: 2rem 0;
        }
        .btn-fix {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
        }
        .btn-fix:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            color: white;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            visibility: visible;
        }
        .loading-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1><i class="fas fa-sync-alt"></i> Guest Name Consistency Tool</h1>
                    <p class="lead">Detect and fix guest name inconsistencies across related records</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5>Verifying Admin Access...</h5>
            <p class="text-muted">Please wait while we authenticate your credentials</p>
        </div>
    </div>

    <div class="container">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Total Guests</h5>
                        <h2 class="card-text" id="totalGuestsCount">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">Consistent</h5>
                        <h2 class="card-text" id="consistentCount">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">Inconsistent</h5>
                        <h2 class="card-text" id="inconsistentCount">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-danger">Errors</h5>
                        <h2 class="card-text" id="errorsCount">-</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="scanInconsistencies()">
                        <i class="fas fa-search"></i> Scan for Inconsistencies
                    </button>
                    <button class="btn btn-fix" onclick="fixAllInconsistencies()" disabled id="fixAllBtn">
                        <i class="fas fa-magic"></i> Fix All Inconsistencies
                    </button>
                    <button class="btn btn-warning" onclick="fixSpecificGuest()">
                        <i class="fas fa-user-edit"></i> Fix Specific Guest
                    </button>
                    <button class="btn btn-info" onclick="exportReport()">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                    <button class="btn btn-secondary" onclick="clearLogs()">
                        <i class="fas fa-eraser"></i> Clear Logs
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress">
                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="text-center mt-2">
                <span id="progressText">Processing...</span>
            </div>
        </div>

        <!-- Log Output -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Process Log</h5>
                    </div>
                    <div class="card-body">
                        <div class="log-container" id="logContainer">
                            <div class="log-entry log-info">Ready to scan for inconsistencies...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inconsistencies List -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Detected Inconsistencies</h5>
                    </div>
                    <div class="card-body">
                        <div id="inconsistenciesList">
                            <div class="text-muted text-center">
                                <i class="fas fa-search fa-3x mb-3"></i>
                                <p>Click "Scan for Inconsistencies" to detect issues</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Summary -->
        <div id="resultsSummary" style="display: none;">
            <!-- Results will be injected here -->
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    

    

    
    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        // Import Firebase modules using the same pattern as working admin tools
        import { auth, onAuthStateChanged, rtdb, ref, get, set, update } from '../js/config/firebase-config.js';
        
        // Global variables for tracking
        let currentUser = null;
        let inconsistencies = [];
        let scanResults = {
            totalGuests: 0,
            consistent: 0,
            inconsistent: 0,
            errors: 0
        };

        // Initialize authentication using the same pattern as working tools
        onAuthStateChanged(auth, async (user) => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            if (!user) {
                log('Not authenticated. Please log in first.', 'error');
                setTimeout(() => {
                    window.location.href = '../admin-login.html';
                }, 2000);
                return;
            }
            
            currentUser = user;
            log('Authentication successful - ready to use tool', 'success');
            loadingOverlay.classList.add('hidden');
        });

        // Logging functions
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        window.clearLogs = function() {
            document.getElementById('logContainer').innerHTML = 
                '<div class="log-entry log-info">Logs cleared - ready for new scan...</div>';
        }

        // Update progress bar
        function updateProgress(current, total, message) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            const percentage = Math.round((current / total) * 100);
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${message} (${current}/${total})`;
            
            if (current === total) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 1000);
            } else {
                progressContainer.style.display = 'block';
            }
        }

        // Update status counters
        function updateStatusCounters() {
            document.getElementById('totalGuestsCount').textContent = scanResults.totalGuests;
            document.getElementById('consistentCount').textContent = scanResults.consistent;
            document.getElementById('inconsistentCount').textContent = scanResults.inconsistent;
            document.getElementById('errorsCount').textContent = scanResults.errors;
            
            // Enable fix button if there are inconsistencies
            const fixBtn = document.getElementById('fixAllBtn');
            fixBtn.disabled = inconsistencies.length === 0;
        }

        // Phone number normalization function
        function normalizePhoneNumber(phoneNumber) {
            if (!phoneNumber) return '';
            return phoneNumber.replace(/^(whatsapp:|tel:)/, '').replace(/\s+/g, '');
        }

        // Scan for inconsistencies
        window.scanInconsistencies = async function() {
            log('Starting inconsistency scan...', 'info');
            
            try {
                // Reset counters
                scanResults = { totalGuests: 0, consistent: 0, inconsistent: 0, errors: 0 };
                inconsistencies = [];
                
                // Get all guests
                const guestsSnapshot = await get(ref(rtdb, 'guests'));
                const guests = guestsSnapshot.val() || {};
                const guestEntries = Object.entries(guests);
                
                scanResults.totalGuests = guestEntries.length;
                log(`Found ${guestEntries.length} guests to scan`, 'info');
                
                // Get all rewards and receipts data
                const [rewardsSnapshot, receiptsSnapshot] = await Promise.all([
                    get(ref(rtdb, 'rewards')),
                    get(ref(rtdb, 'receipts'))
                ]);
                
                const rewards = rewardsSnapshot.val() || {};
                const receipts = receiptsSnapshot.val() || {};
                
                let processed = 0;
                
                // Process each guest
                for (const [phoneNumber, guestData] of guestEntries) {
                    try {
                        processed++;
                        updateProgress(processed, guestEntries.length, 'Scanning guest');
                        
                        if (!guestData.name || guestData.name.trim() === '') {
                            log(`Skipping guest ${phoneNumber} - no name`, 'warning');
                            continue;
                        }
                        
                        const inconsistentRecords = [];
                        
                        // Check rewards
                        Object.entries(rewards).forEach(([rewardId, reward]) => {
                            if (reward.guestPhone === phoneNumber) {
                                if (reward.guestName !== guestData.name) {
                                    inconsistentRecords.push({
                                        type: 'reward',
                                        id: rewardId,
                                        currentName: reward.guestName,
                                        expectedName: guestData.name,
                                        collection: 'rewards'
                                    });
                                }
                            }
                        });
                        
                        // Check receipts
                        Object.entries(receipts).forEach(([receiptId, receipt]) => {
                            if (receipt.guestPhoneNumber === phoneNumber && receipt.guestName) {
                                if (receipt.guestName !== guestData.name) {
                                    inconsistentRecords.push({
                                        type: 'receipt',
                                        id: receiptId,
                                        currentName: receipt.guestName,
                                        expectedName: guestData.name,
                                        collection: 'receipts'
                                    });
                                }
                            }
                        });
                        
                        if (inconsistentRecords.length > 0) {
                            inconsistencies.push({
                                phoneNumber,
                                guestName: guestData.name,
                                inconsistentRecords
                            });
                            scanResults.inconsistent++;
                            log(`Found ${inconsistentRecords.length} inconsistencies for ${guestData.name}`, 'warning');
                        } else {
                            scanResults.consistent++;
                        }
                        
                    } catch (error) {
                        scanResults.errors++;
                        log(`Error scanning guest ${phoneNumber}: ${error.message}`, 'error');
                    }
                }
                
                log(`Scan complete: ${scanResults.consistent} consistent, ${scanResults.inconsistent} inconsistent, ${scanResults.errors} errors`, 'success');
                
                // Update UI
                updateStatusCounters();
                displayInconsistencies();
                
            } catch (error) {
                log(`Scan failed: ${error.message}`, 'error');
                console.error('Scan error:', error);
            }
        }

        // Display inconsistencies
        function displayInconsistencies() {
            const container = document.getElementById('inconsistenciesList');
            
            if (inconsistencies.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-success">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <h4>No Inconsistencies Found!</h4>
                        <p>All guest names are consistent across all records.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            inconsistencies.forEach((inconsistency, index) => {
                html += `
                    <div class="inconsistency-card card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        <i class="fas fa-user"></i> ${inconsistency.guestName}
                                        <small class="text-muted">(${inconsistency.phoneNumber})</small>
                                    </h6>
                                    <p class="card-text">
                                        <strong>Issues found:</strong> ${inconsistency.inconsistentRecords.length} records
                                    </p>
                                    <div class="row">
                                        ${inconsistency.inconsistentRecords.map(record => `
                                            <div class="col-md-6 mb-2">
                                                <div class="alert alert-warning p-2 mb-1">
                                                    <small>
                                                        <strong>${record.type.toUpperCase()}</strong> ${record.id.substring(0, 8)}...<br>
                                                        Current: "${record.currentName}"<br>
                                                        Expected: "${record.expectedName}"
                                                    </small>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-sm btn-fix" onclick="fixSpecificInconsistency(${index})">
                                        <i class="fas fa-magic"></i> Fix This Guest
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Fix specific inconsistency
        window.fixSpecificInconsistency = async function(index) {
            const inconsistency = inconsistencies[index];
            
            try {
                log(`Fixing inconsistency for ${inconsistency.guestName}...`, 'info');
                
                const updates = {};
                
                // Prepare updates for each inconsistent record
                inconsistency.inconsistentRecords.forEach(record => {
                    updates[`${record.collection}/${record.id}/guestName`] = inconsistency.guestName;
                    updates[`${record.collection}/${record.id}/lastCascadeUpdate`] = Date.now();
                });
                
                // Apply updates
                await update(ref(rtdb), updates);
                
                log(`Fixed ${inconsistency.inconsistentRecords.length} records for ${inconsistency.guestName}`, 'success');
                
                // Remove from inconsistencies list
                inconsistencies.splice(index, 1);
                scanResults.inconsistent--;
                scanResults.consistent++;
                
                // Update UI
                updateStatusCounters();
                displayInconsistencies();
                
            } catch (error) {
                log(`Failed to fix inconsistency: ${error.message}`, 'error');
                console.error('Fix error:', error);
            }
        }

        // Fix all inconsistencies
        window.fixAllInconsistencies = async function() {
            if (inconsistencies.length === 0) {
                Swal.fire('No Issues', 'No inconsistencies found to fix.', 'info');
                return;
            }
            
            const result = await Swal.fire({
                title: 'Fix All Inconsistencies?',
                text: `This will fix ${inconsistencies.length} guests with inconsistent names. Are you sure?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Fix All',
                cancelButtonText: 'Cancel'
            });
            
            if (!result.isConfirmed) return;
            
            try {
                log('Starting batch fix of all inconsistencies...', 'info');
                
                let fixed = 0;
                const total = inconsistencies.length;
                
                for (const inconsistency of [...inconsistencies]) {
                    try {
                        const updates = {};
                        
                        // Prepare updates for each inconsistent record
                        inconsistency.inconsistentRecords.forEach(record => {
                            updates[`${record.collection}/${record.id}/guestName`] = inconsistency.guestName;
                            updates[`${record.collection}/${record.id}/lastCascadeUpdate`] = Date.now();
                        });
                        
                        // Apply updates
                        await update(ref(rtdb), updates);
                        
                        fixed++;
                        updateProgress(fixed, total, 'Fixing inconsistencies');
                        
                        log(`Fixed ${inconsistency.inconsistentRecords.length} records for ${inconsistency.guestName}`, 'success');
                        
                    } catch (error) {
                        log(`Failed to fix ${inconsistency.guestName}: ${error.message}`, 'error');
                    }
                }
                
                // Clear inconsistencies and update counters
                const previousInconsistent = inconsistencies.length;
                inconsistencies = [];
                scanResults.inconsistent = 0;
                scanResults.consistent = scanResults.totalGuests - scanResults.errors;
                
                updateStatusCounters();
                displayInconsistencies();
                
                log(`Batch fix complete: ${fixed} guests fixed`, 'success');
                
                // Show results
                showResults(`Fixed ${fixed} out of ${previousInconsistent} inconsistent guests.`);
                
            } catch (error) {
                log(`Batch fix failed: ${error.message}`, 'error');
                console.error('Batch fix error:', error);
            }
        }

        // Fix specific guest by phone number
        window.fixSpecificGuest = async function() {
            const { value: phoneNumber } = await Swal.fire({
                title: 'Fix Specific Guest',
                input: 'text',
                inputLabel: 'Guest Phone Number',
                inputPlaceholder: 'Enter phone number (e.g., +27827001116)',
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return 'You need to enter a phone number!';
                    }
                }
            });
            
            if (!phoneNumber) return;
            
            try {
                const normalizedPhone = normalizePhoneNumber(phoneNumber);
                
                // Get guest data
                const guestSnapshot = await get(ref(rtdb, `guests/${normalizedPhone}`));
                const guestData = guestSnapshot.val();
                
                if (!guestData) {
                    Swal.fire('Not Found', 'Guest not found with that phone number.', 'error');
                    return;
                }
                
                if (!guestData.name) {
                    Swal.fire('Invalid Guest', 'Guest has no name to fix.', 'error');
                    return;
                }
                
                log(`Fixing specific guest: ${guestData.name} (${normalizedPhone})`, 'info');
                
                // Use the cascade function from the main application
                const result = await cascadeGuestNameUpdate(normalizedPhone, guestData.name, guestData.name);
                
                if (result.success) {
                    const totalUpdated = result.updatedRecords.rewards + result.updatedRecords.receipts + result.updatedRecords.other;
                    
                    log(`Fixed ${totalUpdated} records for ${guestData.name}`, 'success');
                    
                    await Swal.fire({
                        title: 'Fix Complete',
                        html: `
                            <div class="text-start">
                                <p><strong>Guest:</strong> ${guestData.name}</p>
                                <p><strong>Records updated:</strong></p>
                                <ul>
                                    <li>Rewards: ${result.updatedRecords.rewards}</li>
                                    <li>Receipts: ${result.updatedRecords.receipts}</li>
                                    <li>Other: ${result.updatedRecords.other}</li>
                                </ul>
                            </div>
                        `,
                        icon: 'success'
                    });
                } else {
                    log(`Failed to fix ${guestData.name}: ${result.errors.join(', ')}`, 'error');
                    Swal.fire('Fix Failed', result.errors.join(', '), 'error');
                }
                
            } catch (error) {
                log(`Error fixing specific guest: ${error.message}`, 'error');
                Swal.fire('Error', `Failed to fix guest: ${error.message}`, 'error');
            }
        }

        // Show results summary
        function showResults(message) {
            const resultsContainer = document.getElementById('resultsSummary');
            resultsContainer.innerHTML = `
                <div class="results-summary">
                    <div class="row">
                        <div class="col-md-8">
                            <h4><i class="fas fa-check-circle"></i> Fix Complete</h4>
                            <p>${message}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light" onclick="exportReport()">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.style.display = 'block';
        }

        // Export report
        window.exportReport = function() {
            const report = {
                timestamp: new Date().toISOString(),
                scanResults: scanResults,
                inconsistencies: inconsistencies,
                logEntries: Array.from(document.querySelectorAll('.log-entry')).map(entry => entry.textContent)
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `guest-name-consistency-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('Report exported successfully', 'success');
        }

        // Cascade update function (copied from main application)
        async function cascadeGuestNameUpdate(phoneNumber, oldName, newName) {
            console.log('ðŸ”„ Starting cascading guest name update:', { phoneNumber, oldName, newName });
            
            const results = {
                success: false,
                errors: [],
                updatedRecords: {
                    rewards: 0,
                    receipts: 0,
                    other: 0
                },
                details: []
            };
            
            try {
                // Step 1: Update rewards
                const rewardsSnapshot = await get(ref(rtdb, 'rewards'));
                const rewardsData = rewardsSnapshot.val() || {};
                
                const rewardUpdates = {};
                let rewardUpdateCount = 0;
                
                Object.entries(rewardsData).forEach(([rewardId, reward]) => {
                    if (reward.guestPhone === phoneNumber && reward.guestName !== newName) {
                        rewardUpdates[`rewards/${rewardId}/guestName`] = newName;
                        rewardUpdates[`rewards/${rewardId}/lastCascadeUpdate`] = Date.now();
                        rewardUpdateCount++;
                    }
                });
                
                if (rewardUpdateCount > 0) {
                    await update(ref(rtdb), rewardUpdates);
                    results.updatedRecords.rewards = rewardUpdateCount;
                }
                
                // Step 2: Update receipts
                const receiptsSnapshot = await get(ref(rtdb, 'receipts'));
                const receiptsData = receiptsSnapshot.val() || {};
                
                const receiptUpdates = {};
                let receiptUpdateCount = 0;
                
                Object.entries(receiptsData).forEach(([receiptId, receipt]) => {
                    if (receipt.guestPhoneNumber === phoneNumber && receipt.guestName && receipt.guestName !== newName) {
                        receiptUpdates[`receipts/${receiptId}/guestName`] = newName;
                        receiptUpdates[`receipts/${receiptId}/lastCascadeUpdate`] = Date.now();
                        receiptUpdateCount++;
                    }
                });
                
                if (receiptUpdateCount > 0) {
                    await update(ref(rtdb), receiptUpdates);
                    results.updatedRecords.receipts = receiptUpdateCount;
                }
                
                // Mark as successful
                results.success = true;
                return results;
                
            } catch (error) {
                results.errors.push(error.message);
                return results;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('Ready to scan for inconsistencies...', 'info');
        });
    </script>
</body>
</html> 