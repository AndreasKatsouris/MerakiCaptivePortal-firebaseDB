<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Integrity Repair Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .repair-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .issue-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
        }
        .fixed-item {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .data-preview {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .success-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="display-4">Data Integrity Repair Tool</h1>
                <p class="lead">Fix data validation issues before proceeding with database migration.</p>
                
                <div class="warning-box">
                    <h5><i class="fas fa-exclamation-triangle"></i> Important</h5>
                    <p>This tool will repair common data integrity issues found during migration validation:</p>
                    <ul>
                        <li><strong>Missing selectedLocationId</strong> - Will infer from the location path</li>
                        <li><strong>Missing stockItems</strong> - Will create empty structure if needed</li>
                        <li><strong>Invalid timestamps</strong> - Will fix or regenerate timestamps</li>
                        <li><strong>Missing location names</strong> - Will populate from location data</li>
                    </ul>
                </div>

                <!-- Step 1: Analyze Issues -->
                <div class="repair-section">
                    <h3><i class="fas fa-search text-primary"></i> Step 1: Analyze Data Issues</h3>
                    <p>Scan the database to identify specific data integrity problems.</p>
                    <button class="btn btn-primary" onclick="analyzeDataIssues()">
                        <i class="fas fa-search"></i> Analyze Issues
                    </button>
                    <div id="analysisResults" class="mt-3"></div>
                </div>

                <!-- Step 2: Preview Repairs -->
                <div class="repair-section">
                    <h3><i class="fas fa-tools text-warning"></i> Step 2: Preview Repairs</h3>
                    <p>See what changes will be made before applying them.</p>
                    <button class="btn btn-warning" onclick="previewRepairs()" disabled id="previewBtn">
                        <i class="fas fa-eye"></i> Preview Repairs
                    </button>
                    <div id="previewResults" class="mt-3"></div>
                </div>

                <!-- Step 3: Apply Repairs -->
                <div class="repair-section">
                    <h3><i class="fas fa-wrench text-success"></i> Step 3: Apply Repairs</h3>
                    <p>Apply the data integrity fixes to the database.</p>
                    
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="dryRunMode" checked>
                        <label class="form-check-label" for="dryRunMode">
                            Dry run mode (preview only, don't make changes)
                        </label>
                    </div>
                    
                    <button class="btn btn-success" onclick="applyRepairs()" disabled id="repairBtn">
                        <i class="fas fa-wrench"></i> Apply Repairs
                    </button>
                    <div id="repairResults" class="mt-3"></div>
                </div>

                <!-- Step 4: Verify Repairs -->
                <div class="repair-section">
                    <h3><i class="fas fa-check-circle text-info"></i> Step 4: Verify Repairs</h3>
                    <p>Validate that all issues have been resolved.</p>
                    <button class="btn btn-info" onclick="verifyRepairs()" disabled id="verifyBtn">
                        <i class="fas fa-check-circle"></i> Verify Repairs
                    </button>
                    <div id="verifyResults" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { auth, rtdb, ref, get, set, update, onAuthStateChanged } from '../js/config/firebase-config.js';

        let analysisData = null;
        let repairPlan = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    alert('Please login as an admin to use this repair tool');
                    window.location.href = '/admin-login.html';
                    return;
                }
                
                checkAdminPermissions(user);
            });
        });

        async function checkAdminPermissions(user) {
            try {
                const adminRef = ref(rtdb, `admins/${user.uid}`);
                const snapshot = await get(adminRef);
                
                if (!snapshot.exists()) {
                    alert('Admin permissions required for data repair');
                    window.location.href = '/admin-dashboard.html';
                    return;
                }
                
                console.log('Admin permissions verified');
            } catch (error) {
                console.error('Error checking admin permissions:', error);
                alert('Error verifying permissions: ' + error.message);
            }
        }

        // Step 1: Analyze Data Issues
        window.analyzeDataIssues = async function() {
            const output = document.getElementById('analysisResults');
            output.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Analyzing data issues...';
            
            try {
                const issues = [];
                const locations = {};
                
                // Get all locations first
                const locationsRef = ref(rtdb, 'locations');
                const locationsSnapshot = await get(locationsRef);
                
                if (locationsSnapshot.exists()) {
                    Object.assign(locations, locationsSnapshot.val());
                }
                
                // Analyze stock data in each location
                for (const [locationId, locationData] of Object.entries(locations)) {
                    const stockUsageRef = ref(rtdb, `locations/${locationId}/stockUsage`);
                    const stockSnapshot = await get(stockUsageRef);
                    
                    if (stockSnapshot.exists()) {
                        const stockData = stockSnapshot.val();
                        
                        for (const [timestamp, record] of Object.entries(stockData)) {
                            const recordPath = `locations/${locationId}/stockUsage/${timestamp}`;
                            
                            // Check for missing selectedLocationId
                            if (!record.selectedLocationId) {
                                issues.push({
                                    type: 'missing_selectedLocationId',
                                    path: recordPath,
                                    locationId: locationId,
                                    timestamp: timestamp,
                                    fix: `Set selectedLocationId to "${locationId}"`
                                });
                            }
                            
                            // Check for missing stockItems
                            if (!record.stockItems) {
                                issues.push({
                                    type: 'missing_stockItems',
                                    path: recordPath,
                                    locationId: locationId,
                                    timestamp: timestamp,
                                    fix: 'Create empty stockItems structure'
                                });
                            }
                            
                            // Check for missing storeName
                            if (!record.storeName || record.storeName === 'Store') {
                                const properName = locationData.name || locationData.displayName || 'Unknown Location';
                                issues.push({
                                    type: 'missing_storeName',
                                    path: recordPath,
                                    locationId: locationId,
                                    timestamp: timestamp,
                                    currentName: record.storeName || 'undefined',
                                    fix: `Set storeName to "${properName}"`
                                });
                            }
                            
                            // Check for invalid timestamps
                            if (!record.timestamp || isNaN(record.timestamp)) {
                                issues.push({
                                    type: 'invalid_timestamp',
                                    path: recordPath,
                                    locationId: locationId,
                                    timestamp: timestamp,
                                    fix: `Set timestamp to ${timestamp} (from path)`
                                });
                            }
                        }
                    }
                }
                
                analysisData = { issues, locations };
                
                // Display results
                let html = '<div class="success-box">';
                html += `<h6>Analysis Complete</h6>`;
                html += `<p><strong>Total Issues Found:</strong> ${issues.length}</p>`;
                html += '</div>';
                
                if (issues.length > 0) {
                    // Group issues by type
                    const issuesByType = {};
                    issues.forEach(issue => {
                        if (!issuesByType[issue.type]) {
                            issuesByType[issue.type] = [];
                        }
                        issuesByType[issue.type].push(issue);
                    });
                    
                    html += '<h6>Issues by Type:</h6>';
                    for (const [type, typeIssues] of Object.entries(issuesByType)) {
                        html += `<div class="alert alert-warning">`;
                        html += `<strong>${type.replace(/_/g, ' ').toUpperCase()}:</strong> ${typeIssues.length} issues<br>`;
                        html += `<small>Example: ${typeIssues[0].fix}</small>`;
                        html += `</div>`;
                    }
                    
                    html += '<h6>Sample Issues (first 10):</h6>';
                    html += '<div class="data-preview">';
                    issues.slice(0, 10).forEach(issue => {
                        html += `<div class="issue-item">`;
                        html += `<strong>${issue.type}</strong>: ${issue.path}<br>`;
                        html += `<small>Fix: ${issue.fix}</small>`;
                        html += `</div>`;
                    });
                    if (issues.length > 10) {
                        html += `<div class="text-muted">... and ${issues.length - 10} more issues</div>`;
                    }
                    html += '</div>';
                    
                    // Enable preview button
                    document.getElementById('previewBtn').disabled = false;
                } else {
                    html += '<div class="alert alert-success">üéâ No data integrity issues found!</div>';
                }
                
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = `<div class="alert alert-danger">Analysis failed: ${error.message}</div>`;
                console.error('Analysis error:', error);
            }
        };

        // Step 2: Preview Repairs
        window.previewRepairs = async function() {
            const output = document.getElementById('previewResults');
            output.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Generating repair plan...';
            
            try {
                if (!analysisData || !analysisData.issues.length) {
                    output.innerHTML = '<div class="alert alert-warning">No issues to repair. Run analysis first.</div>';
                    return;
                }
                
                const repairs = [];
                
                for (const issue of analysisData.issues) {
                    const repair = {
                        path: issue.path,
                        type: issue.type,
                        locationId: issue.locationId,
                        timestamp: issue.timestamp
                    };
                    
                    switch (issue.type) {
                        case 'missing_selectedLocationId':
                            repair.update = { selectedLocationId: issue.locationId };
                            break;
                            
                        case 'missing_stockItems':
                            repair.update = { stockItems: {} };
                            break;
                            
                        case 'missing_storeName':
                            const locationData = analysisData.locations[issue.locationId];
                            const properName = locationData?.name || locationData?.displayName || 'Unknown Location';
                            repair.update = { storeName: properName };
                            break;
                            
                        case 'invalid_timestamp':
                            repair.update = { timestamp: parseInt(issue.timestamp) };
                            break;
                    }
                    
                    repairs.push(repair);
                }
                
                repairPlan = repairs;
                
                // Display preview
                let html = '<div class="success-box">';
                html += `<h6>Repair Plan Generated</h6>`;
                html += `<p><strong>Total Repairs:</strong> ${repairs.length}</p>`;
                html += '</div>';
                
                // Group repairs by type
                const repairsByType = {};
                repairs.forEach(repair => {
                    if (!repairsByType[repair.type]) {
                        repairsByType[repair.type] = [];
                    }
                    repairsByType[repair.type].push(repair);
                });
                
                html += '<h6>Repairs by Type:</h6>';
                for (const [type, typeRepairs] of Object.entries(repairsByType)) {
                    html += `<div class="alert alert-info">`;
                    html += `<strong>${type.replace(/_/g, ' ').toUpperCase()}:</strong> ${typeRepairs.length} repairs<br>`;
                    html += `<small>Will update: ${Object.keys(typeRepairs[0].update).join(', ')}</small>`;
                    html += `</div>`;
                }
                
                html += '<h6>Sample Repairs (first 10):</h6>';
                html += '<div class="data-preview">';
                repairs.slice(0, 10).forEach(repair => {
                    html += `<div class="issue-item">`;
                    html += `<strong>${repair.type}</strong>: ${repair.path}<br>`;
                    html += `<small>Update: ${JSON.stringify(repair.update)}</small>`;
                    html += `</div>`;
                });
                if (repairs.length > 10) {
                    html += `<div class="text-muted">... and ${repairs.length - 10} more repairs</div>`;
                }
                html += '</div>';
                
                output.innerHTML = html;
                
                // Enable repair button
                document.getElementById('repairBtn').disabled = false;
                
            } catch (error) {
                output.innerHTML = `<div class="alert alert-danger">Preview failed: ${error.message}</div>`;
                console.error('Preview error:', error);
            }
        };

        // Step 3: Apply Repairs
        window.applyRepairs = async function() {
            const output = document.getElementById('repairResults');
            const isDryRun = document.getElementById('dryRunMode').checked;
            
            output.innerHTML = `<div class="spinner-border spinner-border-sm"></div> ${isDryRun ? 'Simulating' : 'Applying'} repairs...`;
            
            try {
                if (!repairPlan || !repairPlan.length) {
                    output.innerHTML = '<div class="alert alert-warning">No repair plan available. Run preview first.</div>';
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                for (const repair of repairPlan) {
                    try {
                        if (!isDryRun) {
                            const recordRef = ref(rtdb, repair.path);
                            await update(recordRef, repair.update);
                        }
                        successCount++;
                    } catch (error) {
                        errorCount++;
                        errors.push({
                            path: repair.path,
                            error: error.message
                        });
                    }
                }
                
                let html = `<div class="${isDryRun ? 'alert alert-info' : 'alert alert-success'}">`;
                html += `<h6>${isDryRun ? 'Repair Simulation' : 'Repairs'} Complete</h6>`;
                html += `<p><strong>Successful:</strong> ${successCount}</p>`;
                html += `<p><strong>Failed:</strong> ${errorCount}</p>`;
                html += `<p><strong>Success Rate:</strong> ${((successCount / (successCount + errorCount)) * 100).toFixed(1)}%</p>`;
                html += '</div>';
                
                if (errors.length > 0) {
                    html += '<h6>Errors:</h6>';
                    html += '<div class="data-preview">';
                    errors.slice(0, 5).forEach(error => {
                        html += `<div class="issue-item">`;
                        html += `<strong>Error:</strong> ${error.path}<br>`;
                        html += `<small>${error.error}</small>`;
                        html += `</div>`;
                    });
                    if (errors.length > 5) {
                        html += `<div class="text-muted">... and ${errors.length - 5} more errors</div>`;
                    }
                    html += '</div>';
                }
                
                output.innerHTML = html;
                
                if (!isDryRun && errorCount < successCount * 0.1) {
                    // Enable verify button if repairs were mostly successful
                    document.getElementById('verifyBtn').disabled = false;
                }
                
            } catch (error) {
                output.innerHTML = `<div class="alert alert-danger">Repair failed: ${error.message}</div>`;
                console.error('Repair error:', error);
            }
        };

        // Step 4: Verify Repairs
        window.verifyRepairs = async function() {
            const output = document.getElementById('verifyResults');
            output.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Verifying repairs...';
            
            try {
                // Re-run the analysis to check if issues are fixed
                await analyzeDataIssues();
                
                if (analysisData && analysisData.issues.length === 0) {
                    output.innerHTML = `
                        <div class="success-box">
                            <h6>üéâ Verification Successful!</h6>
                            <p>All data integrity issues have been resolved.</p>
                            <p><strong>Next Steps:</strong></p>
                            <ul>
                                <li>Return to the Database Migration Tool</li>
                                <li>Re-run Step 2 (Validate Data Integrity)</li>
                                <li>Proceed with Step 3 (Enable Dual-Write Mode)</li>
                            </ul>
                            <a href="database-structure-migration.html" class="btn btn-primary">
                                <i class="fas fa-arrow-left"></i> Return to Migration Tool
                            </a>
                        </div>
                    `;
                } else {
                    output.innerHTML = `
                        <div class="alert alert-warning">
                            <h6>‚ö†Ô∏è Some Issues Remain</h6>
                            <p>${analysisData.issues.length} issues still need to be addressed.</p>
                            <p>You may need to run the repair process again or manually fix remaining issues.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                output.innerHTML = `<div class="alert alert-danger">Verification failed: ${error.message}</div>`;
                console.error('Verification error:', error);
            }
        };
    </script>
</body>
</html> 