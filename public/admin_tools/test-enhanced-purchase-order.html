<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Purchase Order Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Enhanced Purchase Order Test</h1>
        <p>Test the enhanced Advanced Purchase Order functionality for Ocean Basket Brits.</p>
        
        <div class="card">
            <div class="card-body">
                <h5>Test Enhanced Advanced Purchase Order</h5>
                <p>This test simulates the exact workflow that happens when you click "Advanced Purchase Order" in the Food Cost Analytics.</p>
                <button id="testBtn" class="btn btn-primary">Test Advanced Purchase Order</button>
                <div id="results" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, rtdb, ref, get, onAuthStateChanged } from '../js/config/firebase-config.js';

        document.getElementById('testBtn').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="spinner-border"></div> Testing Enhanced Advanced Purchase Order...';
            
            try {
                console.log('=== ENHANCED ADVANCED PURCHASE ORDER TEST ===');
                
                const locationId = '-OSKL7AJj6ErxYy3jgpD';
                let html = '<h6>Enhanced Advanced Purchase Order Test Results:</h6>';
                
                // Step 1: Load location data
                const locationRef = ref(rtdb, `locations/${locationId}`);
                const locationSnapshot = await get(locationRef);
                
                if (!locationSnapshot.exists()) {
                    html += `<div class="alert alert-danger">‚ùå Location not found</div>`;
                    resultsDiv.innerHTML = html;
                    return;
                }
                
                const locationData = locationSnapshot.val();
                html += `<div class="alert alert-success">‚úÖ Location: ${locationData.name}</div>`;
                
                // Step 2: Create mock stock data (similar to what would be loaded in Food Cost Analytics)
                const mockStockData = [
                    {
                        itemCode: '10851',
                        description: 'amstel',
                        category: 'Beer & Ciders',
                        supplierName: 'Test Supplier',
                        unitCost: 11.51,
                        closingQty: 11,
                        usagePerDay: 0.07,
                        reorderPoint: 10.6
                    },
                    {
                        itemCode: '10001',
                        description: 'test item',
                        category: 'Test Category',
                        supplierName: 'Test Supplier',
                        unitCost: 5.00,
                        closingQty: 20,
                        usagePerDay: 0.5,
                        reorderPoint: 15
                    }
                ];
                
                html += `<div class="alert alert-info">üì¶ Mock stock data: ${mockStockData.length} items</div>`;
                
                // Step 3: Test the Advanced Purchase Order Generator (the actual function called)
                try {
                    const { generateAdvancedPurchaseOrder } = await import('../js/modules/food-cost/order-calculator-advanced.js');
                    
                    console.log('Testing with Location ID:', locationId);
                    console.log('Testing with Location Name:', locationData.name);
                    
                    // Test with location ID (this is what the Purchase Order modal would use)
                    const storeIdentifier = locationId; // This simulates selectedLocationId || storeName
                    const supplierFilter = 'All Suppliers';
                    const params = {
                        daysToNextDelivery: 7,
                        safetyStockPercentage: 20,
                        criticalItemBuffer: 30,
                        lookbackDays: 30
                    };
                    
                    console.log('Calling generateAdvancedPurchaseOrder with:', {
                        storeIdentifier,
                        supplierFilter,
                        params,
                        stockDataCount: mockStockData.length
                    });
                    
                    const purchaseOrderItems = await generateAdvancedPurchaseOrder(
                        mockStockData,
                        storeIdentifier,
                        supplierFilter,
                        params
                    );
                    
                    html += `<div class="alert alert-success">üéØ <strong>Advanced Purchase Order Generated!</strong></div>`;
                    html += `<div class="alert alert-info">üìã Purchase Order Items: ${purchaseOrderItems.length}</div>`;
                    
                    if (purchaseOrderItems.length > 0) {
                        html += `<div class="alert alert-success">‚úÖ <strong>SUCCESS!</strong> Advanced Purchase Order is working with enhanced location matching.</div>`;
                        
                        // Show details of items that were processed
                        const itemsWithHistory = purchaseOrderItems.filter(item => item.calculationType === 'advanced');
                        const itemsWithoutHistory = purchaseOrderItems.filter(item => item.calculationType === 'basic');
                        
                        html += `<div class="alert alert-primary">üìä Items with historical data: ${itemsWithHistory.length}</div>`;
                        html += `<div class="alert alert-warning">üìä Items using basic calculation: ${itemsWithoutHistory.length}</div>`;
                        
                        if (itemsWithHistory.length > 0) {
                            html += `<div class="alert alert-success">üéâ <strong>Historical data found and used!</strong> The location matching fix is working.</div>`;
                        }
                        
                        // Show sample item details
                        if (purchaseOrderItems.length > 0) {
                            const sampleItem = purchaseOrderItems[0];
                            html += `<div class="card mt-3">`;
                            html += `<div class="card-header"><strong>Sample Item Details</strong></div>`;
                            html += `<div class="card-body">`;
                            html += `<p><strong>Item:</strong> ${sampleItem.itemCode} - ${sampleItem.description}</p>`;
                            html += `<p><strong>Order Quantity:</strong> ${sampleItem.orderQuantity}</p>`;
                            html += `<p><strong>Calculation Type:</strong> ${sampleItem.calculationType}</p>`;
                            if (sampleItem.historicalInsights) {
                                html += `<p><strong>Historical Insights:</strong> Available ‚úÖ</p>`;
                            }
                            html += `</div></div>`;
                        }
                    } else {
                        html += `<div class="alert alert-warning">‚ö†Ô∏è No items need reordering, but the Advanced Purchase Order function executed successfully.</div>`;
                    }
                    
                } catch (advancedPOError) {
                    html += `<div class="alert alert-danger">‚ùå Advanced Purchase Order Error: ${advancedPOError.message}</div>`;
                    console.error('Advanced PO Error:', advancedPOError);
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                console.error('Test error:', error);
            }
        });

        // Auto-login check
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                document.getElementById('results').innerHTML = '<div class="alert alert-warning">Please login first</div>';
            }
        });
    </script>
</body>
</html> 