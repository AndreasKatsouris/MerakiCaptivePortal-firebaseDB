<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Analytics Data Generator (Admin)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Test Analytics Data Generator</h1>
        
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">User Status</h5>
                        <div id="userStatus" class="mb-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            Checking authentication...
                        </div>
                        
                        <div class="btn-group" role="group">
                            <button id="generateData" class="btn btn-primary" disabled>Generate Test Data</button>
                            <button id="viewAnalytics" class="btn btn-success">View Analytics</button>
                            <button id="clearData" class="btn btn-danger" disabled>Clear All Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="status" class="alert alert-info" style="display: none;"></div>
        
        <div id="dataPreview" class="mt-4"></div>
    </div>

    <script type="module">
        import { auth, rtdb, ref, set, get, remove, onAuthStateChanged } from '../js/config/firebase-config.js';
        
        const statusDiv = document.getElementById('status');
        const previewDiv = document.getElementById('dataPreview');
        const userStatusDiv = document.getElementById('userStatus');
        const generateBtn = document.getElementById('generateData');
        const clearBtn = document.getElementById('clearData');
        
        let currentUser = null;
        let isAdmin = false;
        
        function showStatus(message, type = 'info') {
            statusDiv.className = `alert alert-${type}`;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
        }
        
        // Check authentication status
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // Check if user has admin privileges
                const idTokenResult = await user.getIdTokenResult();
                isAdmin = idTokenResult.claims.admin === true;
                
                userStatusDiv.innerHTML = `
                    <p class="mb-1"><strong>Logged in as:</strong> ${user.email}</p>
                    <p class="mb-0"><strong>Status:</strong> <span class="badge ${isAdmin ? 'bg-success' : 'bg-secondary'}">${isAdmin ? 'Admin' : 'Regular User'}</span></p>
                `;
                
                generateBtn.disabled = false;
                clearBtn.disabled = false;
                
                if (!isAdmin) {
                    showStatus(`
                        <strong>Note:</strong> You're logged in as a regular user. 
                        The data will be generated with your user ID, and you'll need access to the locations.
                        If you encounter permission errors, try logging in as an admin user.
                    `, 'warning');
                }
            } else {
                userStatusDiv.innerHTML = `
                    <p class="text-danger mb-0">Not authenticated</p>
                    <a href="../admin-login.html" class="btn btn-sm btn-primary mt-2">Login</a>
                `;
                generateBtn.disabled = true;
                clearBtn.disabled = true;
                showStatus('You must be logged in to use this tool.', 'danger');
            }
        });
        
        async function generateTestData() {
            try {
                showStatus('Generating test data with sales information...');
                
                if (!currentUser) {
                    showStatus('You must be logged in to generate test data!', 'danger');
                    return;
                }
                
                const locations = ['Dsh2J0dz3O8N4F7', 'TestLocation123'];
                const categories = ['Seafood', 'Beverages', 'Dairy', 'Vegetables', 'Meat'];
                const costCenters = ['Main Kitchen', 'Bar', 'Prep Kitchen', 'Bakery'];
                
                // If not admin, ensure user has access to these locations
                if (!isAdmin) {
                    showStatus('Setting up location access for regular user...', 'info');
                    for (const locationId of locations) {
                        const userLocationRef = ref(rtdb, `userLocations/${currentUser.uid}/${locationId}`);
                        await set(userLocationRef, {
                            name: locationId === 'Dsh2J0dz3O8N4F7' ? 'Ocean Basket V&A' : 'Test Location',
                            role: 'manager',
                            addedAt: Date.now()
                        });
                    }
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const locationId of locations) {
                    const numDays = 7;
                    
                    for (let day = 0; day < numDays; day++) {
                        const date = new Date();
                        date.setDate(date.getDate() - day);
                        const timestamp = date.getTime();
                        
                        // Generate random sales between 5000 and 10000
                        const salesAmount = 5000 + Math.random() * 5000;
                        
                        // Generate stock items
                        const stockItems = {};
                        const numItems = 20 + Math.floor(Math.random() * 10);
                        let totalCost = 0;
                        
                        for (let i = 0; i < numItems; i++) {
                            const itemId = `item_${i}`;
                            const category = categories[Math.floor(Math.random() * categories.length)];
                            const costCenter = costCenters[Math.floor(Math.random() * costCenters.length)];
                            const unitCost = 5 + Math.random() * 45; // 5 to 50
                            const usage = 10 + Math.random() * 90; // 10 to 100 units
                            const costOfUsage = unitCost * usage;
                            totalCost += costOfUsage;
                            
                            stockItems[itemId] = {
                                itemName: `${category} Item ${i}`,
                                category: category,
                                costCenter: costCenter,
                                unit: 'kg',
                                unitCost: unitCost,
                                openingQty: 100 + Math.random() * 100,
                                purchaseQty: Math.random() * 50,
                                closingQty: 50 + Math.random() * 100,
                                usage: usage,
                                costOfUsage: costOfUsage
                            };
                        }
                        
                        // Create the stock usage record with sales data
                        const stockUsageData = {
                            timestamp: timestamp,
                            userId: currentUser.uid, // Required by database rules
                            selectedLocationId: locationId,
                            storeName: locationId === 'Dsh2J0dz3O8N4F7' ? 'Ocean Basket V&A' : 'Test Location',
                            stockItems: stockItems,
                            totals: {
                                totalCostOfUsage: totalCost,
                                totalItems: numItems
                            },
                            // Add various sales data formats to test fallbacks
                            salesData: {
                                total: salesAmount,
                                salesTotal: salesAmount,
                                date: date.toISOString()
                            },
                            salesAmount: salesAmount,
                            salesTotal: salesAmount,
                            metadata: {
                                createdAt: timestamp,
                                createdBy: 'test-generator',
                                userEmail: currentUser.email,
                                isAdmin: isAdmin
                            }
                        };
                        
                        try {
                            // Save to root path
                            const rootRef = ref(rtdb, `stockUsage/${timestamp}`);
                            await set(rootRef, stockUsageData);
                            
                            // Save to location-specific path
                            const locationRef = ref(rtdb, `locations/${locationId}/stockUsage/${timestamp}`);
                            await set(locationRef, stockUsageData);
                            
                            successCount++;
                        } catch (error) {
                            console.error(`Error saving data for ${locationId} on ${date.toDateString()}:`, error);
                            errorCount++;
                        }
                    }
                }
                
                if (errorCount > 0) {
                    showStatus(`
                        Generated test data with some errors:<br>
                        ✅ Success: ${successCount} records<br>
                        ❌ Failed: ${errorCount} records<br>
                        <small>Check the console for error details.</small>
                    `, 'warning');
                } else {
                    showStatus(`
                        ✅ Test data generated successfully!<br>
                        Created ${successCount} records for ${locations.length} locations.
                    `, 'success');
                }
                
                await previewData();
                
            } catch (error) {
                showStatus(`Error generating data: ${error.message}`, 'danger');
                console.error('Full error:', error);
            }
        }
        
        async function previewData() {
            try {
                const snapshot = await get(ref(rtdb, 'stockUsage'));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const entries = Object.entries(data).slice(-3).reverse(); // Get last 3 records
                    
                    let html = '<h3>Data Preview (Latest 3 Records)</h3>';
                    html += '<div class="row">';
                    
                    entries.forEach(([key, record]) => {
                        const date = new Date(record.timestamp);
                        const foodCostPercentage = record.salesTotal > 0 
                            ? ((record.totals.totalCostOfUsage / record.salesTotal) * 100).toFixed(2)
                            : 0;
                        
                        html += `
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <strong>${date.toLocaleDateString()}</strong>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Location:</strong> ${record.storeName}</p>
                                        <p><strong>Sales Total:</strong> ${record.salesTotal.toFixed(2)}</p>
                                        <p><strong>Food Cost:</strong> ${record.totals.totalCostOfUsage.toFixed(2)}</p>
                                        <p><strong>Food Cost %:</strong> ${foodCostPercentage}%</p>
                                        <p><strong>Items:</strong> ${record.totals.totalItems}</p>
                                        <p><strong>Created by:</strong> ${record.metadata?.userEmail || 'Unknown'}</p>
                                        <details>
                                            <summary>Sales Data Fields</summary>
                                            <pre>${JSON.stringify({
                                                'salesData.total': record.salesData?.total,
                                                'salesData.salesTotal': record.salesData?.salesTotal,
                                                'salesAmount': record.salesAmount,
                                                'salesTotal': record.salesTotal
                                            }, null, 2)}</pre>
                                        </details>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    previewDiv.innerHTML = html;
                } else {
                    previewDiv.innerHTML = '<p class="text-muted">No data found in stockUsage.</p>';
                }
            } catch (error) {
                console.error('Error previewing data:', error);
                previewDiv.innerHTML = '<p class="text-danger">Error loading preview.</p>';
            }
        }
        
        async function clearData() {
            if (!confirm('Are you sure you want to clear all test data?')) {
                return;
            }
            
            try {
                showStatus('Clearing test data...');
                
                let clearedCount = 0;
                let errorCount = 0;
                
                // Get all stockUsage records
                const snapshot = await get(ref(rtdb, 'stockUsage'));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    for (const [key, record] of Object.entries(data)) {
                        // Only delete records created by current user or if admin
                        if (isAdmin || record.userId === currentUser.uid) {
                            try {
                                await remove(ref(rtdb, `stockUsage/${key}`));
                                
                                // Also remove from location-specific path
                                if (record.selectedLocationId) {
                                    await remove(ref(rtdb, `locations/${record.selectedLocationId}/stockUsage/${key}`));
                                }
                                
                                clearedCount++;
                            } catch (error) {
                                console.error(`Error deleting record ${key}:`, error);
                                errorCount++;
                            }
                        }
                    }
                }
                
                if (errorCount > 0) {
                    showStatus(`
                        Cleared data with some errors:<br>
                        ✅ Deleted: ${clearedCount} records<br>
                        ❌ Failed: ${errorCount} records
                    `, 'warning');
                } else {
                    showStatus(`✅ Successfully cleared ${clearedCount} records!`, 'success');
                }
                
                previewDiv.innerHTML = '';
                
            } catch (error) {
                showStatus(`Error clearing data: ${error.message}`, 'danger');
                console.error('Full error:', error);
            }
        }
        
        document.getElementById('generateData').addEventListener('click', generateTestData);
        document.getElementById('viewAnalytics').addEventListener('click', () => {
            window.open('/food-cost-analytics.html', '_blank');
        });
        document.getElementById('clearData').addEventListener('click', clearData);
        
        // Load preview on page load
        setTimeout(previewData, 1000);
    </script>
</body>
</html> 