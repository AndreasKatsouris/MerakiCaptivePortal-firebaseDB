<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix User Roles Utility</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Fix User Roles Utility</h1>
        <p>This utility will scan all users and ensure they have proper role assignments.</p>
        
        <div class="alert alert-warning">
            <strong>Note:</strong> You must be logged in as an admin to use this utility.
        </div>
        
        <button id="scanBtn" class="btn btn-primary">Scan and Fix User Roles</button>
        
        <div id="results" class="mt-4"></div>
    </div>

    <script type="module">
        import { auth, rtdb, ref, get, update, onAuthStateChanged } from '../js/config/firebase-config.js';
        
        const resultsDiv = document.getElementById('results');
        const scanBtn = document.getElementById('scanBtn');
        
        // Check auth state
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                resultsDiv.innerHTML = '<div class="alert alert-danger">Please login as an admin first.</div>';
                scanBtn.disabled = true;
                return;
            }
            
            console.log('Current user:', user.email, user.uid);
            
            // Check if user is admin
            const userSnapshot = await get(ref(rtdb, `users/${user.uid}`));
            const userData = userSnapshot.val();
            
            console.log('User data:', userData);
            
            if (!userData) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">User data not found. Creating admin profile...</div>';
                
                // If this is the first admin, create their profile
                const newAdminData = {
                    uid: user.uid,
                    email: user.email,
                    role: 'admin',
                    isAdmin: true,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                await update(ref(rtdb, `users/${user.uid}`), newAdminData);
                resultsDiv.innerHTML = '<div class="alert alert-success">Admin profile created. Ready to scan.</div>';
                return;
            }
            
            if (userData.role !== 'admin' && !userData.isAdmin) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        You must be an admin to use this utility.
                        <br>Current role: ${userData.role || 'undefined'}
                        <br>isAdmin: ${userData.isAdmin || 'undefined'}
                        <br>Email: ${user.email}
                    </div>
                `;
                scanBtn.disabled = true;
                return;
            }
            
            resultsDiv.innerHTML = '<div class="alert alert-success">Logged in as admin. Ready to scan.</div>';
        });
        
        scanBtn.addEventListener('click', async () => {
            scanBtn.disabled = true;
            resultsDiv.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Scanning...</span></div>';
            
            try {
                // Get all users
                const usersSnapshot = await get(ref(rtdb, 'users'));
                const users = usersSnapshot.val() || {};
                
                let fixedCount = 0;
                let adminCount = 0;
                let userCount = 0;
                let report = [];
                
                for (const [uid, userData] of Object.entries(users)) {
                    if (!userData.role) {
                        // Check if this is an admin based on other criteria
                        const isAdmin = userData.isAdmin === true || 
                                      userData.email?.includes('admin@') ||
                                      userData.permissions?.admin === true;
                        
                        const updates = {
                            role: isAdmin ? 'admin' : 'user',
                            updatedAt: Date.now()
                        };
                        
                        await update(ref(rtdb, `users/${uid}`), updates);
                        
                        report.push({
                            uid,
                            email: userData.email,
                            previousRole: 'undefined',
                            newRole: updates.role,
                            fixed: true
                        });
                        
                        fixedCount++;
                        if (updates.role === 'admin') adminCount++;
                        else userCount++;
                    } else {
                        report.push({
                            uid,
                            email: userData.email,
                            role: userData.role,
                            fixed: false
                        });
                        
                        if (userData.role === 'admin') adminCount++;
                        else if (userData.role === 'user') userCount++;
                    }
                }
                
                // Display results
                let html = `
                    <div class="alert alert-info">
                        <h5>Scan Complete</h5>
                        <p>Total users: ${Object.keys(users).length}</p>
                        <p>Fixed: ${fixedCount}</p>
                        <p>Admins: ${adminCount}</p>
                        <p>Regular users: ${userCount}</p>
                    </div>
                    
                    <h5>User Details</h5>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Previous Role</th>
                                <th>Current Role</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                for (const user of report) {
                    html += `
                        <tr>
                            <td>${user.email || 'N/A'}</td>
                            <td>${user.previousRole || user.role}</td>
                            <td><span class="badge bg-${user.role === 'admin' ? 'danger' : 'primary'}">${user.role || user.newRole}</span></td>
                            <td>${user.fixed ? '<span class="text-success">Fixed</span>' : '<span class="text-muted">OK</span>'}</td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error scanning users:', error);
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                scanBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
