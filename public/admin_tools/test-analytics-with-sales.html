<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Analytics with Sales Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Test Analytics with Sales Data</h1>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <button id="generateData" class="btn btn-primary">Generate Test Data with Sales</button>
                <button id="viewAnalytics" class="btn btn-success ms-2">View Analytics</button>
                <button id="clearData" class="btn btn-danger ms-2">Clear All Data</button>
            </div>
        </div>
        
        <div id="status" class="alert alert-info" style="display: none;"></div>
        
        <div id="dataPreview" class="mt-4"></div>
    </div>

    <script type="module">
        import { auth, rtdb, ref, set, get, remove } from '../js/config/firebase-config.js';
        
        const statusDiv = document.getElementById('status');
        const previewDiv = document.getElementById('dataPreview');
        
        function showStatus(message, type = 'info') {
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
        
        async function generateTestData() {
            try {
                showStatus('Generating test data with sales information...');
                
                // Check if user is authenticated
                const user = auth.currentUser;
                if (!user) {
                    showStatus('You must be logged in to generate test data!', 'danger');
                    return;
                }
                
                const locations = ['Dsh2J0dz3O8N4F7', 'TestLocation123'];
                const categories = ['Seafood', 'Beverages', 'Dairy', 'Vegetables', 'Meat'];
                const costCenters = ['Main Kitchen', 'Bar', 'Prep Kitchen', 'Bakery'];
                
                // First, ensure user has access to these locations
                for (const locationId of locations) {
                    const userLocationRef = ref(rtdb, `userLocations/${user.uid}/${locationId}`);
                    await set(userLocationRef, {
                        name: locationId === 'Dsh2J0dz3O8N4F7' ? 'Ocean Basket V&A' : 'Test Location',
                        role: 'manager',
                        addedAt: Date.now()
                    });
                }
                
                for (const locationId of locations) {
                    const numDays = 7;
                    
                    for (let day = 0; day < numDays; day++) {
                        const date = new Date();
                        date.setDate(date.getDate() - day);
                        const timestamp = date.getTime();
                        
                        // Generate random sales between 5000 and 10000
                        const salesAmount = 5000 + Math.random() * 5000;
                        
                        // Generate stock items
                        const stockItems = {};
                        const numItems = 20 + Math.floor(Math.random() * 10);
                        let totalCost = 0;
                        
                        for (let i = 0; i < numItems; i++) {
                            const itemId = `item_${i}`;
                            const category = categories[Math.floor(Math.random() * categories.length)];
                            const costCenter = costCenters[Math.floor(Math.random() * costCenters.length)];
                            const unitCost = 5 + Math.random() * 45; // 5 to 50
                            const usage = 10 + Math.random() * 90; // 10 to 100 units
                            const costOfUsage = unitCost * usage;
                            totalCost += costOfUsage;
                            
                            stockItems[itemId] = {
                                itemName: `${category} Item ${i}`,
                                category: category,
                                costCenter: costCenter,
                                unit: 'kg',
                                unitCost: unitCost,
                                openingQty: 100 + Math.random() * 100,
                                purchaseQty: Math.random() * 50,
                                closingQty: 50 + Math.random() * 100,
                                usage: usage,
                                costOfUsage: costOfUsage
                            };
                        }
                        
                        // Create the stock usage record with sales data
                        const stockUsageData = {
                            timestamp: timestamp,
                            userId: user.uid, // Required by database rules
                            selectedLocationId: locationId,
                            storeName: locationId === 'Dsh2J0dz3O8N4F7' ? 'Ocean Basket V&A' : 'Test Location',
                            stockItems: stockItems,
                            totals: {
                                totalCostOfUsage: totalCost,
                                totalItems: numItems
                            },
                            // Add various sales data formats to test fallbacks
                            salesData: {
                                total: salesAmount,
                                salesTotal: salesAmount,
                                date: date.toISOString()
                            },
                            salesAmount: salesAmount,
                            salesTotal: salesAmount,
                            metadata: {
                                createdAt: timestamp,
                                createdBy: 'test-generator',
                                userEmail: user.email
                            }
                        };
                        
                        // Save to both root and location-specific paths
                        const rootRef = ref(rtdb, `stockUsage/${timestamp}`);
                        await set(rootRef, stockUsageData);
                        
                        const locationRef = ref(rtdb, `locations/${locationId}/stockUsage/${timestamp}`);
                        await set(locationRef, stockUsageData);
                    }
                }
                
                showStatus(`Test data generated successfully! Created ${numDays} days of data for ${locations.length} locations.`, 'success');
                await previewData();
                
            } catch (error) {
                showStatus(`Error generating data: ${error.message}`, 'danger');
                console.error('Full error:', error);
            }
        }
        
        async function previewData() {
            try {
                const snapshot = await get(ref(rtdb, 'stockUsage'));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const entries = Object.entries(data).slice(0, 3);
                    
                    let html = '<h3>Data Preview (First 3 Records)</h3>';
                    html += '<div class="row">';
                    
                    entries.forEach(([key, record]) => {
                        const date = new Date(record.timestamp);
                        const foodCostPercentage = record.salesTotal > 0 
                            ? ((record.totals.totalCostOfUsage / record.salesTotal) * 100).toFixed(2)
                            : 0;
                        
                        html += `
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <strong>${date.toLocaleDateString()}</strong>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Location:</strong> ${record.storeName}</p>
                                        <p><strong>Sales Total:</strong> ${record.salesTotal.toFixed(2)}</p>
                                        <p><strong>Food Cost:</strong> ${record.totals.totalCostOfUsage.toFixed(2)}</p>
                                        <p><strong>Food Cost %:</strong> ${foodCostPercentage}%</p>
                                        <p><strong>Items:</strong> ${record.totals.totalItems}</p>
                                        <details>
                                            <summary>Sales Data Fields</summary>
                                            <pre>${JSON.stringify({
                                                'salesData.total': record.salesData?.total,
                                                'salesData.salesTotal': record.salesData?.salesTotal,
                                                'salesAmount': record.salesAmount,
                                                'salesTotal': record.salesTotal
                                            }, null, 2)}</pre>
                                        </details>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    previewDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Error previewing data:', error);
            }
        }
        
        async function clearData() {
            if (confirm('Are you sure you want to clear all test data?')) {
                try {
                    showStatus('Clearing test data...');
                    
                    // Clear root stockUsage
                    await remove(ref(rtdb, 'stockUsage'));
                    
                    // Clear location-specific data
                    const locations = ['Dsh2J0dz3O8N4F7', 'TestLocation123'];
                    for (const locationId of locations) {
                        await remove(ref(rtdb, `locations/${locationId}/stockUsage`));
                    }
                    
                    showStatus('All test data cleared!', 'success');
                    previewDiv.innerHTML = '';
                    
                } catch (error) {
                    showStatus(`Error clearing data: ${error.message}`, 'danger');
                }
            }
        }
        
        document.getElementById('generateData').addEventListener('click', generateTestData);
        document.getElementById('viewAnalytics').addEventListener('click', () => {
            window.open('/food-cost-analytics.html', '_blank');
        });
        document.getElementById('clearData').addEventListener('click', clearData);
        
        // Load preview on page load
        previewData();
    </script>
</body>
</html> 