<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Booking Management Access</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-calendar-check text-primary me-2"></i>
                    Booking Management Access Test
                </h1>
                
                <div class="card">
                    <div class="card-body">
                        <div id="loading" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Checking booking management access...</p>
                        </div>
                        
                        <div id="results" class="d-none">
                            <h5>Access Control Results:</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-user me-2"></i>Current Subscription</h6>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Tier:</strong> <span id="currentTier">Loading...</span></p>
                                            <p><strong>Status:</strong> <span id="subscriptionStatus">Loading...</span></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-calendar me-2"></i>Booking Features</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="bookingFeatures">Loading...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-chart-bar me-2"></i>Feature Access Details</h6>
                                </div>
                                <div class="card-body">
                                    <div id="allFeatures">Loading...</div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6>Quick Actions:</h6>
                                <button id="testBookingAccess" class="btn btn-primary me-2">
                                    <i class="fas fa-test me-1"></i>Test Booking Access
                                </button>
                                <a href="booking-management.html" class="btn btn-success me-2">
                                    <i class="fas fa-calendar-alt me-1"></i>Open Booking Management
                                </a>
                                <button id="refreshAccess" class="btn btn-outline-secondary">
                                    <i class="fas fa-refresh me-1"></i>Refresh Access
                                </button>
                            </div>
                        </div>
                        
                        <div id="error" class="d-none">
                            <div class="alert alert-danger">
                                <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                                <p id="errorMessage">An error occurred while checking access.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase Config -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC4qIaM5jVGWcUhvnvw9vUb0LGzY6wqX0A",
            authDomain: "meraki-captive-portal.firebaseapp.com",
            databaseURL: "https://meraki-captive-portal-default-rtdb.firebaseio.com",
            projectId: "meraki-captive-portal",
            storageBucket: "meraki-captive-portal.appspot.com",
            messagingSenderId: "727044321978",
            appId: "1:727044321978:web:abc123def456ghi789"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Make globally available
        window.firebase = { app, database, auth };
    </script>

    <script type="module">
        // Import access control services
        try {
            const { default: AccessControl } = await import('../js/modules/access-control/services/access-control-service.js');
            
            // Global access to AccessControl
            window.AccessControl = AccessControl;
            
            // Test booking management access
            async function testBookingAccess() {
                try {
                    document.getElementById('loading').classList.remove('d-none');
                    document.getElementById('results').classList.add('d-none');
                    document.getElementById('error').classList.add('d-none');
                    
                    // Get current subscription
                    const subscription = await AccessControl.getCurrentSubscription();
                    
                    // Check booking features
                    const bookingBasic = await AccessControl.canUseFeature('bookingManagement');
                    const bookingAdvanced = await AccessControl.canUseFeature('bookingAdvanced');
                    const bookingAnalytics = await AccessControl.canUseFeature('bookingAnalytics');
                    
                    // Get all features for debug
                    const allFeatures = await AccessControl.getAllFeatures();
                    
                    // Update UI
                    document.getElementById('currentTier').textContent = subscription?.tierId || 'free';
                    document.getElementById('subscriptionStatus').textContent = subscription?.paymentStatus || 'active';
                    
                    // Display booking features
                    const bookingFeaturesHtml = `
                        <div class="mb-2">
                            <i class="fas ${bookingBasic ? 'fa-check text-success' : 'fa-times text-danger'} me-2"></i>
                            Booking Management: <strong>${bookingBasic ? 'ENABLED' : 'DISABLED'}</strong>
                        </div>
                        <div class="mb-2">
                            <i class="fas ${bookingAdvanced ? 'fa-check text-success' : 'fa-times text-danger'} me-2"></i>
                            Advanced Booking: <strong>${bookingAdvanced ? 'ENABLED' : 'DISABLED'}</strong>
                        </div>
                        <div class="mb-2">
                            <i class="fas ${bookingAnalytics ? 'fa-check text-success' : 'fa-times text-danger'} me-2"></i>
                            Booking Analytics: <strong>${bookingAnalytics ? 'ENABLED' : 'DISABLED'}</strong>
                        </div>
                    `;
                    document.getElementById('bookingFeatures').innerHTML = bookingFeaturesHtml;
                    
                    // Display all features for debugging
                    let allFeaturesHtml = '<div class="row">';
                    Object.entries(allFeatures).forEach(([feature, enabled]) => {
                        if (feature.includes('booking') || feature.includes('qms') || feature.includes('analytics')) {
                            allFeaturesHtml += `
                                <div class="col-md-4 mb-2">
                                    <small>
                                        <i class="fas ${enabled ? 'fa-check text-success' : 'fa-times text-muted'} me-1"></i>
                                        ${feature}
                                    </small>
                                </div>
                            `;
                        }
                    });
                    allFeaturesHtml += '</div>';
                    document.getElementById('allFeatures').innerHTML = allFeaturesHtml;
                    
                    document.getElementById('loading').classList.add('d-none');
                    document.getElementById('results').classList.remove('d-none');
                    
                } catch (error) {
                    console.error('Error testing booking access:', error);
                    document.getElementById('errorMessage').textContent = error.message;
                    document.getElementById('loading').classList.add('d-none');
                    document.getElementById('error').classList.remove('d-none');
                }
            }
            
            // Event listeners
            document.getElementById('testBookingAccess').addEventListener('click', testBookingAccess);
            document.getElementById('refreshAccess').addEventListener('click', () => {
                AccessControl.resetCache();
                testBookingAccess();
            });
            
            // Run initial test
            testBookingAccess();
            
        } catch (error) {
            console.error('Failed to load access control:', error);
            document.getElementById('errorMessage').textContent = 'Failed to load access control services: ' + error.message;
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('error').classList.remove('d-none');
        }
    </script>
</body>
</html>