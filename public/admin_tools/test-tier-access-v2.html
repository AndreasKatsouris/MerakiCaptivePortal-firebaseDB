<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tier Access Control</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        .feature-test {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }
        
        .feature-test.access-granted {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .feature-test.access-denied {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .feature-icon {
            width: 40px;
            text-align: center;
            font-size: 1.2rem;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Tier Access Test</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="test-subscription-page.html">Back to Test Page</a>
                <a class="nav-link" href="../admin-dashboard.html">Admin Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-4">Test Tier & Feature Access Control</h1>
        
        <!-- User Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Current User Status</h5>
            </div>
            <div class="card-body" id="userStatus">
                <div class="alert alert-info">Loading user status...</div>
            </div>
        </div>
        
        <!-- Tier Switching -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Switch Tier (For Testing)</h5>
            </div>
            <div class="card-body" id="tierSwitchSection">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="switchTier('Free')">Free Tier</button>
                    <button class="btn btn-outline-primary" onclick="switchTier('Basic')">Basic Tier</button>
                    <button class="btn btn-outline-primary" onclick="switchTier('Professional')">Professional Tier</button>
                    <button class="btn btn-outline-primary" onclick="switchTier('Enterprise')">Enterprise Tier</button>
                </div>
                <button class="btn btn-warning ms-3" onclick="refreshStatus()">
                    <i class="fas fa-sync"></i> Refresh Status
                </button>
                <div class="mt-2 text-muted small">
                    <i class="fas fa-info-circle"></i> Note: Only admins can switch tiers for testing. Regular users should use the subscription page to upgrade.
                </div>
            </div>
        </div>
        
        <!-- Feature Access Tests -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Feature Access Tests</h5>
            </div>
            <div class="card-body" id="featureTests">
                <div class="alert alert-info">Running feature access tests...</div>
            </div>
        </div>
        
        <!-- Module Access Tests -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Module Access Tests</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary me-2" onclick="testFoodCostModule()">Test Food Cost Module</button>
                <button class="btn btn-primary" onclick="testAnalyticsModule()">Test Analytics Module</button>
                <div id="moduleTestResult" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Firebase Config -->
    <script type="module" src="js/config/firebase-config.js"></script>
    
    <!-- Test Script -->
    <script type="module">
        // Import Firebase utilities from firebase-config
        import { auth, rtdb, ref, get, set, update, onAuthStateChanged } from '../js/config/firebase-config.js';
        
        const database = rtdb; // Use rtdb alias
        
        // Import feature access control with error handling
        let featureAccessControl, platformFeatures;
        try {
            const featureModule = await import('./js/modules/access-control/services/feature-access-control.js');
            featureAccessControl = featureModule.featureAccessControl;
            
            const platformModule = await import('./js/modules/access-control/services/platform-features.js');
            platformFeatures = platformModule.platformFeatures || platformModule.default;
        } catch (error) {
            console.error('Error importing modules:', error);
            document.getElementById('userStatus').innerHTML = '<div class="alert alert-danger">Error loading modules: ' + error.message + '</div>';
        }
        
        window.rtdb = database;
        
        // Current user
        let currentUser = null;
        
        // Define global functions early
        window.switchTier = async function(newTier) {
            if (!currentUser) {
                alert('Please login first');
                return;
            }
            
            // Check if user is admin
            const userSnapshot = await get(ref(rtdb, `users/${currentUser.uid}`));
            const userData = userSnapshot.val();
            
            if (!userData || (userData.role !== 'admin' && !userData.isAdmin)) {
                alert('Only admins can switch tiers for testing. Regular users must use the subscription page to upgrade.');
                return;
            }
            
            try {
                const updates = {
                    tier: newTier,
                    updatedAt: Date.now()
                };
                
                await update(ref(rtdb, `subscriptions/${currentUser.uid}`), updates);
                
                // Clear cache and refresh
                featureAccessControl.clearCache();
                await loadUserStatus();
                await testFeatureAccess();
                
                alert(`Tier switched to ${newTier} successfully!`);
            } catch (error) {
                console.error('Error switching tier:', error);
                alert('Error switching tier: ' + error.message);
            }
        };
        
        // Refresh status
        window.refreshStatus = async function() {
            if (!featureAccessControl) {
                console.error('Feature access control not loaded');
                return;
            }
            
            featureAccessControl.clearCache();
            await loadUserStatus();
            await testFeatureAccess();
        };
        
        // Test Food Cost Module
        window.testFoodCostModule = async function() {
            if (!featureAccessControl) {
                Swal.fire('Error', 'Feature access control not loaded', 'error');
                return;
            }
            
            const hasAccess = await featureAccessControl.checkFeatureAccess('foodCostBasic');
            
            if (hasAccess) {
                document.getElementById('moduleTestResult').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Food Cost Module is accessible!
                        <hr>
                        <button class="btn btn-sm btn-success" onclick="window.open('admin-dashboard.html#foodCost', '_blank')">
                            Open Food Cost Module
                        </button>
                    </div>
                `;
            } else {
                await featureAccessControl.showUpgradePrompt('foodCostBasic');
                document.getElementById('moduleTestResult').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-lock"></i> Food Cost Module is locked for your current tier
                    </div>
                `;
            }
        };
        
        // Test Analytics Module
        window.testAnalyticsModule = async function() {
            if (!featureAccessControl) {
                Swal.fire('Error', 'Feature access control not loaded', 'error');
                return;
            }
            
            const hasAccess = await featureAccessControl.checkFeatureAccess('analyticsBasic');
            
            if (hasAccess) {
                document.getElementById('moduleTestResult').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Analytics Module is accessible!
                        <hr>
                        <button class="btn btn-sm btn-success" onclick="window.open('admin-dashboard.html#analytics', '_blank')">
                            Open Analytics Module
                        </button>
                    </div>
                `;
            } else {
                await featureAccessControl.showUpgradePrompt('analyticsBasic');
                document.getElementById('moduleTestResult').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-lock"></i> Analytics Module is locked for your current tier
                    </div>
                `;
            }
        };
        
        // Load user status
        async function loadUserStatus() {
            if (!featureAccessControl) {
                console.error('Feature access control not loaded');
                return;
            }
            
            try {
                const subscription = await featureAccessControl.getCurrentUserSubscription();
                const html = `
                    <div class="row">
                        <div class="col-md-6">
                            <strong>User ID:</strong> ${currentUser?.uid || 'Not logged in'}<br>
                            <strong>Email:</strong> ${currentUser?.email || 'N/A'}
                        </div>
                        <div class="col-md-6">
                            <strong>Current Tier:</strong> ${subscription?.tierName || 'None'}<br>
                            <strong>Status:</strong> <span class="badge bg-${subscription?.status === 'active' ? 'success' : 'secondary'}">${subscription?.status || 'No subscription'}</span>
                        </div>
                    </div>
                `;
                document.getElementById('userStatus').innerHTML = html;
            } catch (error) {
                console.error('Error loading user status:', error);
                document.getElementById('userStatus').innerHTML = '<div class="alert alert-danger">Error loading user status</div>';
            }
        }
        
        // Test feature access
        async function testFeatureAccess() {
            if (!featureAccessControl || !platformFeatures) {
                console.error('Feature access control or platform features not loaded');
                document.getElementById('featureTests').innerHTML = '<div class="alert alert-warning">Modules not loaded yet. Please refresh.</div>';
                return;
            }
            
            try {
                const features = platformFeatures.getAllFeatures ? platformFeatures.getAllFeatures() : Object.values(platformFeatures.PLATFORM_FEATURES || {});
                const testResults = [];
                
                for (const feature of features) {
                    const hasAccess = await featureAccessControl.checkFeatureAccess(feature.id);
                    testResults.push({
                        feature,
                        hasAccess
                    });
                }
                
                // Group by category
                const grouped = {};
                testResults.forEach(result => {
                    const category = result.feature.category;
                    if (!grouped[category]) {
                        grouped[category] = [];
                    }
                    grouped[category].push(result);
                });
                
                let html = '';
                for (const [category, results] of Object.entries(grouped)) {
                    html += `<h6 class="mt-3">${category}</h6>`;
                    results.forEach(({ feature, hasAccess }) => {
                        html += `
                            <div class="feature-test ${hasAccess ? 'access-granted' : 'access-denied'}">
                                <div class="d-flex align-items-center">
                                    <div class="feature-icon">
                                        <i class="${feature.icon}"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <strong>${feature.name}</strong><br>
                                        <small class="text-muted">${feature.description}</small>
                                    </div>
                                    <div>
                                        ${hasAccess ? 
                                            '<span class="badge bg-success">Accessible</span>' : 
                                            '<span class="badge bg-danger">Locked</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('featureTests').innerHTML = html;
            } catch (error) {
                console.error('Error testing feature access:', error);
                document.getElementById('featureTests').innerHTML = '<div class="alert alert-danger">Error testing features: ' + error.message + '</div>';
            }
        }
        
        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                console.log('User logged in:', user.email);
                // Check if modules are loaded
                if (!featureAccessControl || !platformFeatures) {
                    document.getElementById('userStatus').innerHTML = '<div class="alert alert-info">Loading modules... Please wait.</div>';
                    document.getElementById('featureTests').innerHTML = '<div class="alert alert-info">Loading modules... Please wait.</div>';
                    
                    // Retry after a short delay
                    setTimeout(() => {
                        if (featureAccessControl && platformFeatures) {
                            loadUserStatus();
                            testFeatureAccess();
                        }
                    }, 1000);
                } else {
                    await loadUserStatus();
                    await testFeatureAccess();
                }
            } else {
                console.log('No user logged in');
                // Show not logged in message with login button
                document.getElementById('userStatus').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Not logged in!</strong> 
                        <p>You need to be logged in to test tier access control.</p>
                                        <a href="../admin-login.html" class="btn btn-primary">Login as Admin</a>
                <a href="../user-login.html" class="btn btn-secondary">Login as User</a>
                    </div>
                `;
                document.getElementById('featureTests').innerHTML = `
                    <div class="alert alert-info">
                        Please log in to test feature access control.
                    </div>
                `;
                
                // Disable all buttons
                document.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                });
            }
        });
    </script>
</body>
</html>
