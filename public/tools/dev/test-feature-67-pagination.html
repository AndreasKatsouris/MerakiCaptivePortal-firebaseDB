<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature #67 - Pagination Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-pending { background: #ffc107; color: #000; }
        .status-running { background: #17a2b8; color: #fff; }
        .status-passed { background: #28a745; color: #fff; }
        .status-failed { background: #dc3545; color: #fff; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        .guest-card {
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Feature #67: Pagination Test</h1>

        <div class="alert alert-info">
            <strong>Test Objective:</strong> Verify that guest list pagination uses Firebase <code>limitToFirst()</code>
            to load data in pages rather than all at once.
        </div>

        <!-- Step 1: Create Test Guests -->
        <div class="test-section">
            <h3>Step 1: Create 25 Test Guests</h3>
            <p>Status: <span id="step1-status" class="status-badge status-pending">Pending</span></p>
            <button id="create-guests-btn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create 25 Test Guests
            </button>
            <div id="step1-output" class="mt-3"></div>
        </div>

        <!-- Step 2: Test Pagination (10 per page) -->
        <div class="test-section">
            <h3>Step 2: Test Pagination (10 per page)</h3>
            <p>Status: <span id="step2-status" class="status-badge status-pending">Pending</span></p>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label>Page Size:</label>
                    <input type="number" id="page-size" class="form-control" value="10" min="1" max="100">
                </div>
                <div class="col-md-4">
                    <label>Current Page:</label>
                    <input type="number" id="current-page" class="form-control" value="1" min="1" readonly>
                </div>
                <div class="col-md-4">
                    <label>Total Guests:</label>
                    <input type="number" id="total-guests" class="form-control" value="0" readonly>
                </div>
            </div>

            <div class="pagination-controls">
                <button id="first-page-btn" class="btn btn-secondary" disabled>
                    <i class="fas fa-step-backward"></i> First
                </button>
                <button id="prev-page-btn" class="btn btn-secondary" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button id="next-page-btn" class="btn btn-secondary" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
                <button id="load-page-btn" class="btn btn-primary">
                    <i class="fas fa-sync"></i> Load Page
                </button>
            </div>

            <div id="guests-container" class="mt-4"></div>

            <h5 class="mt-4">Firebase Query Used:</h5>
            <pre id="query-display"></pre>
        </div>

        <!-- Step 3: Verify limitToFirst() Usage -->
        <div class="test-section">
            <h3>Step 3: Verify Firebase Query</h3>
            <p>Status: <span id="step3-status" class="status-badge status-pending">Pending</span></p>
            <div id="step3-output"></div>
        </div>

        <!-- Test Results Summary -->
        <div class="test-section">
            <h3>Test Results Summary</h3>
            <ul id="test-results" class="list-group"></ul>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
        import { getDatabase, ref, set, get, query, orderByKey, limitToFirst, startAfter } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBR_WGwCXMl-FMF9B9c-5o3FBTAqLIMGtA",
            authDomain: "merakicaptiveportal-firebasedb.firebaseapp.com",
            databaseURL: "https://merakicaptiveportal-firebasedb-default-rtdb.firebaseio.com",
            projectId: "merakicaptiveportal-firebasedb",
            storageBucket: "merakicaptiveportal-firebasedb.appspot.com",
            messagingSenderId: "361706792096",
            appId: "1:361706792096:web:c5e83c0a3d5c3f3e0b5c0e"
        };

        const app = initializeApp(firebaseConfig);
        const rtdb = getDatabase(app);
        const auth = getAuth(app);

        let currentPage = 1;
        let pageSize = 10;
        let lastPageKey = null;
        let currentPageData = [];
        let paginationHistory = []; // Track keys for previous pages

        // Auto-login
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                console.log('üîê Auto-logging in...');
                try {
                    await signInWithEmailAndPassword(auth, 'testuser.free@sparks.test', 'Password123!');
                    console.log('‚úÖ Logged in successfully');
                } catch (error) {
                    console.error('‚ùå Login failed:', error);
                    alert('Auto-login failed. Please refresh the page.');
                }
            } else {
                console.log('‚úÖ User authenticated:', user.email);
            }
        });

        // Step 1: Create Test Guests
        document.getElementById('create-guests-btn').addEventListener('click', async () => {
            const btn = document.getElementById('create-guests-btn');
            const status = document.getElementById('step1-status');
            const output = document.getElementById('step1-output');

            btn.disabled = true;
            status.className = 'status-badge status-running';
            status.textContent = 'Running';
            output.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Creating guests...';

            try {
                const timestamp = Date.now();
                const results = [];

                // Create 25 test guests
                for (let i = 1; i <= 25; i++) {
                    const phoneNumber = `27${timestamp}${String(i).padStart(3, '0')}`;
                    const guestData = {
                        name: `Test Guest ${i}`,
                        phoneNumber: phoneNumber,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        consent: false,
                        tier: 'Bronze',
                        lastConsentPrompt: null
                    };

                    await set(ref(rtdb, `guests/${phoneNumber}`), guestData);
                    results.push(`‚úÖ Created: ${guestData.name} (${phoneNumber})`);

                    // Update progress
                    output.innerHTML = `<div>Created ${i} / 25 guests...</div>`;
                }

                output.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Success!</strong> Created 25 test guests.
                        <ul class="mt-2 mb-0">
                            ${results.slice(0, 5).map(r => `<li>${r}</li>`).join('')}
                            <li><em>... and ${results.length - 5} more</em></li>
                        </ul>
                    </div>
                `;
                status.className = 'status-badge status-passed';
                status.textContent = 'Passed';

                // Enable pagination controls
                document.getElementById('load-page-btn').disabled = false;
                addTestResult('Step 1: Create 25 Test Guests', true, 'Created 25 test guests successfully');
            } catch (error) {
                console.error('‚ùå Error creating guests:', error);
                output.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                status.className = 'status-badge status-failed';
                status.textContent = 'Failed';
                addTestResult('Step 1: Create 25 Test Guests', false, error.message);
            } finally {
                btn.disabled = false;
            }
        });

        // Load Page Function
        async function loadPage(page) {
            const status = document.getElementById('step2-status');
            const container = document.getElementById('guestsContainer');
            const queryDisplay = document.getElementById('query-display');

            status.className = 'status-badge status-running';
            status.textContent = 'Running';
            container.innerHTML = '<div class="spinner-border"></div> Loading...';

            try {
                pageSize = parseInt(document.getElementById('page-size').value);
                let guestsQuery;
                let queryDescription;

                if (page === 1) {
                    // First page
                    guestsQuery = query(ref(rtdb, 'guests'), orderByKey(), limitToFirst(pageSize));
                    queryDescription = `query(ref(rtdb, 'guests'), orderByKey(), limitToFirst(${pageSize}))`;
                    lastPageKey = null;
                    paginationHistory = [];
                } else {
                    // Subsequent pages - use the last key from previous page
                    const startKey = paginationHistory[page - 2];
                    guestsQuery = query(ref(rtdb, 'guests'), orderByKey(), startAfter(startKey), limitToFirst(pageSize));
                    queryDescription = `query(ref(rtdb, 'guests'), orderByKey(), startAfter('${startKey}'), limitToFirst(${pageSize}))`;
                }

                queryDisplay.textContent = queryDescription;
                console.log('üîç Firebase Query:', queryDescription);

                const snapshot = await get(guestsQuery);
                const guestsData = snapshot.val() || {};
                const guestKeys = Object.keys(guestsData);

                currentPageData = Object.entries(guestsData).map(([phone, data]) => ({
                    phoneNumber: phone,
                    ...data
                }));

                // Store last key for next page
                if (guestKeys.length > 0) {
                    lastPageKey = guestKeys[guestKeys.length - 1];
                    if (page === currentPage && !paginationHistory.includes(lastPageKey)) {
                        paginationHistory.push(lastPageKey);
                    }
                }

                // Display guests
                container.innerHTML = '';
                currentPageData.forEach((guest, index) => {
                    const card = document.createElement('div');
                    card.className = 'guest-card';
                    card.innerHTML = `
                        <strong>#${((page - 1) * pageSize) + index + 1}</strong>:
                        ${guest.name} - ${guest.phoneNumber}
                        <small class="text-muted">(Created: ${new Date(guest.createdAt).toLocaleString()})</small>
                    `;
                    container.appendChild(card);
                });

                // Update UI
                document.getElementById('current-page').value = page;
                currentPage = page;

                // Enable/disable navigation buttons
                document.getElementById('first-page-btn').disabled = (page === 1);
                document.getElementById('prev-page-btn').disabled = (page === 1);
                document.getElementById('next-page-btn').disabled = (currentPageData.length < pageSize);

                status.className = 'status-badge status-passed';
                status.textContent = 'Passed';

                addTestResult(
                    `Page ${page}: Load ${pageSize} guests`,
                    true,
                    `Loaded ${currentPageData.length} guests using limitToFirst(${pageSize})`
                );

                // Verify limitToFirst was used
                if (page === 1) {
                    verifyFirebaseQuery(queryDescription);
                }

            } catch (error) {
                console.error('‚ùå Error loading page:', error);
                container.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                status.className = 'status-badge status-failed';
                status.textContent = 'Failed';
                addTestResult(`Page ${page}: Load guests`, false, error.message);
            }
        }

        // Pagination button handlers
        document.getElementById('load-page-btn').addEventListener('click', () => loadPage(currentPage));
        document.getElementById('first-page-btn').addEventListener('click', () => loadPage(1));
        document.getElementById('prev-page-btn').addEventListener('click', () => loadPage(Math.max(1, currentPage - 1)));
        document.getElementById('next-page-btn').addEventListener('click', () => loadPage(currentPage + 1));

        // Verify Firebase Query
        function verifyFirebaseQuery(queryDescription) {
            const status = document.getElementById('step3-status');
            const output = document.getElementById('step3-output');

            const hasLimitToFirst = queryDescription.includes('limitToFirst');
            const hasOrderByKey = queryDescription.includes('orderByKey');

            const checks = [
                { name: 'Uses orderByKey()', passed: hasOrderByKey },
                { name: 'Uses limitToFirst()', passed: hasLimitToFirst },
                { name: 'Query limits data transfer', passed: hasLimitToFirst && hasOrderByKey }
            ];

            const allPassed = checks.every(check => check.passed);

            output.innerHTML = `
                <div class="alert ${allPassed ? 'alert-success' : 'alert-danger'}">
                    <h5>Firebase Query Verification:</h5>
                    <ul class="mb-0">
                        ${checks.map(check => `
                            <li>
                                <i class="fas ${check.passed ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'}"></i>
                                ${check.name}
                            </li>
                        `).join('')}
                    </ul>
                    <div class="mt-3">
                        <strong>Query Used:</strong><br>
                        <code>${queryDescription}</code>
                    </div>
                </div>
            `;

            status.className = `status-badge ${allPassed ? 'status-passed' : 'status-failed'}`;
            status.textContent = allPassed ? 'Passed' : 'Failed';

            addTestResult('Step 3: Verify Firebase Query', allPassed,
                allPassed ? 'Query uses limitToFirst() correctly' : 'Query does not use limitToFirst()');
        }

        // Helper function to add test results
        function addTestResult(name, passed, message) {
            const resultsList = document.getElementById('test-results');
            const li = document.createElement('li');
            li.className = `list-group-item ${passed ? 'list-group-item-success' : 'list-group-item-danger'}`;
            li.innerHTML = `
                <i class="fas ${passed ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                <strong>${name}</strong>: ${message}
            `;
            resultsList.appendChild(li);
        }

        // Get total guests count
        async function updateTotalCount() {
            try {
                const snapshot = await get(ref(rtdb, 'guests'));
                const total = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                document.getElementById('total-guests').value = total;
            } catch (error) {
                console.error('Error getting total count:', error);
            }
        }

        // Update count on page load
        setTimeout(updateTotalCount, 1000);
    </script>
</body>
</html>
