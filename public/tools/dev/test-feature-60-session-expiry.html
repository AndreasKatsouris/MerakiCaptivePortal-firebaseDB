<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature #60 Test - Session Expiry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header bg-warning">
                <h3><i class="fas fa-clock"></i> Feature #60: Session Expiry Test</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5>Test Steps:</h5>
                    <ol>
                        <li>Login as a user</li>
                        <li>Navigate to this protected page (simulated)</li>
                        <li>Click "Expire Session" to manually expire Firebase token</li>
                        <li>Verify redirect to login page</li>
                        <li>Verify message: "Session expired, please log in"</li>
                    </ol>
                </div>

                <div id="authStatus" class="alert">
                    <strong>Loading auth status...</strong>
                </div>

                <div id="testControls" class="mt-4" style="display: none;">
                    <h5>Test Controls</h5>
                    <button id="expireSessionBtn" class="btn btn-danger btn-lg">
                        <i class="fas fa-sign-out-alt"></i> Expire Session
                    </button>
                    <button id="checkTokenBtn" class="btn btn-secondary ms-2">
                        <i class="fas fa-key"></i> Check Token
                    </button>
                </div>

                <div class="mt-4">
                    <h5>Session Details</h5>
                    <pre id="sessionDetails" class="bg-light p-3 rounded"></pre>
                </div>

                <div class="mt-4">
                    <h5>Console Log</h5>
                    <pre id="testLog" class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { auth, onAuthStateChanged } from '../../js/config/firebase-config.js';
        import { initSessionExpiryHandler, expireSession } from '../../js/auth/session-expiry-handler.js';

        const log = (message, type = 'info') => {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[Feature60Test] ${message}`);
        };

        const updateSessionDetails = async (user) => {
            const details = {
                authenticated: !!user,
                uid: user?.uid || 'N/A',
                email: user?.email || 'N/A',
                tokenExists: false,
                tokenExpiry: 'N/A'
            };

            if (user) {
                try {
                    const token = await user.getIdToken(false);
                    details.tokenExists = !!token;

                    // Decode token to get expiry (this is just for display)
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    details.tokenExpiry = new Date(payload.exp * 1000).toLocaleString();
                } catch (error) {
                    log(`Error getting token: ${error.message}`, 'error');
                }
            }

            document.getElementById('sessionDetails').textContent = JSON.stringify(details, null, 2);
        };

        // Initialize
        log('Initializing Feature #60 test page...');

        // Monitor auth state
        onAuthStateChanged(auth, async (user) => {
            const authStatusElement = document.getElementById('authStatus');
            const testControlsElement = document.getElementById('testControls');

            if (user) {
                log(`User authenticated: ${user.email}`, 'success');
                authStatusElement.className = 'alert alert-success';
                authStatusElement.innerHTML = `<strong>✅ Authenticated:</strong> ${user.email}`;
                testControlsElement.style.display = 'block';

                await updateSessionDetails(user);
            } else {
                log('No user authenticated', 'error');
                authStatusElement.className = 'alert alert-danger';
                authStatusElement.innerHTML = '<strong>❌ Not Authenticated:</strong> Please login first';
                testControlsElement.style.display = 'none';

                await updateSessionDetails(null);
            }
        });

        // Initialize session expiry handler
        // Note: This page is not in the PROTECTED_PAGES list, so we'll manually trigger redirect for testing
        log('Session expiry handler initialized');

        // Setup test controls
        document.getElementById('expireSessionBtn').addEventListener('click', async () => {
            log('Manually expiring session...', 'info');
            try {
                await expireSession();
                log('Session expired successfully - should redirect to login', 'success');

                // Manually trigger redirect for testing (since this page is not in protected list)
                setTimeout(() => {
                    sessionStorage.setItem('sessionExpired', 'true');
                    sessionStorage.setItem('sessionExpiredMessage', 'Session expired, please log in');
                    window.location.href = '/user-login.html';
                }, 1000);
            } catch (error) {
                log(`Error expiring session: ${error.message}`, 'error');
            }
        });

        document.getElementById('checkTokenBtn').addEventListener('click', async () => {
            log('Checking token validity...', 'info');
            if (auth.currentUser) {
                try {
                    const token = await auth.currentUser.getIdToken(false);
                    log('Token is valid', 'success');
                    await updateSessionDetails(auth.currentUser);
                } catch (error) {
                    log(`Token check failed: ${error.message}`, 'error');
                }
            } else {
                log('No user to check token for', 'error');
            }
        });

        log('Test page ready');
    </script>
</body>
</html>
