<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tier Access Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .feature-test {
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .access-granted {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .access-denied {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .feature-icon {
            width: 40px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Tier Access Control Testing</h1>
        
        <!-- User Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Current User Status</h5>
            </div>
            <div class="card-body">
                <div id="userStatus">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    Loading user information...
                </div>
            </div>
        </div>

        <!-- Tier Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Test Different Tiers</h5>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="switchTier('free')">Free Tier</button>
                    <button class="btn btn-outline-primary" onclick="switchTier('professional')">Professional</button>
                    <button class="btn btn-outline-primary" onclick="switchTier('enterprise')">Enterprise</button>
                </div>
                <button class="btn btn-secondary ms-3" onclick="refreshStatus()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Feature Access Tests -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Feature Access Tests</h5>
            </div>
            <div class="card-body">
                <div id="featureTests">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    Loading features...
                </div>
            </div>
        </div>

        <!-- Module Tests -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Module Access Tests</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-primary mb-2 w-100" onclick="testFoodCostModule()">
                            <i class="fas fa-receipt"></i> Test Food Cost Module
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary mb-2 w-100" onclick="testAnalyticsModule()">
                            <i class="fas fa-chart-line"></i> Test Analytics Module
                        </button>
                    </div>
                </div>
                <div id="moduleTestResult" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        
        // Import feature access control with error handling
        let featureAccessControl, platformFeatures;
        try {
            const featureModule = await import('./js/modules/access-control/services/feature-access-control.js');
            featureAccessControl = featureModule.featureAccessControl;
            
            const platformModule = await import('./js/modules/access-control/services/platform-features.js');
            platformFeatures = platformModule.platformFeatures || platformModule.default;
        } catch (error) {
            console.error('Error importing modules:', error);
            document.getElementById('userStatus').innerHTML = '<div class="alert alert-danger">Error loading modules: ' + error.message + '</div>';
        }
        
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBJol6F-qAh6Pa_GZZqCSZWqgL91OJaL5s",
            authDomain: "merakicaptiveportal-firebasedb.firebaseapp.com",
            databaseURL: "https://merakicaptiveportal-firebasedb-default-rtdb.firebaseio.com",
            projectId: "merakicaptiveportal-firebasedb",
            storageBucket: "merakicaptiveportal-firebasedb.appspot.com",
            messagingSenderId: "543702556849",
            appId: "1:543702556849:web:b967bab2e7b964ec9ca78c"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        
        window.rtdb = database;
        
        // Current user
        let currentUser = null;
        
        // Define global functions early
        window.switchTier = async function(tierName) {
            if (!featureAccessControl) {
                Swal.fire('Error', 'Feature access control not loaded', 'error');
                return;
            }
            
            try {
                if (!currentUser) {
                    Swal.fire('Error', 'You must be logged in to switch tiers', 'error');
                    return;
                }
                
                // Get tier info
                const tiersSnapshot = await get(ref(database, 'tiers'));
                const tiers = tiersSnapshot.val() || {};
                const tierData = Object.values(tiers).find(t => t.name.toLowerCase() === tierName.toLowerCase());
                
                if (!tierData) {
                    Swal.fire('Error', `Tier "${tierName}" not found`, 'error');
                    return;
                }
                
                // Update user subscription
                await update(ref(database, `subscriptions/${currentUser.uid}`), {
                    tierName: tierData.name,
                    tierId: tierData.id,
                    status: 'active',
                    updatedAt: Date.now()
                });
                
                // Clear cache
                featureAccessControl.clearCache();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Tier Switched',
                    text: `You are now on the ${tierData.name} tier`,
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Refresh status
                await refreshStatus();
            } catch (error) {
                console.error('Error switching tier:', error);
                Swal.fire('Error', 'Failed to switch tier', 'error');
            }
        };
        
        // Refresh status
        window.refreshStatus = async function() {
            if (!featureAccessControl) {
                console.error('Feature access control not loaded');
                return;
            }
            
            featureAccessControl.clearCache();
            await loadUserStatus();
            await testFeatureAccess();
        };
        
        // Test Food Cost Module
        window.testFoodCostModule = async function() {
            if (!featureAccessControl) {
                Swal.fire('Error', 'Feature access control not loaded', 'error');
                return;
            }
            
            const hasAccess = await featureAccessControl.checkFeatureAccess('foodCostBasic');
            
            if (hasAccess) {
                document.getElementById('moduleTestResult').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Food Cost Module is accessible!
                        <hr>
                        <button class="btn btn-sm btn-success" onclick="window.open('admin-dashboard.html#foodCost', '_blank')">
                            Open Food Cost Module
                        </button>
                    </div>
                `;
            } else {
                await featureAccessControl.showUpgradePrompt('foodCostBasic');
                document.getElementById('moduleTestResult').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-lock"></i> Food Cost Module is locked for your current tier
                    </div>
                `;
            }
        };
        
        // Test Analytics Module
        window.testAnalyticsModule = async function() {
            if (!featureAccessControl) {
                Swal.fire('Error', 'Feature access control not loaded', 'error');
                return;
            }
            
            const hasAccess = await featureAccessControl.checkFeatureAccess('analyticsBasic');
            
            if (hasAccess) {
                document.getElementById('moduleTestResult').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Analytics Module is accessible!
                        <hr>
                        <button class="btn btn-sm btn-success" onclick="window.open('admin-dashboard.html#analytics', '_blank')">
                            Open Analytics Module
                        </button>
                    </div>
                `;
            } else {
                await featureAccessControl.showUpgradePrompt('analyticsBasic');
                document.getElementById('moduleTestResult').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-lock"></i> Analytics Module is locked for your current tier
                    </div>
                `;
            }
        };
        
        // Load user status
        async function loadUserStatus() {
            if (!featureAccessControl) {
                console.error('Feature access control not loaded');
                return;
            }
            
            try {
                const subscription = await featureAccessControl.getCurrentUserSubscription();
                const html = `
                    <div class="row">
                        <div class="col-md-6">
                            <strong>User ID:</strong> ${currentUser?.uid || 'Not logged in'}<br>
                            <strong>Email:</strong> ${currentUser?.email || 'N/A'}
                        </div>
                        <div class="col-md-6">
                            <strong>Current Tier:</strong> ${subscription?.tierName || 'None'}<br>
                            <strong>Status:</strong> <span class="badge bg-${subscription?.status === 'active' ? 'success' : 'secondary'}">${subscription?.status || 'No subscription'}</span>
                        </div>
                    </div>
                `;
                document.getElementById('userStatus').innerHTML = html;
            } catch (error) {
                console.error('Error loading user status:', error);
                document.getElementById('userStatus').innerHTML = '<div class="alert alert-danger">Error loading user status</div>';
            }
        }
        
        // Test feature access
        async function testFeatureAccess() {
            if (!featureAccessControl || !platformFeatures) {
                console.error('Feature access control or platform features not loaded');
                document.getElementById('featureTests').innerHTML = '<div class="alert alert-warning">Modules not loaded yet. Please refresh.</div>';
                return;
            }
            
            try {
                const features = platformFeatures.getAllFeatures();
                const testResults = [];
                
                for (const feature of features) {
                    const hasAccess = await featureAccessControl.checkFeatureAccess(feature.id);
                    testResults.push({
                        feature,
                        hasAccess
                    });
                }
                
                // Group by category
                const grouped = {};
                testResults.forEach(result => {
                    const category = result.feature.category;
                    if (!grouped[category]) {
                        grouped[category] = [];
                    }
                    grouped[category].push(result);
                });
                
                let html = '';
                for (const [category, results] of Object.entries(grouped)) {
                    html += `<h6 class="mt-3">${category}</h6>`;
                    results.forEach(({ feature, hasAccess }) => {
                        html += `
                            <div class="feature-test ${hasAccess ? 'access-granted' : 'access-denied'}">
                                <div class="d-flex align-items-center">
                                    <div class="feature-icon">
                                        <i class="${feature.icon}"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <strong>${feature.name}</strong><br>
                                        <small class="text-muted">${feature.description}</small>
                                    </div>
                                    <div>
                                        ${hasAccess ? 
                                            '<span class="badge bg-success">Accessible</span>' : 
                                            '<span class="badge bg-danger">Locked</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('featureTests').innerHTML = html;
            } catch (error) {
                console.error('Error testing feature access:', error);
                document.getElementById('featureTests').innerHTML = '<div class="alert alert-danger">Error testing features: ' + error.message + '</div>';
            }
        }
        
        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                // Check if modules are loaded
                if (!featureAccessControl || !platformFeatures) {
                    document.getElementById('userStatus').innerHTML = '<div class="alert alert-info">Loading modules... Please wait.</div>';
                    document.getElementById('featureTests').innerHTML = '<div class="alert alert-info">Loading modules... Please wait.</div>';
                    
                    // Retry after a short delay
                    setTimeout(() => {
                        if (featureAccessControl && platformFeatures) {
                            loadUserStatus();
                            testFeatureAccess();
                        }
                    }, 1000);
                } else {
                    await loadUserStatus();
                    await testFeatureAccess();
                }
            } else {
                // Show not logged in message with login button
                document.getElementById('userStatus').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Not logged in!</strong> 
                        <p>You need to be logged in to test tier access control.</p>
                                        <a href="../admin-login.html" class="btn btn-primary">Login as Admin</a>
                <a href="../user-login.html" class="btn btn-secondary">Login as User</a>
                    </div>
                `;
                document.getElementById('featureTests').innerHTML = `
                    <div class="alert alert-info">
                        Please log in to test feature access control.
                    </div>
                `;
                
                // Disable all buttons
                document.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                });
            }
        });
    </script>
</body>
</html>
