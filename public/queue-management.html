<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Management - Laki Sparks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="css/table-fixes.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Tab Navigation Styles */
        .nav-tabs-custom {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 30px;
        }

        .nav-tabs-custom .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            padding: 15px 25px;
            transition: all 0.3s ease;
        }

        .nav-tabs-custom .nav-link:hover {
            border-color: transparent;
            color: #667eea;
        }

        .nav-tabs-custom .nav-link.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: none;
        }

        .tab-pane {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Booking tab loading state */
        .booking-tab-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            flex-direction: column;
        }

        .booking-tab-loading .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            color: #667eea !important;
        }

        .main-container {
            margin-top: 80px;
            padding: 20px;
        }

        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .card-header {
            background-color: #667eea;
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }

        .alert-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .progress {
            height: 6px;
        }

        .btn-xs {
            padding: 0.125rem 0.5rem;
            font-size: 0.75rem;
        }

        .table-responsive {
            border-radius: 8px;
        }

        .badge {
            font-size: 0.75rem;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        .text-warning {
            color: #ffc107 !important;
        }

        .text-success {
            color: #28a745 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .locked:hover {
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="user-dashboard.html">
                <i class="fas fa-bolt me-2"></i>Laki Sparks
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="user-dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="user-subscription.html">Subscription</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="queue-management.html">Queue Management</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="analytics.html">Analytics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="campaigns.html">Campaigns</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                            data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> <span id="userDisplayName">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#profile"><i class="fas fa-user me-2"></i>Profile</a>
                            </li>
                            <li><a class="dropdown-item" href="#settings"><i class="fas fa-cog me-2"></i>Settings</a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn"><i
                                        class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-clock me-2"></i>Queue Management</h2>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="user-dashboard.html">Dashboard</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Queue Management</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs nav-tabs-custom" id="qmsTabsNav" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue-pane"
                        type="button" role="tab">
                        <i class="fas fa-clock me-2"></i>Queue Management
                    </button>
                </li>
                <li class="nav-item" role="presentation" id="booking-tab-container">
                    <button class="nav-link" id="booking-tab" data-bs-toggle="tab" data-bs-target="#booking-pane"
                        type="button" role="tab">
                        <i class="fas fa-calendar-alt me-2"></i>Booking Management
                        <i class="fas fa-lock ms-2 d-none" id="booking-lock-icon"></i>
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="qmsTabsContent">
                <!-- Queue Management Tab -->
                <div class="tab-pane fade show active" id="queue-pane" role="tabpanel">
                    <div id="queueManagementContent">
                        <!-- Vue Queue Management App will mount here -->
                    </div>
                </div>

                <!-- Booking Management Tab -->
                <div class="tab-pane fade" id="booking-pane" role="tabpanel">
                    <div id="bookingManagementContent">
                        <!-- Booking Management will be loaded here dynamically -->
                        <div class="booking-tab-loading">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted">Loading booking management...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>

    <!-- Firebase Scripts -->
    <script type="module">
        import { auth, onAuthStateChanged } from './js/config/firebase-config.js';
        import { initializeQueueManagement, cleanupQueueManagement } from './js/queue-management.js';
        import AccessControl from './js/modules/access-control/services/access-control-service.js';
        import { AdminClaims } from './js/auth/admin-claims.js';

        let bookingTabInitialized = false;
        let currentUser = null;

        // Authentication check
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // User is signed in, initialize queue management
                initializeQueueManagement();
                // Check booking access after authentication
                await checkBookingAccess();
            } else {
                // User is not signed in, redirect to login
                window.location.href = '/user-login.html?message=unauthorized';
            }
        });

        // Check booking management access
        async function checkBookingAccess() {
            try {
                // Check if user has booking management feature (subscription-based)
                const hasBookingFeature = await AccessControl.canUseFeature('bookingManagement');

                const bookingTab = document.getElementById('booking-tab');
                const bookingLockIcon = document.getElementById('booking-lock-icon');
                const bookingTabContainer = document.getElementById('booking-tab-container');

                if (hasBookingFeature) {
                    // User has booking feature - unlock tab
                    bookingTab.classList.remove('disabled');
                    bookingLockIcon.classList.add('d-none');
                    bookingTab.title = '';
                } else {
                    // No feature access - lock tab
                    bookingTab.classList.add('disabled');
                    bookingLockIcon.classList.remove('d-none');
                    bookingTab.title = 'Upgrade required for booking management';
                }
            } catch (error) {
                console.error('Error checking booking access:', error);
                // Default to locked state on error
                const bookingTab = document.getElementById('booking-tab');
                const bookingLockIcon = document.getElementById('booking-lock-icon');
                bookingTab.classList.add('disabled');
                bookingLockIcon.classList.remove('d-none');
            }
        }

        // Handle tab switching
        document.addEventListener('DOMContentLoaded', function () {
            const bookingTab = document.getElementById('booking-tab');
            const bookingPane = document.getElementById('booking-pane');

            // Handle booking tab click
            bookingTab.addEventListener('click', async function (e) {
                if (this.classList.contains('disabled')) {
                    e.preventDefault();
                    e.stopPropagation();
                    await showBookingAccessMessage();
                    return false;
                }

                // If not disabled and not initialized, load booking management
                if (!bookingTabInitialized && !this.classList.contains('disabled')) {
                    await initializeBookingTab();
                }
            });
        });

        // Show access message for booking management
        async function showBookingAccessMessage() {
            try {
                const hasBookingFeature = await AccessControl.canUseFeature('bookingManagement');
                const hasAdminAccess = currentUser ? await AdminClaims.verifyAdminStatus(currentUser) : false;

                let message, title, redirectUrl;

                if (!hasBookingFeature) {
                    title = 'Booking Management Locked';
                    message = 'Booking Management is available for Professional and Enterprise plans. Upgrade to manage restaurant bookings and reservations.';
                    redirectUrl = '/user-subscription.html?feature=bookingManagement';
                } else if (!hasAdminAccess) {
                    title = 'Admin Access Required';
                    message = 'Booking Management requires admin privileges. Please ensure you have admin access to manage bookings.';
                    redirectUrl = '/admin-login.html';
                }

                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: title,
                        text: message,
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: hasBookingFeature ? 'Admin Login' : 'Upgrade Plan',
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = redirectUrl;
                        }
                    });
                } else {
                    alert(message);
                }
            } catch (error) {
                console.error('Error showing booking access message:', error);
            }
        }

        // Initialize booking management tab
        async function initializeBookingTab() {
            if (bookingTabInitialized) return;

            try {
                const bookingContainer = document.getElementById('bookingManagementContent');
                bookingContainer.innerHTML = '<div class="booking-tab-loading"><div class="spinner-border text-primary mb-3"><span class="visually-hidden">Loading...</span></div><p class="text-muted">Initializing booking management...</p></div>';

                // Dynamically load booking management component
                const bookingModule = await import('./js/modules/booking-management.js');
                await bookingModule.initializeBookingManagement();

                bookingTabInitialized = true;
                console.log('Booking management tab initialized successfully');

            } catch (error) {
                console.error('Error initializing booking tab:', error);
                const bookingContainer = document.getElementById('bookingManagementContent');
                bookingContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Error Loading Booking Management</h5>
                        <p>Failed to load booking management: ${error.message}</p>
                        <button class="btn btn-outline-danger" onclick="location.reload()">
                            <i class="fas fa-refresh me-2"></i>Retry
                        </button>
                    </div>
                `;
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanupQueueManagement);

        // Handle logout
        document.getElementById('logoutBtn')?.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await auth.signOut();
                window.location.href = '/user-login.html?message=logout';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        });
    </script>
</body>

</html>