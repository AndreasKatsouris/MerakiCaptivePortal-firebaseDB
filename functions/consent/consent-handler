const admin = require('firebase-admin');
const { 
    rtdb, 
    ref, 
    get, 
    set, 
    update 
} = require('../config/firebase-admin');

/**
 * Normalize phone number format by removing + prefix and whatsapp: prefix
 * @param {string} phoneNumber - Phone number to normalize  
 * @returns {string} Normalized phone number with + prefix for international numbers
 */
function normalizePhoneNumber(phoneNumber) {
    if (!phoneNumber) return '';
    // Only remove WhatsApp prefix, preserve + for international numbers
    let cleaned = phoneNumber.replace(/^whatsapp:/, '').trim();
    
    // Ensure + prefix for international numbers (South African numbers)
    if (/^27\d{9}$/.test(cleaned)) {
        // If it's a 27xxxxxxxxx number without +, add it
        cleaned = '+' + cleaned;
    } else if (!cleaned.startsWith('+') && /^\d+$/.test(cleaned)) {
        // If it's all digits without +, assume it's South African
        cleaned = '+27' + cleaned.replace(/^0+/, ''); // Remove leading zeros
    }
    
    return cleaned;
}

/**
 * Check guest's consent status
 * @param {object} guestData - Guest data
 * @returns {Promise<object>} Consent status
 */
async function checkConsent(guestData) {
    console.log('[checkConsent] Input guest data:', JSON.stringify(guestData, null, 2));
    
    if (!guestData) return { requiresConsent: true, hasConsent: false };

    // If guest is in consent flow, continue that
    if (guestData.consentPending === true) {
        console.log('[checkConsent] Guest has consentPending=true, staying in flow');
        return {
            requiresConsent: true,
            inConsentFlow: true,
            hasConsent: false
        };
    }

    // Check existing consent
    const consent = guestData.consent || {};
    console.log('[checkConsent] Consent data:', JSON.stringify(consent, null, 2));
    
    const hasValidConsent = consent.status === 'accepted' && 
                          consent.version === '1.0' && 
                          consent.timestamp;
    console.log('[checkConsent] Has valid consent:', hasValidConsent);

    // Check consent age
    const consentAge = consent.timestamp ? Date.now() - consent.timestamp : Infinity;
    const requiresRenewal = consentAge > (365 * 24 * 60 * 60 * 1000);
    console.log('[checkConsent] Consent age (ms):', consentAge, 'Requires renewal:', requiresRenewal);

    const result = {
        requiresConsent: !hasValidConsent || requiresRenewal,
        hasConsent: hasValidConsent && !requiresRenewal,
        requiresRenewal,
        consentAge
    };
    
    console.log('[checkConsent] Final result:', JSON.stringify(result, null, 2));
    return result;
}

/**
 * Start or continue consent flow
 * @param {object} guestData - Guest data
 * @param {string} message - Incoming message
 * @returns {Promise<object>} Flow result
 */
async function handleConsentFlow(guestData, message) {
    const phoneNumber = normalizePhoneNumber(guestData.phoneNumber);

    // If no pending consent, start the flow
    if (!guestData.consentPending) {
        await update(ref(rtdb, `guests/${phoneNumber}`), {
            consentPending: true,
            lastConsentPrompt: Date.now()
        });

        return {
            success: true,
            shouldMessage: true,
            message: getConsentMessage()
        };
    }

    // Handle consent response
    return await processConsentResponse(guestData, message);
}

/**
 * Process guest's consent response
 * @param {object} guestData - Guest data
 * @param {string} message - Guest's response
 * @returns {Promise<object>} Processing result
 */
async function processConsentResponse(guestData, message) {
    const response = message.toLowerCase().trim();
    const phoneNumber = normalizePhoneNumber(guestData.phoneNumber);

    if (response.match(/^(yes|y|agree|accept|ok|okay)$/)) {
        console.log('Processing consent acceptance for:', phoneNumber);
        
        const consentData = {
            status: 'accepted',
            timestamp: Date.now(),
            version: '1.0',
            platform: 'whatsapp'
        };

        console.log('Consent data to save:', JSON.stringify(consentData, null, 2));
        
        // Use centralized database helpers for consistency
        const guestRef = ref(rtdb, `guests/${phoneNumber}`);
        
        try {
            console.log('Updating consent data...');
            await set(ref(rtdb, `guests/${phoneNumber}/consent`), consentData);
            console.log('✅ Consent data updated successfully');
            
            console.log('Clearing consent pending flag...');
            await set(ref(rtdb, `guests/${phoneNumber}/consentPending`), null);
            console.log('✅ Consent pending flag cleared successfully');
            
            // Verify the write immediately
            console.log('Verifying consent pending flag was cleared...');
            const verifySnapshot = await get(ref(rtdb, `guests/${phoneNumber}/consentPending`));
            const pendingValue = verifySnapshot.val();
            console.log('Verified consentPending value:', pendingValue);
            
            if (pendingValue !== null) {
                console.error('❌ WARNING: consentPending was not cleared! Attempting direct update...');
                // Try a batch update approach
                await update(ref(rtdb, `guests/${phoneNumber}`), {
                    consentPending: null
                });
                console.log('✅ Direct update completed');
                
                // Verify again
                const verifySnapshot2 = await get(ref(rtdb, `guests/${phoneNumber}/consentPending`));
                const pendingValue2 = verifySnapshot2.val();
                console.log('Second verification - consentPending value:', pendingValue2);
            }
            
            console.log('Saving to consent history...');
            await set(ref(rtdb, `consent-history/${phoneNumber}/${Date.now()}`), consentData);
            console.log('✅ Consent history saved successfully');
            
            console.log('Forcing database sync...');
            // Add a small delay to ensure writes complete before reads
            await new Promise(resolve => setTimeout(resolve, 100));
            
            console.log('All consent updates completed successfully');
            
            return {
                success: true,
                shouldMessage: true,
                message: 'Thank you! You can now earn rewards by sending photos of your receipts. Send "help" to see all available commands.',
                consentGranted: true
            };
        } catch (error) {
            console.error('Error updating consent data:', error);
            throw error;
        }

    } else if (response.match(/^(no|n|disagree|decline|reject)$/)) {
        console.log('Processing consent decline for:', phoneNumber);
        
        const consentData = {
            status: 'declined',
            timestamp: Date.now(),
            version: '1.0',
            platform: 'whatsapp'
        };
        
        try {
            console.log('Setting declined consent...');
            await set(ref(rtdb, `guests/${phoneNumber}/consent`), consentData);
            
            console.log('Clearing consent pending flag...');
            await set(ref(rtdb, `guests/${phoneNumber}/consentPending`), null);
            
            console.log('Forcing database sync...');
            // Add a small delay to ensure writes complete before reads
            await new Promise(resolve => setTimeout(resolve, 100));
            
            console.log('Consent decline completed successfully');
            
            return {
                success: true,
                shouldMessage: true,
                message: 'We understand. You can still use basic features, but reward functionality will be limited. You can enable rewards anytime by sending "consent".',
                consentGranted: false
            };
        } catch (error) {
            console.error('Error updating consent decline:', error);
            throw error;
        }

    } else {
        return {
            success: false,
            shouldMessage: true,
            message: 'Please reply with "yes" to accept or "no" to decline data collection for rewards functionality.'
        };
    }
}

/**
 * Check if a command requires consent
 * @param {string} command - Command to check
 * @returns {boolean} Whether command requires consent
 */
function requiresConsent(command) {
    if (!command) return false;
    
    const consentRequiredCommands = [
        'points',
        'rewards',
        'balance',
        'history',
        'profile'
    ];
    
    return consentRequiredCommands.some(cmd => 
        command.toLowerCase().includes(cmd)
    );
}

/**
 * Check if message is consent-related
 * @param {string} message - Message to check
 * @returns {boolean} Whether message is about consent
 */
function isConsentMessage(message) {
    if (!message) return false;
    
    const trimmed = message.toLowerCase().trim();
    
    // Only treat as consent message if it's a direct consent command or response
    const consentCommands = ['consent', 'privacy'];
    const consentResponses = ['yes', 'no', 'y', 'n', 'agree', 'accept', 'decline', 'reject'];
    
    // Check for direct consent commands
    if (consentCommands.includes(trimmed)) return true;
    
    // Only treat yes/no as consent if user is in consent flow
    // This prevents treating random "yes/no" as consent responses
    return false; // We'll handle consent responses in the consent flow logic
}

/**
 * Get consent request message
 * @returns {string} Formatted consent message
 */
function getConsentMessage() {
    return `Welcome to our rewards program! To provide you with the best experience, we need your consent to:

• Process your receipts for rewards
• Send you personalized offers
• Track your reward redemptions
• Analyze shopping patterns

Reply:
• YES - to accept and enable rewards
• NO - to decline (limited functionality)

You can change your preference anytime by sending "consent".
View our privacy policy: [privacy-url]`;
}

module.exports = {
    checkConsent,
    handleConsentFlow,
    processConsentResponse,
    requiresConsent,
    isConsentMessage,
    getConsentMessage
};